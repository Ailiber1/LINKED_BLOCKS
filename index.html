<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINKED BLOCKS_</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #00ff41;
            --neon-green-dim: #00aa2a;
            --neon-green-glow: rgba(0, 255, 65, 0.6);
            --neon-red: #ff0040;
            --neon-yellow: #ffff00;
            --neon-cyan: #00ffff;
            --neon-magenta: #ff00ff;
            --bg-dark: #0a0a0a;
            --bg-panel: rgba(0, 20, 0, 0.9);
            --border-color: #00ff41;
            --text-dim: #00aa2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg-dark);
            color: var(--neon-green);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Matrix Background */
        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.15;
        }

        .matrix-column {
            position: absolute;
            top: -100%;
            font-size: 14px;
            color: var(--neon-green);
            animation: matrix-fall linear infinite;
            white-space: nowrap;
        }

        @keyframes matrix-fall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(200vh); }
        }

        /* Scanline Effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.1) 2px,
                rgba(0, 0, 0, 0.1) 4px
            );
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Screens */
        .screen {
            display: none;
            width: 100%;
            max-width: 500px;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Intro Screen */
        .intro-text {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(18px, 4vw, 28px);
            text-align: center;
            color: var(--neon-green);
            text-shadow: 
                0 0 10px var(--neon-green-glow),
                0 0 20px var(--neon-green-glow),
                0 0 40px var(--neon-green-glow);
            animation: pulseGlow 2s ease-in-out infinite, introFade 3s ease forwards;
            cursor: pointer;
        }

        @keyframes pulseGlow {
            0%, 100% { text-shadow: 0 0 10px var(--neon-green-glow), 0 0 20px var(--neon-green-glow); }
            50% { text-shadow: 0 0 20px var(--neon-green-glow), 0 0 40px var(--neon-green-glow), 0 0 60px var(--neon-green-glow); }
        }

        @keyframes introFade {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Title */
        .title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(28px, 8vw, 48px);
            font-weight: 900;
            color: var(--neon-green);
            text-shadow: 
                0 0 10px var(--neon-green-glow),
                0 0 20px var(--neon-green-glow),
                0 0 40px var(--neon-green-glow);
            margin-bottom: 40px;
            letter-spacing: 2px;
        }

        /* Panel */
        .panel {
            background: var(--bg-panel);
            border: 2px solid var(--border-color);
            padding: 30px;
            width: 100%;
            position: relative;
            box-shadow: 
                0 0 10px var(--neon-green-glow),
                inset 0 0 30px rgba(0, 255, 65, 0.1);
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            pointer-events: none;
        }

        /* Corner decorations */
        .panel::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            width: 20px;
            height: 20px;
            border-top: 3px solid var(--neon-green);
            border-left: 3px solid var(--neon-green);
        }

        .corner-br {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-bottom: 3px solid var(--neon-green);
            border-right: 3px solid var(--neon-green);
        }

        /* Buttons */
        .btn {
            font-family: 'Share Tech Mono', monospace;
            background: transparent;
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin: 8px 0;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: rgba(0, 255, 65, 0.2);
            box-shadow: 
                0 0 15px var(--neon-green-glow),
                inset 0 0 15px rgba(0, 255, 65, 0.1);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
            background: rgba(0, 255, 65, 0.3);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            border-color: var(--text-dim);
            color: var(--text-dim);
            padding: 10px 20px;
            font-size: 14px;
        }

        .btn-secondary:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        /* Input */
        .input-group {
            margin: 15px 0;
            width: 100%;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-dim);
        }

        .input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-green-dim);
            color: var(--neon-green);
            padding: 12px 15px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 16px;
            outline: none;
            transition: all 0.2s ease;
        }

        .input:focus {
            border-color: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        .input::placeholder {
            color: var(--text-dim);
        }

        /* Divider */
        .divider {
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--neon-green), transparent);
            margin: 20px 0;
        }

        /* Select Options */
        .select-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .select-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--neon-green-dim);
            background: transparent;
            color: var(--neon-green-dim);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            font-family: 'Share Tech Mono', monospace;
        }

        .select-option:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .select-option.selected {
            background: rgba(0, 255, 65, 0.2);
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        /* Game Board */
        .game-header {
            width: 100%;
            max-width: 600px;
            margin-bottom: 15px;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-panel);
            border: 1px solid var(--neon-green);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .room-info {
            font-size: 12px;
            color: var(--text-dim);
        }

        .turn-indicator {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green-glow);
        }

        .timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            min-width: 60px;
            text-align: center;
        }

        .timer.warning {
            color: var(--neon-red);
            animation: timerBlink 0.5s ease infinite;
        }

        @keyframes timerBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Player indicators */
        .players-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .player-tag {
            padding: 8px 15px;
            border: 2px solid;
            font-size: 12px;
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .player-tag.active {
            opacity: 1;
            box-shadow: 0 0 15px currentColor;
        }

        .player-tag.p1 { border-color: var(--neon-magenta); color: var(--neon-magenta); }
        .player-tag.p2 { border-color: var(--neon-cyan); color: var(--neon-cyan); }
        .player-tag.p3 { border-color: var(--neon-yellow); color: var(--neon-yellow); }

        /* Board Container */
        .board-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .board-wrapper {
            position: relative;
            padding: 15px;
            background: var(--bg-panel);
            border: 3px solid var(--neon-green);
            box-shadow: 
                0 0 20px var(--neon-green-glow),
                inset 0 0 50px rgba(0, 255, 65, 0.1);
        }

        .board-wrapper::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            pointer-events: none;
        }

        .board {
            display: grid;
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
        }

        .cell {
            aspect-ratio: 1;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid rgba(0, 255, 65, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .cell:hover:not(.occupied) {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--neon-green);
        }

        .cell.valid-move {
            background: rgba(0, 255, 65, 0.05);
            border-color: rgba(0, 255, 65, 0.5);
        }

        .cell.valid-move:hover {
            background: rgba(0, 255, 65, 0.2);
        }

        .block {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            transition: all 0.2s ease;
            position: relative;
        }

        .block.p1 {
            background: radial-gradient(circle at 30% 30%, #ff66a3, var(--neon-magenta), #aa0040);
            box-shadow: 
                0 0 15px rgba(255, 0, 255, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .block.p2 {
            background: radial-gradient(circle at 30% 30%, #66ffff, var(--neon-cyan), #00aaaa);
            box-shadow: 
                0 0 15px rgba(0, 255, 255, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .block.p3 {
            background: radial-gradient(circle at 30% 30%, #ffff66, var(--neon-yellow), #aaaa00);
            box-shadow: 
                0 0 15px rgba(255, 255, 0, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .block.winning {
            animation: winPulse 0.5s ease infinite;
        }

        @keyframes winPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Win Line */
        .win-line {
            position: absolute;
            background: var(--neon-green);
            box-shadow: 
                0 0 10px var(--neon-green),
                0 0 20px var(--neon-green),
                0 0 40px var(--neon-green);
            z-index: 10;
            pointer-events: none;
            animation: lineGlow 0.5s ease infinite;
        }

        .win-line-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }

        .win-line-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .win-line-path {
            stroke: var(--neon-green);
            stroke-width: 6;
            stroke-linecap: round;
            fill: none;
            filter: drop-shadow(0 0 5px var(--neon-green)) 
                    drop-shadow(0 0 10px var(--neon-green)) 
                    drop-shadow(0 0 20px var(--neon-green));
            animation: lineGlowPath 0.8s ease infinite, lineDrawIn 0.5s ease forwards;
        }

        @keyframes lineGlowPath {
            0%, 100% { 
                stroke-width: 6;
                opacity: 1;
            }
            50% { 
                stroke-width: 8;
                opacity: 0.8;
            }
        }

        @keyframes lineDrawIn {
            0% {
                stroke-dasharray: 0, 1000;
            }
            100% {
                stroke-dasharray: 1000, 0;
            }
        }

        @keyframes lineGlow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Game Over Overlay */
        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }

        .game-over-overlay.active {
            display: flex;
        }

        .game-over-content {
            text-align: center;
            padding: 40px;
        }

        .game-set-text {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(36px, 10vw, 64px);
            font-weight: 900;
            color: var(--neon-green);
            text-shadow: 
                0 0 20px var(--neon-green-glow),
                0 0 40px var(--neon-green-glow),
                0 0 60px var(--neon-green-glow);
            margin-bottom: 20px;
            animation: pulseGlow 1s ease infinite;
        }

        .winner-text {
            font-family: 'Share Tech Mono', monospace;
            font-size: clamp(18px, 4vw, 24px);
            color: var(--neon-green);
            margin-bottom: 30px;
        }

        .game-over-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .game-over-buttons .btn {
            width: auto;
            min-width: 150px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-panel);
            border: 2px solid var(--neon-green);
            padding: 30px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px var(--neon-green-glow);
        }

        .modal-content.modal-small {
            max-width: 350px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            min-width: 120px;
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green-glow);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--neon-green);
            font-size: 24px;
            cursor: pointer;
        }

        /* Quit Button */
        .quit-btn {
            position: fixed;
            top: 20px;
            right: 70px;
            padding: 10px 15px;
            background: rgba(0, 10, 0, 0.8);
            border: 2px solid var(--neon-red);
            color: var(--neon-red);
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 100;
        }

        .quit-btn:hover {
            background: rgba(255, 0, 64, 0.2);
            box-shadow: 0 0 15px rgba(255, 0, 64, 0.5);
        }

        .rule-section {
            margin: 15px 0;
        }

        .rule-section h3 {
            color: var(--neon-green);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .rule-section p, .rule-section li {
            color: var(--text-dim);
            font-size: 13px;
            line-height: 1.6;
        }

        .rule-section ul {
            padding-left: 20px;
        }

        /* Ranking */
        .ranking-list {
            width: 100%;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }

        .ranking-item:nth-child(1) .rank { color: #ffd700; }
        .ranking-item:nth-child(2) .rank { color: #c0c0c0; }
        .ranking-item:nth-child(3) .rank { color: #cd7f32; }

        .rank {
            width: 40px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
        }

        .ranking-name {
            flex: 1;
        }

        .ranking-wins {
            color: var(--neon-green);
        }

        /* CPU Level */
        .cpu-levels {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .cpu-level {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--neon-green-dim);
            background: transparent;
            color: var(--neon-green-dim);
            cursor: pointer;
            text-align: center;
            font-family: 'Share Tech Mono', monospace;
            transition: all 0.2s ease;
        }

        .cpu-level:hover, .cpu-level.selected {
            border-color: var(--neon-green);
            color: var(--neon-green);
            background: rgba(0, 255, 65, 0.1);
        }

        .cpu-level.selected {
            box-shadow: 0 0 15px var(--neon-green-glow);
        }

        /* Settings */
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }

        .toggle {
            width: 50px;
            height: 26px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-green-dim);
            border-radius: 13px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .toggle.on {
            background: rgba(0, 255, 65, 0.3);
            border-color: var(--neon-green);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: var(--neon-green-dim);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .toggle.on::after {
            left: 26px;
            background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            border: 2px solid var(--neon-red);
            padding: 20px 40px;
            z-index: 300;
            display: none;
            animation: notifyPop 0.3s ease;
            box-shadow: 0 0 30px rgba(255, 0, 64, 0.5);
            text-align: center;
            white-space: pre-line;
            max-width: 90%;
        }

        .notification.active {
            display: block;
        }

        .notification.warning {
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .notification.info {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 30px var(--neon-green-glow);
        }

        .notification.success {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 30px var(--neon-green-glow);
        }

        @keyframes notifyPop {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .panel {
                padding: 20px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .game-info {
                flex-direction: column;
                gap: 5px;
                padding: 8px;
                font-size: 12px;
            }

            .game-header {
                padding-top: 10px;
            }

            .players-bar {
                flex-wrap: wrap;
                gap: 5px;
                justify-content: center;
            }

            .player-tag {
                padding: 6px 10px;
                font-size: 11px;
            }

            .game-over-buttons {
                flex-direction: column;
            }

            .game-over-buttons .btn {
                width: 100%;
            }

            /* „Çπ„Éû„Éõ„Åß„ÅØfixedÈÖçÁΩÆ„ÅÆ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åó„ÄÅ„Ç≤„Éº„É†ÂÜÖ„Å´ÈÖçÁΩÆ */
            .help-btn {
                display: none;
            }

            .quit-btn {
                display: none;
            }

            .audio-controls {
                display: none;
            }

            /* „Éú„Éº„ÉâË™øÊï¥ */
            .board-container {
                padding: 10px;
            }

            .cell {
                width: 38px;
                height: 38px;
            }

            /* „Çø„Ç§„Éà„É´ */
            .title {
                font-size: 28px;
            }

            /* „É¢„Éº„ÉÄ„É´ */
            .modal-content {
                padding: 20px;
                max-height: 70vh;
            }

            .modal-title {
                font-size: 18px;
            }

            .notification {
                padding: 15px 20px;
                font-size: 13px;
            }

            /* „Çπ„Éû„ÉõÁî®„Ç§„É≥„É©„Ç§„É≥„Ç≥„É≥„Éà„É≠„Éº„É´Ë°®Á§∫ */
            .mobile-controls {
                display: flex !important;
            }
        }

        /* „Åï„Çâ„Å´Â∞è„Åï„ÅÑÁîªÈù¢ */
        @media (max-width: 400px) {
            .title {
                font-size: 22px;
            }

            .cell {
                width: 32px;
                height: 32px;
            }
        }

        /* „Çπ„Éû„ÉõÁî®„Ç§„É≥„É©„Ç§„É≥„Ç≥„É≥„Éà„É≠„Éº„É´Ôºà„Éá„Éï„Ç©„É´„ÉàÈùûË°®Á§∫Ôºâ */
        .mobile-controls {
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 10px;
            background: rgba(0, 10, 0, 0.8);
            border: 1px solid var(--neon-green-dim);
        }

        .mobile-controls .left-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-controls .right-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-controls .mobile-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-panel);
            border: 1px solid var(--neon-green-dim);
            color: var(--neon-green-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
        }

        .mobile-controls .mobile-btn.on {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .mobile-controls .mobile-btn:not(.on)::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 18px;
            background: var(--neon-red);
            transform: rotate(45deg);
        }

        .mobile-controls .mobile-quit {
            padding: 5px 10px;
            background: transparent;
            border: 1px solid var(--neon-red);
            color: var(--neon-red);
            font-size: 11px;
            cursor: pointer;
        }

        .mobile-controls .mobile-help {
            width: 28px;
            height: 28px;
            background: var(--bg-panel);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-size: 14px;
            cursor: pointer;
        }

        .mobile-controls-title {
            margin-bottom: 15px;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }

            .player-tag {
                padding: 5px 8px;
                font-size: 10px;
            }

            .audio-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
        }

        /* Audio Control - Âè≥‰∏ä„Å´ÈÖçÁΩÆ */
        .audio-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 100;
        }

        .audio-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .audio-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-panel);
            border: 2px solid var(--neon-green-dim);
            color: var(--neon-green-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            position: relative;
        }

        .audio-btn:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }
        
        .audio-btn.on {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        .audio-btn:not(.on)::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 24px;
            background: var(--neon-red);
            transform: rotate(45deg);
            box-shadow: 0 0 5px var(--neon-red);
        }

        .audio-btn .label {
            display: none;
        }

        /* Volume Slider */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: rgba(0, 10, 0, 0.95);
            border: 1px solid var(--neon-green-dim);
        }

        .volume-control.hidden {
            display: none;
        }

        .volume-label {
            font-size: 9px;
            color: var(--neon-green);
        }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 60px;
            height: 6px;
            background: rgba(0, 255, 65, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--neon-green);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-green-glow);
            transition: all 0.2s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px var(--neon-green-glow);
        }

        .volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--neon-green);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        .volume-value {
            font-size: 9px;
            color: var(--neon-green);
            min-width: 28px;
            text-align: right;
        }

        /* „Çπ„Éû„ÉõÁî® */
        @media (max-width: 600px) {
            .audio-controls {
                top: 10px;
                left: 10px;
            }

            .audio-buttons {
                gap: 6px;
            }

            .audio-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .audio-btn:not(.on)::after {
                height: 18px;
            }

            .volume-control {
                padding: 3px 6px;
            }

            .volume-slider {
                width: 50px;
                height: 4px;
            }

            .volume-slider::-webkit-slider-thumb {
                width: 12px;
                height: 12px;
            }

            .volume-value {
                font-size: 8px;
                min-width: 24px;
            }
        }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 80px;
            height: 6px;
            background: rgba(0, 255, 65, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--neon-green);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-green-glow);
            transition: all 0.2s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px var(--neon-green-glow);
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--neon-green);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        .volume-value {
            font-size: 10px;
            color: var(--neon-green);
            min-width: 28px;
            text-align: right;
        }

        /* Help button - Âè≥‰∏ä */
        .help-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: var(--bg-panel);
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            cursor: pointer;
            z-index: 50;
        }

        .help-btn:hover {
            box-shadow: 0 0 15px var(--neon-green-glow);
        }
    </style>
</head>
<body>
    <!-- Matrix Background -->
    <div class="matrix-bg" id="matrixBg"></div>
    
    <!-- Scanlines -->
    <div class="scanlines"></div>

    <!-- Audio Controls -->
    <div class="audio-controls">
        <div class="volume-control" id="volumeControl">
            <input type="range" class="volume-slider" id="bgmVolume" min="0" max="100" value="30">
            <span class="volume-value" id="volumeValue">30%</span>
        </div>
        <div class="audio-buttons">
            <button class="audio-btn on" id="bgmBtn" title="BGM ON/OFF">
                ‚ô™
            </button>
            <button class="audio-btn on" id="seBtn" title="SE ON/OFF">
                üîä
            </button>
        </div>
    </div>

    <!-- Help Button -->
    <button class="help-btn" id="helpBtn">?</button>

    <!-- Main Container -->
    <div class="container">
        <!-- Intro Screen -->
        <div class="screen active" id="introScreen">
            <div class="intro-text" id="introText">„Éñ„É≠„ÉÉ„ÇØ„ÇíÂÖà„Å´ÊèÉ„Åà„Å¶ÂãùÂà©„Åõ„ÇàÔºÅ</div>
        </div>

        <!-- Title Screen -->
        <div class="screen" id="titleScreen">
            <h1 class="title">LINKED BLOCKS_</h1>
            
            <!-- „Çπ„Éû„ÉõÁî®„Ç≥„É≥„Éà„É≠„Éº„É´„Éê„ÉºÔºà„Çø„Ç§„Éà„É´ÁîªÈù¢Ôºâ -->
            <div class="mobile-controls mobile-controls-title" id="mobileControlsTitle">
                <div class="left-controls">
                    <button class="mobile-btn on" id="mobileBgmBtn2" title="BGM">‚ô™</button>
                    <button class="mobile-btn on" id="mobileSeBtn2" title="SE">üîä</button>
                </div>
                <div class="right-controls">
                    <button class="mobile-help" id="mobileHelpBtn2">?</button>
                </div>
            </div>
            
            <div class="panel">
                <div class="corner-br"></div>
                
                <div class="input-group">
                    <label class="input-label">USER NAME</label>
                    <input type="text" class="input" id="usernameInput" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ..." maxlength="12">
                </div>

                <button class="btn" id="registerPlayBtn">ÁôªÈå≤„Åó„Å¶„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã</button>
                <button class="btn btn-secondary" id="guestPlayBtn">ÁôªÈå≤„Åó„Å™„ÅÑ„Åß„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã</button>

                <div class="divider"></div>

                <button class="btn" id="soloPlayBtn">‰∏Ä‰∫∫„Åß„Éó„É¨„Ç§ÔºàCPUÂØæÊà¶Ôºâ</button>
                <button class="btn" id="localPlayBtn">„Éû„É´„ÉÅ„Éó„É¨„Ç§Ôºà2„Äú3‰∫∫Ôºâ</button>

                <div class="divider"></div>

                <button class="btn btn-secondary" id="rulesBtn">„É´„Éº„É´Ë™¨Êòé„ÇíË¶ã„Çã</button>
                <button class="btn btn-secondary" id="rankingBtn">„É©„É≥„Ç≠„É≥„Ç∞„ÇíË¶ã„Çã</button>
            </div>
        </div>

        <!-- Solo Setup Screen -->
        <div class="screen" id="soloSetupScreen">
            <h1 class="title">CPUÂØæÊà¶</h1>
            <div class="panel">
                <div class="corner-br"></div>
                
                <div class="input-group">
                    <label class="input-label">CPU„É¨„Éô„É´</label>
                    <div class="cpu-levels">
                        <button class="cpu-level" data-level="weak">Âº±</button>
                        <button class="cpu-level selected" data-level="normal">ÊôÆÈÄö</button>
                        <button class="cpu-level" data-level="strong">Âº∑</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">ÊèÉ„Åà„Çã„Éñ„É≠„ÉÉ„ÇØÊï∞</label>
                    <div class="select-group">
                        <button class="select-option selected" data-win="4">4</button>
                        <button class="select-option" data-win="5">5</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">„Çø„Ç§„Éû„ÉºÔºàÁßíÔºâ</label>
                    <div class="select-group">
                        <button class="select-option selected" data-timer="0">OFF</button>
                        <button class="select-option" data-timer="10">10</button>
                        <button class="select-option" data-timer="20">20</button>
                        <button class="select-option" data-timer="30">30</button>
                    </div>
                </div>

                <div class="divider"></div>

                <button class="btn" id="startSoloBtn">START</button>
                <button class="btn btn-secondary" id="backFromSoloBtn">Êàª„Çã</button>
            </div>
        </div>

        <!-- Local Multiplayer Setup Screen -->
        <div class="screen" id="localSetupScreen">
            <h1 class="title">„Éû„É´„ÉÅ„Éó„É¨„Ç§</h1>
            <div class="panel">
                <div class="corner-br"></div>
                
                <div class="input-group">
                    <label class="input-label">„Éó„É¨„Ç§„É§„ÉºÊï∞</label>
                    <div class="select-group">
                        <button class="select-option selected" data-players="2">2‰∫∫</button>
                        <button class="select-option" data-players="3">3‰∫∫</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">ÊèÉ„Åà„Çã„Éñ„É≠„ÉÉ„ÇØÊï∞</label>
                    <div class="select-group">
                        <button class="select-option selected" data-win="4">4</button>
                        <button class="select-option" data-win="5">5</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">„Çø„Ç§„Éû„ÉºÔºàÁßíÔºâ</label>
                    <div class="select-group">
                        <button class="select-option selected" data-timer="0">OFF</button>
                        <button class="select-option" data-timer="10">10</button>
                        <button class="select-option" data-timer="20">20</button>
                        <button class="select-option" data-timer="30">30</button>
                    </div>
                </div>

                <div class="divider"></div>

                <button class="btn" id="startLocalBtn">START</button>
                <button class="btn btn-secondary" id="backFromLocalBtn">Êàª„Çã</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="gameScreen">
            <div class="game-header">
                <div class="game-info">
                    <span class="room-info" id="roomInfo">WIN LENGTH: 4</span>
                    <span class="turn-indicator">TURN: <span id="currentTurn">P1</span></span>
                    <span class="timer" id="timerDisplay">--</span>
                </div>
                
                <!-- „Çπ„Éû„ÉõÁî®„Ç≥„É≥„Éà„É≠„Éº„É´„Éê„Éº -->
                <div class="mobile-controls" id="mobileControls">
                    <div class="left-controls">
                        <button class="mobile-btn on" id="mobileBgmBtn" title="BGM">‚ô™</button>
                        <button class="mobile-btn on" id="mobileSeBtn" title="SE">üîä</button>
                    </div>
                    <div class="right-controls">
                        <button class="mobile-quit" id="mobileQuitBtn">‚úï ‰∏≠Êñ≠</button>
                        <button class="mobile-help" id="mobileHelpBtn">?</button>
                    </div>
                </div>
                
                <div class="players-bar" id="playersBar"></div>
            </div>

            <div class="board-container">
                <div class="board-wrapper" id="boardWrapper">
                    <div class="board" id="gameBoard"></div>
                </div>
            </div>
            
            <button class="quit-btn" id="quitGameBtn">‚úï ‰∏≠Êñ≠</button>
        </div>
    </div>

    <!-- Quit Confirm Modal -->
    <div class="modal" id="quitConfirmModal">
        <div class="modal-content modal-small">
            <h2 class="modal-title">„Ç≤„Éº„É†„Çí‰∏≠Êñ≠„Åó„Åæ„Åô„ÅãÔºü</h2>
            <p style="text-align: center; margin-bottom: 20px; color: var(--neon-green-dim);">ÈÄ≤Ë°å‰∏≠„ÅÆ„Ç≤„Éº„É†„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì</p>
            <div class="modal-buttons">
                <button class="btn" id="confirmQuitBtn">‰∏≠Êñ≠„Åô„Çã</button>
                <button class="btn btn-secondary" id="cancelQuitBtn">Á∂ö„Åë„Çã</button>
            </div>
        </div>
    </div>

    <!-- Game Over Overlay -->
    <div class="game-over-overlay" id="gameOverOverlay">
        <div class="game-over-content">
            <div class="game-set-text">GAME SET!</div>
            <div class="winner-text" id="winnerText">WINNER: PLAYER 1</div>
            <div class="game-over-buttons">
                <button class="btn" id="rematchBtn">ÂÜçÊà¶</button>
                <button class="btn btn-secondary" id="returnTitleBtn">„Çø„Ç§„Éà„É´„Å∏</button>
            </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div class="modal" id="rulesModal">
        <div class="modal-content">
            <button class="modal-close" id="closeRulesBtn">√ó</button>
            <h2 class="modal-title">RULES</h2>
            
            <div class="rule-section">
                <h3>„ÄêÂãùÂà©Êù°‰ª∂„Äë</h3>
                <p>Á∏¶„ÉªÊ®™„ÉªÊñú„ÇÅ„Å´ÊåáÂÆöÊï∞Ôºà4„Åæ„Åü„ÅØ5Ôºâ„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíÈÄ£Á∂ö„Åß‰∏¶„Åπ„Çã</p>
            </div>

            <div class="rule-section">
                <h3>„ÄêÈÖçÁΩÆ„É´„Éº„É´„Äë</h3>
                <ul>
                    <li>ÂàùÊâã„ÅØÁõ§Èù¢ÊúÄ‰∏ãÊÆµÔºàÂú∞Èù¢Ôºâ„ÅÆ„ÅøÈÖçÁΩÆÂèØËÉΩ</li>
                    <li>2ÊâãÁõÆ‰ª•Èôç„ÅØÊó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å´Èö£Êé•ÔºàÊé•Âú∞Ôºâ„Åô„Çã‰ΩçÁΩÆ„ÅÆ„ÅøÈÖçÁΩÆÂèØËÉΩ</li>
                    <li>Á©∫‰∏≠ÈÖçÁΩÆ„ÉªÂº∑Âà∂ËêΩ‰∏ã„Å™„Åó</li>
                </ul>
            </div>

            <div class="rule-section">
                <h3>„Äê„Çø„Ç§„Éû„Éº„Äë</h3>
                <p>Ë®≠ÂÆöÊôÇÈñìÂÜÖ„Å´ÈÖçÁΩÆ„Åó„Å™„ÅÑ„Å®Ëá™Âãï„Åß„Çø„Éº„É≥„Åå„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åæ„Åô</p>
            </div>

            <div class="rule-section">
                <h3>„Äê„É©„É≥„Ç≠„É≥„Ç∞„Äë</h3>
                <ul>
                    <li>ÁôªÈå≤„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÂØæË±°</li>
                    <li>CPU„ÄåÂº∑„Äç„Å´ÂãùÂà©„ÅßÂãùÂà©Êï∞+1</li>
                    <li>„Éû„É´„ÉÅ„Éó„É¨„Ç§„ÅØÂÑ™ÂãùËÄÖ„ÅÆ„Åø+1</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Ranking Modal -->
    <div class="modal" id="rankingModal">
        <div class="modal-content">
            <button class="modal-close" id="closeRankingBtn">√ó</button>
            <h2 class="modal-title">RANKING</h2>
            <div class="ranking-list" id="rankingList"></div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // ==================== AUDIO SYSTEM ====================
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.bgmEnabled = true;
                this.seEnabled = true;
                this.bgmPlaying = false;
                this.bgmScheduler = null;
                this.bgmNodes = [];
                this.masterGain = null;
                this.bgmGain = null;
                this.initialized = false;
                this.bgmVolume = 0.3; // „Éá„Éï„Ç©„É´„Éà30%
            }

            init() {
                if (this.initialized) return;
                
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Master gain
                this.masterGain = this.audioContext.createGain();
                this.masterGain.connect(this.audioContext.destination);
                this.masterGain.gain.value = 1.0;
                
                // BGM gain
                this.bgmGain = this.audioContext.createGain();
                this.bgmGain.connect(this.masterGain);
                this.bgmGain.gain.value = this.bgmVolume * 0.5; // 0.5„ÅØÂÜÖÈÉ®Ë™øÊï¥‰øÇÊï∞
                
                this.initialized = true;
            }

            resume() {
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }

            // BGMÈü≥ÈáèË®≠ÂÆöÔºà0.0 ~ 1.0Ôºâ
            setBgmVolume(volume) {
                this.bgmVolume = Math.max(0, Math.min(1, volume));
                if (this.bgmGain) {
                    this.bgmGain.gain.value = this.bgmVolume * 0.5;
                }
                // Ë®≠ÂÆö„Çí‰øùÂ≠ò
                localStorage.setItem('linkedblocks_bgm_volume', this.bgmVolume);
            }

            getBgmVolume() {
                return this.bgmVolume;
            }

            playTone(frequency, duration, type = 'square', volume = 0.1) {
                if (!this.seEnabled) return;
                this.init();
                this.resume();
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                // SEÈü≥Èáè„ÇíÂ§ß„Åç„ÇÅ„Å´Ë®≠ÂÆöÔºàBGM„Å´Ë≤†„Åë„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
                const seVolume = volume * 2.5;
                gainNode.gain.setValueAtTime(seVolume, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playHover() {
                this.playTone(800, 0.05, 'sine', 0.05);
            }

            playClick() {
                this.playTone(600, 0.1, 'square', 0.1);
                setTimeout(() => this.playTone(900, 0.05, 'square', 0.08), 50);
            }

            playPlace() {
                this.playTone(400, 0.15, 'triangle', 0.12);
            }

            playTurnChange() {
                this.playTone(523, 0.1, 'sine', 0.1);
                setTimeout(() => this.playTone(659, 0.1, 'sine', 0.1), 100);
            }

            playWarning() {
                this.playTone(200, 0.2, 'sawtooth', 0.12);
            }

            playTimerBeep() {
                this.playTone(880, 0.1, 'square', 0.15);
            }

            playMatchReady() {
                if (!this.seEnabled) return;
                this.init();
                this.resume();
                
                const notes = [392, 523, 659, 784];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.2, 'sine', 0.08), i * 100);
                });
            }

            playWin() {
                if (!this.seEnabled) return;
                this.init();
                this.resume();
                
                const notes = [523, 659, 784, 1047];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.3, 'sine', 0.1), i * 150);
                });
            }

            playError() {
                this.playTone(150, 0.3, 'sawtooth', 0.08);
            }

            // Tetris-style BGM using Korobeiniki melody
            startBGM() {
                if (!this.bgmEnabled || this.bgmPlaying) return;
                
                this.init();
                this.resume();
                this.bgmPlaying = true;

                // Korobeiniki (Tetris Theme) melody - notes with duration
                // Format: [frequency, duration in beats]
                const melody = [
                    // Part A
                    [659, 1], [494, 0.5], [523, 0.5], [587, 1], [523, 0.5], [494, 0.5],
                    [440, 1], [440, 0.5], [523, 0.5], [659, 1], [587, 0.5], [523, 0.5],
                    [494, 1.5], [523, 0.5], [587, 1], [659, 1],
                    [523, 1], [440, 1], [440, 1], [0, 1],
                    // Part B
                    [0, 0.5], [587, 1], [698, 0.5], [880, 1], [784, 0.5], [698, 0.5],
                    [659, 1.5], [523, 0.5], [659, 1], [587, 0.5], [523, 0.5],
                    [494, 1], [494, 0.5], [523, 0.5], [587, 1], [659, 1],
                    [523, 1], [440, 1], [440, 1], [0, 1]
                ];

                // Bass line
                const bassLine = [
                    [165, 2], [131, 2], [147, 2], [131, 2],
                    [165, 2], [131, 2], [147, 2], [131, 2],
                    [165, 2], [131, 2], [147, 2], [131, 2],
                    [165, 2], [131, 2], [147, 2], [131, 2]
                ];

                const bpm = 140;
                const beatDuration = 60 / bpm;
                
                let melodyTime = 0;
                melody.forEach(note => { melodyTime += note[1]; });
                const loopDuration = melodyTime * beatDuration;

                const scheduleLoop = () => {
                    if (!this.bgmEnabled || !this.bgmPlaying) return;
                    
                    const now = this.audioContext.currentTime;
                    
                    // Schedule melody
                    let currentTime = 0;
                    melody.forEach(([freq, beats]) => {
                        if (freq > 0) {
                            this.scheduleBGMNote(freq, now + currentTime * beatDuration, beats * beatDuration * 0.9, 'square', 0.4);
                        }
                        currentTime += beats;
                    });

                    // Schedule bass
                    let bassTime = 0;
                    const totalBassTime = bassLine.reduce((sum, n) => sum + n[1], 0) * beatDuration;
                    const bassLoops = Math.ceil(loopDuration / totalBassTime);
                    
                    for (let loop = 0; loop < bassLoops && bassTime * beatDuration < loopDuration; loop++) {
                        bassLine.forEach(([freq, beats]) => {
                            if (bassTime * beatDuration < loopDuration) {
                                this.scheduleBGMNote(freq, now + bassTime * beatDuration, beats * beatDuration * 0.8, 'triangle', 0.3);
                            }
                            bassTime += beats;
                        });
                    }

                    // Schedule next loop
                    this.bgmScheduler = setTimeout(() => scheduleLoop(), (loopDuration - 0.1) * 1000);
                };

                scheduleLoop();
            }

            scheduleBGMNote(freq, startTime, duration, type, volume) {
                if (!this.bgmGain) return;
                
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(this.bgmGain);
                
                osc.frequency.value = freq;
                osc.type = type;
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(volume, startTime + 0.01);
                gain.gain.setValueAtTime(volume, startTime + duration - 0.02);
                gain.gain.linearRampToValueAtTime(0, startTime + duration);
                
                osc.start(startTime);
                osc.stop(startTime + duration);
                
                this.bgmNodes.push({ osc, gain });
                
                // Cleanup old nodes
                setTimeout(() => {
                    const index = this.bgmNodes.findIndex(n => n.osc === osc);
                    if (index > -1) this.bgmNodes.splice(index, 1);
                }, (startTime - this.audioContext.currentTime + duration + 0.5) * 1000);
            }

            stopBGM() {
                this.bgmPlaying = false;
                
                if (this.bgmScheduler) {
                    clearTimeout(this.bgmScheduler);
                    this.bgmScheduler = null;
                }
                
                // Stop all BGM nodes
                this.bgmNodes.forEach(({ osc, gain }) => {
                    try {
                        gain.gain.cancelScheduledValues(this.audioContext.currentTime);
                        gain.gain.setValueAtTime(0, this.audioContext.currentTime);
                        osc.stop(this.audioContext.currentTime + 0.05);
                    } catch (e) {}
                });
                this.bgmNodes = [];
            }

            toggleBGM() {
                this.bgmEnabled = !this.bgmEnabled;
                
                if (this.bgmEnabled) {
                    this.startBGM();
                } else {
                    this.stopBGM();
                }
                
                // Save preference
                localStorage.setItem('linkedblocks_bgm', this.bgmEnabled);
                
                return this.bgmEnabled;
            }

            toggleSE() {
                this.seEnabled = !this.seEnabled;
                
                // Save preference
                localStorage.setItem('linkedblocks_se', this.seEnabled);
                
                return this.seEnabled;
            }

            loadPreferences() {
                const bgmPref = localStorage.getItem('linkedblocks_bgm');
                const sePref = localStorage.getItem('linkedblocks_se');
                const volumePref = localStorage.getItem('linkedblocks_bgm_volume');
                
                if (bgmPref !== null) this.bgmEnabled = bgmPref === 'true';
                if (sePref !== null) this.seEnabled = sePref === 'true';
                if (volumePref !== null) this.bgmVolume = parseFloat(volumePref);
                
                return { bgm: this.bgmEnabled, se: this.seEnabled, volume: this.bgmVolume };
            }
        }

        const audio = new AudioManager();

        // ==================== GAME STATE ====================
        const GameState = {
            // User data
            username: null,
            isRegistered: false,
            deviceId: null,
            
            // Game settings
            gameMode: null, // 'solo', 'local'
            cpuLevel: 'normal',
            winLength: 4,
            timerSetting: 0,
            playerCount: 2,
            
            // Board state
            boardSize: 7,
            board: [],
            currentPlayer: 0,
            players: [],
            gameActive: false,
            
            // Timer
            timeLeft: 0,
            timerInterval: null,
            
            // Rankings (localStorage)
            rankings: []
        };

        // ==================== DEVICE IDENTIFICATION ====================
        /**
         * „Éá„Éê„Ç§„ÇπË≠òÂà•„Ç∑„Çπ„ÉÜ„É†
         * - „Éá„Éê„Ç§„Çπ„Åî„Å®„Å´‰∏ÄÊÑè„ÅÆUUID„ÇíÁîüÊàê„Éª‰øùÂ≠ò
         * - „É¶„Éº„Ç∂„ÉºÂêç„Å®„Éá„Éê„Ç§„ÇπID„ÇíÁ¥ê‰ªò„Åë„Å¶ÁÆ°ÁêÜ
         * - „Çµ„Éº„Éê„Éº„Å™„Åó„ÅÆ„É≠„Éº„Ç´„É´Ë™çË®º
         */
        const DeviceAuth = {
            // „Éá„Éê„Ç§„ÇπID„ÇíÂèñÂæó„Åæ„Åü„ÅØÁîüÊàê
            getDeviceId() {
                let deviceId = localStorage.getItem('linkedblocks_device_id');
                if (!deviceId) {
                    deviceId = this.generateUUID();
                    localStorage.setItem('linkedblocks_device_id', deviceId);
                }
                return deviceId;
            },
            
            // UUIDÁîüÊàê
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },
            
            // „É¶„Éº„Ç∂„ÉºÁôªÈå≤Ôºà„Éá„Éê„Ç§„ÇπID„Å®Á¥ê‰ªò„ÅëÔºâ
            registerUser(username) {
                const deviceId = this.getDeviceId();
                const users = this.getUsers();
                
                // Âêå‰∏Ä„Éá„Éê„Ç§„ÇπÂÜÖ„ÅßÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                if (users.some(u => u.username === username)) {
                    return { success: false, error: '„Åì„ÅÆ„Éç„Éº„É†„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô' };
                }
                
                // Êñ∞Ë¶èÁôªÈå≤
                users.push({
                    username: username,
                    deviceId: deviceId,
                    createdAt: Date.now()
                });
                
                localStorage.setItem('linkedblocks_users', JSON.stringify(users));
                
                // ÁèæÂú®„ÅÆ„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„Å®„Åó„Å¶‰øùÂ≠ò
                localStorage.setItem('linkedblocks_current_user', username);
                
                return { success: true, deviceId: deviceId };
            },
            
            // ÁôªÈå≤Ê∏à„Åø„É¶„Éº„Ç∂„Éº„Åß„É≠„Ç∞„Ç§„É≥
            loginUser(username) {
                const deviceId = this.getDeviceId();
                const users = this.getUsers();
                
                const user = users.find(u => u.username === username && u.deviceId === deviceId);
                if (user) {
                    localStorage.setItem('linkedblocks_current_user', username);
                    return { success: true };
                }
                
                return { success: false, error: '„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' };
            },
            
            // ÂâçÂõû„ÅÆ„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó
            getLastUser() {
                return localStorage.getItem('linkedblocks_current_user');
            },
            
            // ÁôªÈå≤„É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„ÇíÂèñÂæó
            getUsers() {
                const saved = localStorage.getItem('linkedblocks_users');
                return saved ? JSON.parse(saved) : [];
            },
            
            // „Åì„ÅÆ„Éá„Éê„Ç§„Çπ„ÅÆÁôªÈå≤„É¶„Éº„Ç∂„Éº‰∏ÄË¶ß
            getDeviceUsers() {
                const deviceId = this.getDeviceId();
                return this.getUsers().filter(u => u.deviceId === deviceId);
            },
            
            // „É¶„Éº„Ç∂„Éº„ÅåÁôªÈå≤Ê∏à„Åø„ÅãÁ¢∫Ë™ç
            isRegistered(username) {
                const deviceId = this.getDeviceId();
                return this.getUsers().some(u => u.username === username && u.deviceId === deviceId);
            }
        };

        // ==================== SYNC LAYER (ABSTRACTION) ====================
        /**
         * ÂêåÊúüÂ±§„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ
         * ÁèæÂú®„ÅØ„É≠„Éº„Ç´„É´ÂÆüË£ÖÔºàÂçò‰∏ÄÁ´ØÊú´Ôºâ
         * Â∞ÜÊù•WebSocketÂÆüË£Ö„Å´Â∑Æ„ÅóÊõø„ÅàÂèØËÉΩ
         * 
         * ÂÆüË£ÖÊôÇ„Å´Â∑Æ„ÅóÊõø„Åà„Çã„É°„ÇΩ„ÉÉ„Éâ:
         * - SyncLayer.connect(roomId) - „É´„Éº„É†„Å´Êé•Á∂ö
         * - SyncLayer.disconnect() - ÂàáÊñ≠
         * - SyncLayer.sendMove(x, y) - Êâã„ÇíÈÄÅ‰ø°
         * - SyncLayer.onMove(callback) - Áõ∏Êâã„ÅÆÊâã„ÇíÂèó‰ø°
         * - SyncLayer.onPlayerJoin(callback) - „Éó„É¨„Ç§„É§„ÉºÂèÇÂä†ÈÄöÁü•
         * - SyncLayer.onPlayerLeave(callback) - „Éó„É¨„Ç§„É§„ÉºÈÄÄÂ∏≠ÈÄöÁü•
         */
        const SyncLayer = {
            // ÁèæÂú®„ÅÆÂÆüË£Ö: „É≠„Éº„Ç´„É´„ÅÆ„ÅøÔºàÂêå‰∏ÄÁ´ØÊú´‰∫§‰ª£„Éó„É¨„Ç§Ôºâ
            isOnline: false,
            
            connect(roomId) {
                // WebSocketÂÆüË£ÖÊôÇ: ws.connect(roomId)
                console.log('[SyncLayer] Local mode - no connection needed');
                return Promise.resolve();
            },
            
            disconnect() {
                // WebSocketÂÆüË£ÖÊôÇ: ws.close()
                console.log('[SyncLayer] Local mode - no disconnection needed');
            },
            
            sendMove(x, y, player) {
                // WebSocketÂÆüË£ÖÊôÇ: ws.send({ type: 'move', x, y, player })
                // „É≠„Éº„Ç´„É´„Åß„ÅØÁõ¥Êé•Âá¶ÁêÜÔºàplaceBlock„ÅåÂëº„Å∞„Çå„ÇãÔºâ
            },
            
            onMove(callback) {
                // WebSocketÂÆüË£ÖÊôÇ: ws.on('move', callback)
                // „É≠„Éº„Ç´„É´„Åß„ÅØ‰∏çË¶Å
            },
            
            onPlayerJoin(callback) {
                // WebSocketÂÆüË£ÖÊôÇ: ws.on('player_join', callback)
            },
            
            onPlayerLeave(callback) {
                // WebSocketÂÆüË£ÖÊôÇ: ws.on('player_leave', callback)
            }
        };

        // ==================== UTILITY FUNCTIONS ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type = 'warning') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = 'notification active ' + type;
            audio.playError();
            
            setTimeout(() => {
                notif.classList.remove('active');
            }, 2000);
        }

        function loadRankings() {
            const saved = localStorage.getItem('linkedblocks_rankings');
            GameState.rankings = saved ? JSON.parse(saved) : [];
        }

        function saveRankings() {
            localStorage.setItem('linkedblocks_rankings', JSON.stringify(GameState.rankings));
        }

        function addWin(username) {
            if (!username || !GameState.isRegistered) return;
            
            const existing = GameState.rankings.find(r => r.name === username);
            if (existing) {
                existing.wins++;
            } else {
                GameState.rankings.push({ name: username, wins: 1 });
            }
            
            GameState.rankings.sort((a, b) => b.wins - a.wins);
            GameState.rankings = GameState.rankings.slice(0, 123);
            saveRankings();
        }

        function renderRankings() {
            const list = document.getElementById('rankingList');
            list.innerHTML = '';
            
            const top10 = GameState.rankings.slice(0, 10);
            
            if (top10.length === 0) {
                list.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 20px;">„Åæ„Å†„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            top10.forEach((entry, i) => {
                const item = document.createElement('div');
                item.className = 'ranking-item';
                item.innerHTML = `
                    <span class="rank">#${i + 1}</span>
                    <span class="ranking-name">${entry.name}</span>
                    <span class="ranking-wins">${entry.wins} WIN</span>
                `;
                list.appendChild(item);
            });
        }

        // ==================== MATRIX BACKGROUND ====================
        function createMatrixBackground() {
            const container = document.getElementById('matrixBg');
            const chars = 'LINKEDBLOCKS01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥';
            const columns = Math.floor(window.innerWidth / 20);
            
            for (let i = 0; i < columns; i++) {
                const column = document.createElement('div');
                column.className = 'matrix-column';
                column.style.left = (i * 20) + 'px';
                column.style.animationDuration = (Math.random() * 10 + 10) + 's';
                column.style.animationDelay = (Math.random() * 10) + 's';
                
                let text = '';
                for (let j = 0; j < 30; j++) {
                    text += chars[Math.floor(Math.random() * chars.length)] + '<br>';
                }
                column.innerHTML = text;
                container.appendChild(column);
            }
        }

        // ==================== INTRO SCREEN ====================
        function handleIntro() {
            const introScreen = document.getElementById('introScreen');
            const introText = document.getElementById('introText');
            
            const skipIntro = () => {
                if (!introScreen.classList.contains('active')) return;
                
                audio.init();
                audio.resume();
                audio.playMatchReady();
                
                showScreen('titleScreen');
                
                // Start BGM after a short delay
                setTimeout(() => {
                    if (audio.bgmEnabled) {
                        audio.startBGM();
                    }
                }, 500);
            };
            
            introText.addEventListener('click', skipIntro);
            introText.addEventListener('touchstart', skipIntro);
            
            setTimeout(() => {
                if (introScreen.classList.contains('active')) {
                    skipIntro();
                }
            }, 3000);
        }

        // ==================== GAME BOARD ====================
        function initBoard() {
            GameState.board = [];
            for (let y = 0; y < GameState.boardSize; y++) {
                GameState.board.push(new Array(GameState.boardSize).fill(null));
            }
        }

        function renderBoard() {
            const boardEl = document.getElementById('gameBoard');
            boardEl.innerHTML = '';
            boardEl.style.gridTemplateColumns = `repeat(${GameState.boardSize}, 1fr)`;
            
            const cellSize = Math.min(60, (window.innerWidth - 100) / GameState.boardSize);
            
            // ÂêàÊ≥ïÊâã„É™„Çπ„Éà„ÇíÂèñÂæóÔºàcanPlaceAt„ÅßÂà§ÂÆöÔºâ
            const validMoves = GameState.gameActive ? getAllValidMoves() : [];
            const validMovesSet = new Set(validMoves.map(m => `${m.x},${m.y}`));
            
            for (let y = 0; y < GameState.boardSize; y++) {
                for (let x = 0; x < GameState.boardSize; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.width = cellSize + 'px';
                    cell.style.height = cellSize + 'px';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    if (GameState.board[y][x] !== null) {
                        cell.classList.add('occupied');
                        const block = document.createElement('div');
                        block.className = `block p${GameState.board[y][x] + 1}`;
                        cell.appendChild(block);
                    } else if (validMovesSet.has(`${x},${y}`)) {
                        cell.classList.add('valid-move');
                    }
                    
                    cell.addEventListener('click', () => handleCellClick(x, y));
                    cell.addEventListener('mouseenter', () => {
                        if (validMovesSet.has(`${x},${y}`)) {
                            audio.playHover();
                        }
                    });
                    
                    boardEl.appendChild(cell);
                }
            }
        }

        /**
         * ‰∏ä‰∏ãÂ∑¶Âè≥„Å´Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÈö£Êé•Êù°‰ª∂Ôºâ
         */
        function hasOrthogonalNeighborBlock(x, y) {
            // ‰∏ä
            if (y > 0 && GameState.board[y - 1][x] !== null) {
                return true;
            }
            // ‰∏ã
            if (y + 1 < GameState.boardSize && GameState.board[y + 1][x] !== null) {
                return true;
            }
            // Â∑¶
            if (x > 0 && GameState.board[y][x - 1] !== null) {
                return true;
            }
            // Âè≥
            if (x + 1 < GameState.boardSize && GameState.board[y][x + 1] !== null) {
                return true;
            }
            return false;
        }

        /**
         * ÊîØÊåÅÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØÔºàÊµÆÈÅäÁ¶ÅÊ≠¢Ôºâ
         * - ÊúÄ‰∏ãÊÆµ„Å™„ÇâOKÔºàÂú∞Èù¢„Å´ÊîØ„Åà„Çâ„Çå„Å¶„ÅÑ„ÇãÔºâ
         * - ÊúÄ‰∏ãÊÆµ‰ª•Â§ñ„ÅØ„ÄÅÁõ¥‰∏ã(x, y+1)„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøOK
         */
        function hasSupport(x, y) {
            const bottomY = GameState.boardSize - 1;
            
            // ÊúÄ‰∏ãÊÆµ„Å™„ÇâÂú∞Èù¢„Å´ÊîØ„Åà„Çâ„Çå„Å¶„ÅÑ„Çã
            if (y === bottomY) {
                return true;
            }
            
            // ÊúÄ‰∏ãÊÆµ‰ª•Â§ñÔºöÁõ¥‰∏ã„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çã„Åã
            return GameState.board[y + 1][x] !== null;
        }

        /**
         * ÈÖçÁΩÆÂèØÂê¶Âà§ÂÆöÔºàÂîØ‰∏Ä„ÅÆÂà§ÂÆöÈñ¢Êï∞Ôºâ
         * 
         * „Äê1ÊâãÁõÆ„ÄëÁõ§Èù¢„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå0ÂÄã
         *   - ÊúÄ‰∏ãÊÆµ„ÅÆÁ©∫„Çª„É´„ÅÆ„ÅøÈÖçÁΩÆÂèØËÉΩ
         * 
         * „Äê2ÊâãÁõÆ‰ª•Èôç„Äë
         *   ÈÖçÁΩÆÂèØËÉΩ = ‰ª•‰∏ã„ÇíÂÖ®„Å¶Ê∫Ä„Åü„Åô
         *   1) ÂØæË±°„Çª„É´„ÅåÁ©∫
         *   2) Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å´‰∏ä‰∏ãÂ∑¶Âè≥„ÅÆ„ÅÑ„Åö„Çå„Åã„ÅßÈö£Êé•
         *   3) ÊîØÊåÅÊù°‰ª∂„ÇíÊ∫Ä„Åü„ÅôÔºàÊúÄ‰∏ãÊÆµ OR Áõ¥‰∏ã„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„ÇãÔºâ
         */
        function canPlaceAt(x, y) {
            // ÁØÑÂõ≤Â§ñ„ÉÅ„Çß„ÉÉ„ÇØ
            if (x < 0 || x >= GameState.boardSize || y < 0 || y >= GameState.boardSize) {
                return false;
            }
            
            // Êù°‰ª∂1: ÂØæË±°„Çª„É´„ÅåÁ©∫
            if (GameState.board[y][x] !== null) {
                return false;
            }
            
            const bottomY = GameState.boardSize - 1;
            
            // Áõ§Èù¢„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå1„Å§„Åß„ÇÇ„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            let hasAnyBlock = false;
            for (let by = 0; by < GameState.boardSize; by++) {
                for (let bx = 0; bx < GameState.boardSize; bx++) {
                    if (GameState.board[by][bx] !== null) {
                        hasAnyBlock = true;
                        break;
                    }
                }
                if (hasAnyBlock) break;
            }
            
            // „Äê1ÊâãÁõÆ„ÄëÊúÄ‰∏ãÊÆµ„ÅÆ„ÅøË®±ÂèØ
            if (!hasAnyBlock) {
                return y === bottomY;
            }
            
            // „Äê2ÊâãÁõÆ‰ª•Èôç„Äë
            // Êù°‰ª∂2: Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å´‰∏ä‰∏ãÂ∑¶Âè≥„ÅßÈö£Êé•
            if (!hasOrthogonalNeighborBlock(x, y)) {
                return false;
            }
            
            // Êù°‰ª∂3: ÊîØÊåÅÊù°‰ª∂ÔºàÊúÄ‰∏ãÊÆµ OR Áõ¥‰∏ã„Å´„Éñ„É≠„ÉÉ„ÇØÔºâ
            if (!hasSupport(x, y)) {
                return false;
            }
            
            return true;
        }

        /**
         * ÂÖ®„Å¶„ÅÆÂêàÊ≥ïÊâã„ÇíÂèñÂæó
         */
        function getAllValidMoves() {
            const moves = [];
            for (let y = 0; y < GameState.boardSize; y++) {
                for (let x = 0; x < GameState.boardSize; x++) {
                    if (canPlaceAt(x, y)) {
                        moves.push({ x, y });
                    }
                }
            }
            return moves;
        }

        function handleCellClick(x, y) {
            if (!GameState.gameActive) return;
            
            // canPlaceAt„ÅßÂà§ÂÆöÔºàÂîØ‰∏Ä„ÅÆÂà§ÂÆöÈñ¢Êï∞Ôºâ
            if (!canPlaceAt(x, y)) {
                return;
            }
            
            // CPU's turn in solo mode
            if (GameState.gameMode === 'solo' && GameState.currentPlayer === 1) return;
            
            placeBlock(x, y);
        }

        function placeBlock(x, y) {
            // ===== canPlaceAt„ÅßÂà§ÂÆö =====
            if (!canPlaceAt(x, y)) {
                console.error('ÈÖçÁΩÆ‰∏çÂèØ:', x, y);
                return false;
            }
            
            // ===== ÈÖçÁΩÆÂÆüË°å =====
            GameState.board[y][x] = GameState.currentPlayer;
            
            audio.playPlace();
            renderBoard();
            
            const winResult = checkWin(x, y);
            if (winResult) {
                endGame(winResult);
                return true;
            }
            
            if (checkDraw()) {
                endGame(null, true);
                return true;
            }
            
            nextTurn();
            return true;
        }

        function checkWin(lastX, lastY) {
            const player = GameState.board[lastY][lastX];
            const directions = [
                [[0, 1], [0, -1]],   // Vertical
                [[1, 0], [-1, 0]],   // Horizontal
                [[1, 1], [-1, -1]], // Diagonal \
                [[1, -1], [-1, 1]]  // Diagonal /
            ];
            
            for (const [dir1, dir2] of directions) {
                let count = 1;
                const cells = [[lastX, lastY]];
                
                for (const [dx, dy] of [dir1, dir2]) {
                    let x = lastX + dx;
                    let y = lastY + dy;
                    
                    while (x >= 0 && x < GameState.boardSize && 
                           y >= 0 && y < GameState.boardSize &&
                           GameState.board[y][x] === player) {
                        count++;
                        cells.push([x, y]);
                        x += dx;
                        y += dy;
                    }
                }
                
                if (count >= GameState.winLength) {
                    return { player, cells: cells.slice(0, GameState.winLength) };
                }
            }
            
            return null;
        }

        function checkDraw() {
            // ÂêàÊ≥ïÊâã„Åå1„Å§„ÇÇ„Å™„Åë„Çå„Å∞Âºï„ÅçÂàÜ„Åë
            return getAllValidMoves().length === 0;
        }

        function nextTurn() {
            GameState.currentPlayer = (GameState.currentPlayer + 1) % GameState.players.length;
            updateTurnDisplay();
            resetTimer();
            audio.playTurnChange();
            
            if (GameState.gameMode === 'solo' && GameState.currentPlayer === 1) {
                setTimeout(cpuMove, 500 + Math.random() * 500);
            }
        }

        function updateTurnDisplay() {
            document.getElementById('currentTurn').textContent = `P${GameState.currentPlayer + 1}`;
            
            document.querySelectorAll('.player-tag').forEach((tag, i) => {
                tag.classList.toggle('active', i === GameState.currentPlayer);
            });
        }

        // ==================== CPU AI ====================
        function cpuMove() {
            if (!GameState.gameActive) return;
            
            const validMoves = getAllValidMoves();
            
            if (validMoves.length === 0) {
                console.log('No valid moves for CPU');
                return;
            }
            
            let selectedMove;
            
            if (GameState.cpuLevel === 'weak') {
                // Âº±Ôºö70%„É©„É≥„ÉÄ„É†„ÄÅ30%ÊúÄÂñÑÊâã
                if (Math.random() < 0.7) {
                    selectedMove = validMoves[Math.floor(Math.random() * validMoves.length)];
                } else {
                    validMoves.forEach(move => {
                        move.score = evaluateMove(move.x, move.y);
                    });
                    validMoves.sort((a, b) => b.score - a.score);
                    selectedMove = validMoves[0];
                }
            } else if (GameState.cpuLevel === 'normal') {
                // ‰∏≠Ôºö15%„É©„É≥„ÉÄ„É†„ÄÅ85%Ë©ï‰æ°„Éô„Éº„ÇπÔºàÊ∑±„Åï2„ÅÆÂÖàË™≠„ÅøÔºâ
                if (Math.random() < 0.15) {
                    validMoves.forEach(move => {
                        move.score = evaluateMove(move.x, move.y);
                    });
                    validMoves.sort((a, b) => b.score - a.score);
                    // ‰∏ä‰Ωç3Êâã„Åã„Çâ„É©„É≥„ÉÄ„É†ÈÅ∏Êäû
                    const topMoves = validMoves.slice(0, Math.min(3, validMoves.length));
                    selectedMove = topMoves[Math.floor(Math.random() * topMoves.length)];
                } else {
                    validMoves.forEach(move => {
                        move.score = evaluateMoveWithLookahead(move.x, move.y, 2);
                    });
                    validMoves.sort((a, b) => b.score - a.score);
                    selectedMove = validMoves[0];
                }
            } else {
                // Âº∑ÔºöÂÆåÂÖ®„Å™ÂÖàË™≠„ÅøÔºàÊ∑±„Åï4Ôºâ+ È´òÂ∫¶„Å™Ë©ï‰æ°
                validMoves.forEach(move => {
                    move.score = evaluateMoveWithLookahead(move.x, move.y, 4);
                });
                validMoves.sort((a, b) => b.score - a.score);
                selectedMove = validMoves[0];
            }
            
            // ÈÖçÁΩÆÂÆüË°å
            if (selectedMove && canPlaceAt(selectedMove.x, selectedMove.y)) {
                placeBlock(selectedMove.x, selectedMove.y);
            } else {
                const safeMoves = getAllValidMoves();
                if (safeMoves.length > 0) {
                    placeBlock(safeMoves[0].x, safeMoves[0].y);
                }
            }
        }

        // ÂÖàË™≠„Åø‰ªò„ÅçË©ï‰æ°Ôºà„Éü„Éã„Éû„ÉÉ„ÇØ„ÇπÔºâ
        function evaluateMoveWithLookahead(x, y, depth) {
            const cpuPlayer = 1;
            const humanPlayer = 0;
            
            // ‰ªÆÈÖçÁΩÆ
            GameState.board[y][x] = cpuPlayer;
            
            // Âç≥ÂãùÂà©„ÉÅ„Çß„ÉÉ„ÇØ
            if (checkWin(x, y)) {
                GameState.board[y][x] = null;
                return 100000;
            }
            
            let score;
            if (depth <= 1) {
                score = evaluateBoard(cpuPlayer);
            } else {
                score = minimax(depth - 1, false, -Infinity, Infinity, cpuPlayer, humanPlayer);
            }
            
            GameState.board[y][x] = null;
            return score;
        }

        // „Éü„Éã„Éû„ÉÉ„ÇØ„Çπ„Ç¢„É´„Ç¥„É™„Ç∫„É†Ôºà„Ç¢„É´„Éï„Ç°„Éô„Éº„ÇøÊûùÂàà„Çä‰ªò„ÅçÔºâ
        function minimax(depth, isMaximizing, alpha, beta, cpuPlayer, humanPlayer) {
            const validMoves = getAllValidMoves();
            
            if (depth === 0 || validMoves.length === 0) {
                return evaluateBoard(cpuPlayer);
            }
            
            if (isMaximizing) {
                let maxScore = -Infinity;
                for (const move of validMoves) {
                    GameState.board[move.y][move.x] = cpuPlayer;
                    
                    if (checkWin(move.x, move.y)) {
                        GameState.board[move.y][move.x] = null;
                        return 100000 + depth; // Êó©„ÅÑÂãùÂà©„ÇíÂÑ™ÂÖà
                    }
                    
                    const score = minimax(depth - 1, false, alpha, beta, cpuPlayer, humanPlayer);
                    GameState.board[move.y][move.x] = null;
                    
                    maxScore = Math.max(maxScore, score);
                    alpha = Math.max(alpha, score);
                    if (beta <= alpha) break;
                }
                return maxScore;
            } else {
                let minScore = Infinity;
                for (const move of validMoves) {
                    GameState.board[move.y][move.x] = humanPlayer;
                    
                    if (checkWin(move.x, move.y)) {
                        GameState.board[move.y][move.x] = null;
                        return -100000 - depth; // Áõ∏Êâã„ÅÆÊó©„ÅÑÂãùÂà©„ÇíÈÅø„Åë„Çã
                    }
                    
                    const score = minimax(depth - 1, true, alpha, beta, cpuPlayer, humanPlayer);
                    GameState.board[move.y][move.x] = null;
                    
                    minScore = Math.min(minScore, score);
                    beta = Math.min(beta, score);
                    if (beta <= alpha) break;
                }
                return minScore;
            }
        }

        // Áõ§Èù¢ÂÖ®‰Ωì„ÅÆË©ï‰æ°
        function evaluateBoard(cpuPlayer) {
            const humanPlayer = cpuPlayer === 1 ? 0 : 1;
            let score = 0;
            
            const directions = [
                [0, 1],   // Á∏¶
                [1, 0],   // Ê®™
                [1, 1],   // Êñú„ÇÅ \
                [1, -1]   // Êñú„ÇÅ /
            ];
            
            // ÂÖ®„Å¶„ÅÆ„É©„Ç§„É≥„ÇíË©ï‰æ°
            for (let y = 0; y < GameState.boardSize; y++) {
                for (let x = 0; x < GameState.boardSize; x++) {
                    for (const [dx, dy] of directions) {
                        const lineScore = evaluateLine(x, y, dx, dy, cpuPlayer, humanPlayer);
                        score += lineScore;
                    }
                }
            }
            
            return score;
        }

        // „É©„Ç§„É≥Ë©ï‰æ°Ôºà„Çà„ÇäÈ´òÂ∫¶„Å™Ë©ï‰æ°Ôºâ
        function evaluateLine(startX, startY, dx, dy, cpuPlayer, humanPlayer) {
            let cpuCount = 0;
            let humanCount = 0;
            let emptyCount = 0;
            let blocked = false;
            
            for (let i = 0; i < GameState.winLength; i++) {
                const x = startX + dx * i;
                const y = startY + dy * i;
                
                if (x < 0 || x >= GameState.boardSize || y < 0 || y >= GameState.boardSize) {
                    blocked = true;
                    break;
                }
                
                const cell = GameState.board[y][x];
                if (cell === cpuPlayer) cpuCount++;
                else if (cell === humanPlayer) humanCount++;
                else emptyCount++;
            }
            
            if (blocked) return 0;
            
            // ‰∏°Êñπ„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çã„É©„Ç§„É≥„ÅØ‰æ°ÂÄ§„Å™„Åó
            if (cpuCount > 0 && humanCount > 0) return 0;
            
            // CPU„ÅÆ„É©„Ç§„É≥Ë©ï‰æ°
            if (cpuCount > 0 && humanCount === 0) {
                if (cpuCount === GameState.winLength - 1 && emptyCount === 1) {
                    return 5000; // „É™„Éº„ÉÅ
                }
                if (cpuCount === GameState.winLength - 2 && emptyCount === 2) {
                    return 500; // 2ÊâãÂâç
                }
                return cpuCount * cpuCount * 10;
            }
            
            // Áõ∏Êâã„ÅÆ„É©„Ç§„É≥Ë©ï‰æ°ÔºàËÑÖÂ®Å„Å®„Åó„Å¶Ôºâ
            if (humanCount > 0 && cpuCount === 0) {
                if (humanCount === GameState.winLength - 1 && emptyCount === 1) {
                    return -4000; // Áõ∏Êâã„ÅÆ„É™„Éº„ÉÅÔºà„Éñ„É≠„ÉÉ„ÇØÂøÖË¶ÅÔºâ
                }
                if (humanCount === GameState.winLength - 2 && emptyCount === 2) {
                    return -400; // Áõ∏Êâã„ÅÆ2ÊâãÂâç
                }
                return -humanCount * humanCount * 8;
            }
            
            return 0;
        }

        // ÂçòÁ¥îË©ï‰æ°ÔºàÂº±Áî®Ôºâ
        function evaluateMove(x, y) {
            let score = 0;
            const cpuPlayer = 1;
            const humanPlayer = 0;
            
            const originalValue = GameState.board[y][x];
            
            // Âç≥ÂãùÂà©
            GameState.board[y][x] = cpuPlayer;
            if (checkWin(x, y)) {
                GameState.board[y][x] = originalValue;
                return 10000;
            }
            GameState.board[y][x] = originalValue;
            
            // Áõ∏Êâã„ÅÆ„Éñ„É≠„ÉÉ„ÇØ
            GameState.board[y][x] = humanPlayer;
            if (checkWin(x, y)) {
                GameState.board[y][x] = originalValue;
                return 5000;
            }
            GameState.board[y][x] = originalValue;
            
            // „É©„Ç§„É≥Ë©ï‰æ°
            const allDirections = [
                [[0, 1], [0, -1]],
                [[1, 0], [-1, 0]],
                [[1, 1], [-1, -1]],
                [[1, -1], [-1, 1]]
            ];
            
            for (const [dir1, dir2] of allDirections) {
                let cpuCount = 1;
                let humanCount = 1;
                
                for (const [dx, dy] of [dir1, dir2]) {
                    let nx = x + dx;
                    let ny = y + dy;
                    
                    for (let i = 0; i < GameState.winLength - 1; i++) {
                        if (nx < 0 || nx >= GameState.boardSize || 
                            ny < 0 || ny >= GameState.boardSize) break;
                        
                        if (GameState.board[ny][nx] === cpuPlayer) cpuCount++;
                        else if (GameState.board[ny][nx] === humanPlayer) humanCount++;
                        
                        nx += dx;
                        ny += dy;
                    }
                }
                
                score += cpuCount * cpuCount * 10;
                score += humanCount * humanCount * 5;
            }
            
            // ‰∏≠ÂøÉ„Éú„Éº„Éä„Çπ
            const centerDist = Math.abs(x - GameState.boardSize/2) + Math.abs(y - GameState.boardSize/2);
            score += (GameState.boardSize - centerDist) * 2;
            
            return score;
        }

        // ==================== TIMER ====================
        function startTimer() {
            if (GameState.timerSetting === 0) {
                document.getElementById('timerDisplay').textContent = '--';
                return;
            }
            
            GameState.timeLeft = GameState.timerSetting;
            updateTimerDisplay();
            
            GameState.timerInterval = setInterval(() => {
                GameState.timeLeft--;
                updateTimerDisplay();
                
                if (GameState.timeLeft <= 3 && GameState.timeLeft > 0) {
                    audio.playTimerBeep();
                }
                
                if (GameState.timeLeft <= 0) {
                    // Skip turn
                    clearInterval(GameState.timerInterval);
                    nextTurn();
                }
            }, 1000);
        }

        function resetTimer() {
            if (GameState.timerInterval) {
                clearInterval(GameState.timerInterval);
            }
            startTimer();
        }

        function stopTimer() {
            if (GameState.timerInterval) {
                clearInterval(GameState.timerInterval);
                GameState.timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            display.textContent = GameState.timeLeft;
            display.classList.toggle('warning', GameState.timeLeft <= 3);
        }

        // ==================== GAME LIFECYCLE ====================
        function startGame() {
            GameState.gameActive = true;
            GameState.currentPlayer = 0;
            
            initBoard();
            renderBoard();
            renderPlayersBar();
            updateTurnDisplay();
            
            document.getElementById('roomInfo').textContent = `WIN LENGTH: ${GameState.winLength}`;
            
            showScreen('gameScreen');
            startTimer();
            
            audio.playClick();
        }

        function renderPlayersBar() {
            const bar = document.getElementById('playersBar');
            bar.innerHTML = '';
            
            GameState.players.forEach((player, i) => {
                const tag = document.createElement('div');
                tag.className = `player-tag p${i + 1}`;
                tag.textContent = `P${i + 1}: ${player.name}`;
                if (i === 0) tag.classList.add('active');
                bar.appendChild(tag);
            });
        }

        function drawWinLine(cells) {
            // Remove existing win line
            const existingLine = document.querySelector('.win-line-container');
            if (existingLine) existingLine.remove();
            
            const board = document.getElementById('gameBoard');
            const boardRect = board.getBoundingClientRect();
            const cellElements = document.querySelectorAll('.cell');
            
            // Sort cells to get start and end points
            const sortedCells = [...cells].sort((a, b) => {
                if (a[1] !== b[1]) return a[1] - b[1]; // Sort by Y first
                return a[0] - b[0]; // Then by X
            });
            
            const startCell = sortedCells[0];
            const endCell = sortedCells[sortedCells.length - 1];
            
            // Get cell positions
            const startIndex = startCell[1] * GameState.boardSize + startCell[0];
            const endIndex = endCell[1] * GameState.boardSize + endCell[0];
            
            const startCellEl = cellElements[startIndex];
            const endCellEl = cellElements[endIndex];
            
            if (!startCellEl || !endCellEl) return;
            
            const startRect = startCellEl.getBoundingClientRect();
            const endRect = endCellEl.getBoundingClientRect();
            
            // Calculate center positions relative to board
            const startX = startRect.left - boardRect.left + startRect.width / 2;
            const startY = startRect.top - boardRect.top + startRect.height / 2;
            const endX = endRect.left - boardRect.left + endRect.width / 2;
            const endY = endRect.top - boardRect.top + endRect.height / 2;
            
            // Extend line beyond the blocks
            const dx = endX - startX;
            const dy = endY - startY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const extend = 15; // Extension amount
            
            const extStartX = startX - (dx / length) * extend;
            const extStartY = startY - (dy / length) * extend;
            const extEndX = endX + (dx / length) * extend;
            const extEndY = endY + (dy / length) * extend;
            
            // Create SVG container
            const container = document.createElement('div');
            container.className = 'win-line-container';
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'win-line-svg');
            svg.style.width = boardRect.width + 'px';
            svg.style.height = boardRect.height + 'px';
            
            // Create the line path
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'win-line-path');
            path.setAttribute('d', `M ${extStartX} ${extStartY} L ${extEndX} ${extEndY}`);
            
            svg.appendChild(path);
            container.appendChild(svg);
            board.style.position = 'relative';
            board.appendChild(container);
        }

        function endGame(winResult, isDraw = false) {
            GameState.gameActive = false;
            stopTimer();
            
            if (isDraw) {
                document.getElementById('winnerText').textContent = 'DRAW!';
            } else {
                // Highlight winning blocks
                winResult.cells.forEach(([x, y]) => {
                    const cellIndex = y * GameState.boardSize + x;
                    const cell = document.querySelectorAll('.cell')[cellIndex];
                    const block = cell.querySelector('.block');
                    if (block) block.classList.add('winning');
                });
                
                // Draw win line through the blocks
                setTimeout(() => {
                    drawWinLine(winResult.cells);
                }, 100);
                
                const winner = GameState.players[winResult.player];
                document.getElementById('winnerText').textContent = `WINNER: ${winner.name}`;
                
                // Add win to rankings if applicable
                if (GameState.gameMode === 'solo' && winResult.player === 0 && 
                    GameState.cpuLevel === 'strong' && GameState.isRegistered) {
                    addWin(GameState.username);
                }
                
                audio.playWin();
            }
            
            setTimeout(() => {
                document.getElementById('gameOverOverlay').classList.add('active');
            }, 1500);
        }

        function rematch() {
            document.getElementById('gameOverOverlay').classList.remove('active');
            
            // Remove win line
            const winLine = document.querySelector('.win-line-container');
            if (winLine) winLine.remove();
            
            startGame();
        }

        function returnToTitle() {
            document.getElementById('gameOverOverlay').classList.remove('active');
            
            // Remove win line
            const winLine = document.querySelector('.win-line-container');
            if (winLine) winLine.remove();
            
            stopTimer();
            
            // „Éï„Ç©„Éº„É†„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà
            document.getElementById('usernameInput').disabled = false;
            document.getElementById('usernameInput').value = '';
            document.getElementById('registerPlayBtn').disabled = false;
            document.getElementById('registerPlayBtn').textContent = 'ÁôªÈå≤„Åó„Å¶„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã';
            document.getElementById('guestPlayBtn').disabled = false;
            document.getElementById('guestPlayBtn').textContent = 'ÁôªÈå≤„Åó„Å™„ÅÑ„Åß„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã';
            GameState.username = null;
            GameState.isRegistered = false;
            
            showScreen('titleScreen');
        }

        // ==================== QUIT GAME ====================
        function showQuitConfirm() {
            document.getElementById('quitConfirmModal').classList.add('active');
            audio.playClick();
        }

        function hideQuitConfirm() {
            document.getElementById('quitConfirmModal').classList.remove('active');
        }

        function quitGame() {
            hideQuitConfirm();
            GameState.gameActive = false;
            stopTimer();
            audio.stopBGM();
            
            // Remove win line if exists
            const winLine = document.querySelector('.win-line-container');
            if (winLine) winLine.remove();
            
            returnToTitle();
        }

        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Quit button (PC)
            document.getElementById('quitGameBtn').addEventListener('click', () => {
                showQuitConfirm();
            });
            
            // Quit button („Çπ„Éû„Éõ)
            document.getElementById('mobileQuitBtn').addEventListener('click', () => {
                showQuitConfirm();
            });

            document.getElementById('confirmQuitBtn').addEventListener('click', () => {
                quitGame();
            });

            document.getElementById('cancelQuitBtn').addEventListener('click', () => {
                hideQuitConfirm();
                audio.playClick();
            });

            // Help button (PC)
            document.getElementById('helpBtn').addEventListener('click', () => {
                showModal('rulesModal');
                audio.playClick();
            });
            
            // Help button („Çπ„Éû„Éõ - „Ç≤„Éº„É†ÁîªÈù¢)
            document.getElementById('mobileHelpBtn').addEventListener('click', () => {
                showModal('rulesModal');
                audio.playClick();
            });
            
            // Help button („Çπ„Éû„Éõ - „Çø„Ç§„Éà„É´ÁîªÈù¢)
            document.getElementById('mobileHelpBtn2').addEventListener('click', () => {
                showModal('rulesModal');
                audio.playClick();
            });
            
            // BGM button („Çπ„Éû„Éõ - „Ç≤„Éº„É†ÁîªÈù¢)
            document.getElementById('mobileBgmBtn').addEventListener('click', () => {
                const isOn = audio.toggleBGM();
                document.getElementById('mobileBgmBtn').classList.toggle('on', isOn);
                document.getElementById('mobileBgmBtn2').classList.toggle('on', isOn);
                document.getElementById('bgmBtn').classList.toggle('on', isOn);
                document.getElementById('volumeControl').classList.toggle('hidden', !isOn);
            });
            
            // BGM button („Çπ„Éû„Éõ - „Çø„Ç§„Éà„É´ÁîªÈù¢)
            document.getElementById('mobileBgmBtn2').addEventListener('click', () => {
                const isOn = audio.toggleBGM();
                document.getElementById('mobileBgmBtn').classList.toggle('on', isOn);
                document.getElementById('mobileBgmBtn2').classList.toggle('on', isOn);
                document.getElementById('bgmBtn').classList.toggle('on', isOn);
                document.getElementById('volumeControl').classList.toggle('hidden', !isOn);
            });
            
            // SE button („Çπ„Éû„Éõ - „Ç≤„Éº„É†ÁîªÈù¢)
            document.getElementById('mobileSeBtn').addEventListener('click', () => {
                const isOn = audio.toggleSE();
                document.getElementById('mobileSeBtn').classList.toggle('on', isOn);
                document.getElementById('mobileSeBtn2').classList.toggle('on', isOn);
                document.getElementById('seBtn').classList.toggle('on', isOn);
            });
            
            // SE button („Çπ„Éû„Éõ - „Çø„Ç§„Éà„É´ÁîªÈù¢)
            document.getElementById('mobileSeBtn2').addEventListener('click', () => {
                const isOn = audio.toggleSE();
                document.getElementById('mobileSeBtn').classList.toggle('on', isOn);
                document.getElementById('mobileSeBtn2').classList.toggle('on', isOn);
                document.getElementById('seBtn').classList.toggle('on', isOn);
            });

            // Title screen buttons
            document.getElementById('registerPlayBtn').addEventListener('click', () => {
                // „Ç≤„Çπ„Éà„É¢„Éº„ÉâÁä∂ÊÖã„Å†„Å£„Åü„Çâ„É™„Çª„ÉÉ„Éà„Åó„Å¶ÂÖ•ÂäõÂèØËÉΩ„Å´
                if (document.getElementById('usernameInput').disabled) {
                    document.getElementById('usernameInput').disabled = false;
                    document.getElementById('usernameInput').value = '';
                    document.getElementById('guestPlayBtn').disabled = false;
                    document.getElementById('guestPlayBtn').textContent = 'ÁôªÈå≤„Åó„Å™„ÅÑ„Åß„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã';
                    GameState.username = null;
                    GameState.isRegistered = false;
                    audio.playClick();
                    showNotification('„É¶„Éº„Ç∂„Éº„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
                    document.getElementById('usernameInput').focus();
                    return;
                }
                
                const username = document.getElementById('usernameInput').value.trim();
                if (!username) {
                    showNotification('„É¶„Éº„Ç∂„Éº„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                // „Éá„Éê„Ç§„ÇπË™çË®º„Ç∑„Çπ„ÉÜ„É†„ÅßÁôªÈå≤
                const result = DeviceAuth.registerUser(username);
                if (!result.success) {
                    showNotification(result.error);
                    return;
                }
                
                GameState.username = username;
                GameState.isRegistered = true;
                GameState.deviceId = result.deviceId;
                audio.playClick();
                
                // ÁôªÈå≤ÂÆå‰∫Ü„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                document.getElementById('usernameInput').disabled = true;
                document.getElementById('registerPlayBtn').textContent = '‚úì ÁôªÈå≤ÂÆå‰∫Ü';
                document.getElementById('registerPlayBtn').disabled = true;
                document.getElementById('guestPlayBtn').disabled = true;
                
                showNotification('ÁôªÈå≤ÂÆå‰∫ÜÔºÅ‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„Éó„É¨„Ç§„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
            });

            document.getElementById('guestPlayBtn').addEventListener('click', () => {
                GameState.username = 'GUEST';
                GameState.isRegistered = false;
                GameState.deviceId = DeviceAuth.getDeviceId();
                audio.playClick();
                
                // „Ç≤„Çπ„Éà„Å®„Åó„Å¶Ë®≠ÂÆö„Åó„Åü„Åì„Å®„ÇíË¶ñË¶öÁöÑ„Å´Ë°®Á§∫
                document.getElementById('usernameInput').value = 'GUEST';
                document.getElementById('usernameInput').disabled = true;
                document.getElementById('guestPlayBtn').textContent = '‚úì „Ç≤„Çπ„Éà„É¢„Éº„Éâ';
                document.getElementById('guestPlayBtn').disabled = true;
                // ÁôªÈå≤„Éú„Çø„É≥„ÅØÊäº„Åõ„Çã„Åæ„Åæ„Å´„Åô„ÇãÔºàÊäº„Åô„Å®ÂÖ•Âäõ„É¢„Éº„Éâ„Å´Êàª„ÇãÔºâ
                document.getElementById('registerPlayBtn').disabled = false;
                document.getElementById('registerPlayBtn').textContent = 'ÁôªÈå≤„Åó„Å¶„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã';
                
                showNotification('„Ç≤„Çπ„Éà„É¢„Éº„Éâ„ÅßÈñãÂßã„ÄÇ‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„Éó„É¨„Ç§„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info');
            });

            document.getElementById('soloPlayBtn').addEventListener('click', () => {
                showScreen('soloSetupScreen');
                audio.playClick();
            });

            document.getElementById('localPlayBtn').addEventListener('click', () => {
                // „Éû„É´„ÉÅ„Éó„É¨„Ç§„ÅØÁèæÂú®‰ΩøÁî®‰∏çÂèØ
                showNotification('„Éû„É´„ÉÅ„Éó„É¨„Ç§„ÅØÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ\n‰∏Ä‰∫∫„Åß„Éó„É¨„Ç§„Çí„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
                audio.playWarning();
            });

            document.getElementById('rulesBtn').addEventListener('click', () => {
                showModal('rulesModal');
                audio.playClick();
            });

            document.getElementById('rankingBtn').addEventListener('click', () => {
                renderRankings();
                showModal('rankingModal');
                audio.playClick();
            });

            // Modal close buttons
            document.getElementById('closeRulesBtn').addEventListener('click', () => {
                hideModal('rulesModal');
                audio.playClick();
            });

            document.getElementById('closeRankingBtn').addEventListener('click', () => {
                hideModal('rankingModal');
                audio.playClick();
            });

            // Solo setup
            document.querySelectorAll('.cpu-level').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.cpu-level').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.cpuLevel = btn.dataset.level;
                    audio.playClick();
                });
            });

            document.getElementById('startSoloBtn').addEventListener('click', () => {
                GameState.gameMode = 'solo';
                GameState.players = [
                    { name: GameState.username || 'PLAYER 1' },
                    { name: 'CPU' }
                ];
                startGame();
            });

            document.getElementById('backFromSoloBtn').addEventListener('click', () => {
                showScreen('titleScreen');
                audio.playClick();
            });

            // Local setup
            document.getElementById('startLocalBtn').addEventListener('click', () => {
                GameState.gameMode = 'local';
                GameState.players = [];
                for (let i = 0; i < GameState.playerCount; i++) {
                    GameState.players.push({ name: `PLAYER ${i + 1}` });
                }
                startGame();
            });

            document.getElementById('backFromLocalBtn').addEventListener('click', () => {
                showScreen('titleScreen');
                audio.playClick();
            });

            // Select options (win length, timer, player count)
            document.querySelectorAll('#soloSetupScreen .select-option[data-win], #localSetupScreen .select-option[data-win]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.parentElement.querySelectorAll('.select-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.winLength = parseInt(btn.dataset.win);
                    audio.playClick();
                });
            });

            document.querySelectorAll('.select-option[data-timer]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.parentElement.querySelectorAll('.select-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.timerSetting = parseInt(btn.dataset.timer);
                    audio.playClick();
                });
            });

            document.querySelectorAll('.select-option[data-players]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.parentElement.querySelectorAll('.select-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.playerCount = parseInt(btn.dataset.players);
                    audio.playClick();
                });
            });

            // Game over buttons
            document.getElementById('rematchBtn').addEventListener('click', rematch);
            document.getElementById('returnTitleBtn').addEventListener('click', returnToTitle);

            // Hover sounds for buttons
            document.querySelectorAll('.btn, .select-option, .cpu-level').forEach(btn => {
                btn.addEventListener('mouseenter', () => audio.playHover());
            });
        }

        // ==================== INITIALIZATION ====================
        function init() {
            createMatrixBackground();
            loadRankings();
            initEventListeners();
            
            // „Éá„Éê„Ç§„ÇπID„ÇíÂàùÊúüÂåñ
            GameState.deviceId = DeviceAuth.getDeviceId();
            
            // ÂâçÂõû„ÅÆ„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÇíÂæ©ÂÖÉ
            const lastUser = DeviceAuth.getLastUser();
            if (lastUser && DeviceAuth.isRegistered(lastUser)) {
                document.getElementById('usernameInput').value = lastUser;
            }
            
            // Load audio preferences
            const prefs = audio.loadPreferences();
            document.getElementById('bgmBtn').classList.toggle('on', prefs.bgm);
            document.getElementById('seBtn').classList.toggle('on', prefs.se);
            
            // „Çπ„Éû„ÉõÁî®„Éú„Çø„É≥„ÇÇÂêåÊúü
            document.getElementById('mobileBgmBtn').classList.toggle('on', prefs.bgm);
            document.getElementById('mobileBgmBtn2').classList.toggle('on', prefs.bgm);
            document.getElementById('mobileSeBtn').classList.toggle('on', prefs.se);
            document.getElementById('mobileSeBtn2').classList.toggle('on', prefs.se);
            
            // Èü≥Èáè„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆÂàùÊúüÂåñ
            const volumeSlider = document.getElementById('bgmVolume');
            const volumeValue = document.getElementById('volumeValue');
            const volumeControl = document.getElementById('volumeControl');
            
            volumeSlider.value = Math.round(prefs.volume * 100);
            volumeValue.textContent = Math.round(prefs.volume * 100) + '%';
            
            // BGM„ÅåOFF„Å™„ÇâÈü≥Èáè„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíÈùûË°®Á§∫
            volumeControl.classList.toggle('hidden', !prefs.bgm);
            
            // Èü≥Èáè„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç§„Éô„É≥„Éà
            volumeSlider.addEventListener('input', (e) => {
                const volume = parseInt(e.target.value) / 100;
                audio.setBgmVolume(volume);
                volumeValue.textContent = e.target.value + '%';
            });
            
            // BGM„Éú„Çø„É≥ - „Ç∑„É≥„Éó„É´„Å´„ÇØ„É™„ÉÉ„ÇØ„ÅßON/OFF
            const bgmBtn = document.getElementById('bgmBtn');
            bgmBtn.addEventListener('click', () => {
                const isOn = audio.toggleBGM();
                bgmBtn.classList.toggle('on', isOn);
                volumeControl.classList.toggle('hidden', !isOn);
            });

            // SE„Éú„Çø„É≥
            document.getElementById('seBtn').addEventListener('click', () => {
                const btn = document.getElementById('seBtn');
                const isOn = audio.toggleSE();
                btn.classList.toggle('on', isOn);
            });
            
            handleIntro();
        }

        // Handle first user interaction to enable audio
        function enableAudio() {
            audio.init();
            audio.resume();
            document.removeEventListener('click', enableAudio);
            document.removeEventListener('touchstart', enableAudio);
        }
        
        document.addEventListener('click', enableAudio);
        document.addEventListener('touchstart', enableAudio);

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
