<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINKED BLOCKS_</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAIXq3YJPOfdCTp0BGoyRL9RQSjEgEPwLU",
            authDomain: "linked-blocks-64af9.firebaseapp.com",
            databaseURL: "https://linked-blocks-64af9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "linked-blocks-64af9",
            storageBucket: "linked-blocks-64af9.firebasestorage.app",
            messagingSenderId: "319513344169",
            appId: "1:319513344169:web:8e7488a0affc7b4ac711b8",
            measurementId: "G-VY5M2X480Y"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
    
    <style>
        :root {
            --neon-green: #00ff41;
            --neon-green-dim: #00aa2a;
            --neon-green-glow: rgba(0, 255, 65, 0.6);
            --neon-red: #ff0040;
            --neon-yellow: #ffff00;
            --neon-cyan: #00ffff;
            --neon-magenta: #ff00ff;
            --bg-dark: #0a0a0a;
            --bg-panel: rgba(0, 20, 0, 0.9);
            --border-color: #00ff41;
            --text-dim: #00aa2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg-dark);
            color: var(--neon-green);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Matrix Background */
        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.15;
        }

        .matrix-column {
            position: absolute;
            top: -100%;
            font-size: 14px;
            color: var(--neon-green);
            animation: matrix-fall linear infinite;
            white-space: nowrap;
        }

        @keyframes matrix-fall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(200vh); }
        }

        /* Scanline Effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.1) 2px,
                rgba(0, 0, 0, 0.1) 4px
            );
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Screens */
        .screen {
            display: none;
            width: 100%;
            max-width: 500px;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Intro Screen */
        .intro-text {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(18px, 4vw, 28px);
            text-align: center;
            color: var(--neon-green);
            text-shadow: 
                0 0 10px var(--neon-green-glow),
                0 0 20px var(--neon-green-glow),
                0 0 40px var(--neon-green-glow);
            animation: pulseGlow 2s ease-in-out infinite, introFade 3s ease forwards;
            cursor: pointer;
        }

        @keyframes pulseGlow {
            0%, 100% { text-shadow: 0 0 10px var(--neon-green-glow), 0 0 20px var(--neon-green-glow); }
            50% { text-shadow: 0 0 20px var(--neon-green-glow), 0 0 40px var(--neon-green-glow), 0 0 60px var(--neon-green-glow); }
        }

        @keyframes introFade {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Title */
        .title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(28px, 8vw, 48px);
            font-weight: 900;
            color: var(--neon-green);
            text-shadow: 
                0 0 10px var(--neon-green-glow),
                0 0 20px var(--neon-green-glow),
                0 0 40px var(--neon-green-glow);
            margin-bottom: 40px;
            letter-spacing: 2px;
        }

        /* Panel */
        .panel {
            background: var(--bg-panel);
            border: 2px solid var(--border-color);
            padding: 30px;
            width: 100%;
            position: relative;
            box-shadow: 
                0 0 10px var(--neon-green-glow),
                inset 0 0 30px rgba(0, 255, 65, 0.1);
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            pointer-events: none;
        }

        /* Corner decorations */
        .panel::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            width: 20px;
            height: 20px;
            border-top: 3px solid var(--neon-green);
            border-left: 3px solid var(--neon-green);
        }

        .corner-br {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-bottom: 3px solid var(--neon-green);
            border-right: 3px solid var(--neon-green);
        }

        /* Buttons */
        .btn {
            font-family: 'Share Tech Mono', monospace;
            background: transparent;
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin: 8px 0;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: rgba(0, 255, 65, 0.2);
            box-shadow: 
                0 0 15px var(--neon-green-glow),
                inset 0 0 15px rgba(0, 255, 65, 0.1);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
            background: rgba(0, 255, 65, 0.3);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            border-color: var(--text-dim);
            color: var(--text-dim);
            padding: 10px 20px;
            font-size: 14px;
        }

        .btn-secondary:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        /* Input */
        .input-group {
            margin: 15px 0;
            width: 100%;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-dim);
        }

        .input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-green-dim);
            color: var(--neon-green);
            padding: 12px 15px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 16px;
            outline: none;
            transition: all 0.2s ease;
        }

        .input:focus {
            border-color: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        .input::placeholder {
            color: var(--text-dim);
        }

        /* Divider */
        .divider {
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--neon-green), transparent);
            margin: 20px 0;
        }

        /* Select Options */
        .select-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .select-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--neon-green-dim);
            background: transparent;
            color: var(--neon-green-dim);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            font-family: 'Share Tech Mono', monospace;
        }

        .select-option:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .select-option.selected {
            background: rgba(0, 255, 65, 0.2);
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        /* Game Board */
        .game-header {
            width: 100%;
            max-width: 600px;
            margin-bottom: 15px;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-panel);
            border: 1px solid var(--neon-green);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .room-info {
            font-size: 12px;
            color: var(--text-dim);
        }

        .turn-indicator {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green-glow);
        }

        .timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            min-width: 60px;
            text-align: center;
        }

        .timer.warning {
            color: var(--neon-red);
            animation: timerBlink 0.5s ease infinite;
        }

        @keyframes timerBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Player indicators */
        .players-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .player-tag {
            padding: 8px 15px;
            border: 2px solid;
            font-size: 12px;
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .player-tag.active {
            opacity: 1;
            box-shadow: 0 0 15px currentColor;
        }

        .player-tag.p1 { border-color: var(--neon-magenta); color: var(--neon-magenta); }
        .player-tag.p2 { border-color: var(--neon-cyan); color: var(--neon-cyan); }
        .player-tag.p3 { border-color: var(--neon-yellow); color: var(--neon-yellow); }

        /* Board Container */
        .board-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .board-wrapper {
            position: relative;
            padding: 15px;
            background: var(--bg-panel);
            border: 3px solid var(--neon-green);
            box-shadow: 
                0 0 20px var(--neon-green-glow),
                inset 0 0 50px rgba(0, 255, 65, 0.1);
        }

        .board-wrapper::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            pointer-events: none;
        }

        .board {
            display: grid;
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
        }

        .cell {
            aspect-ratio: 1;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid rgba(0, 255, 65, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .cell:hover:not(.occupied) {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--neon-green);
        }

        .cell.valid-move {
            background: rgba(0, 255, 65, 0.05);
            border-color: rgba(0, 255, 65, 0.5);
        }

        .cell.valid-move:hover {
            background: rgba(0, 255, 65, 0.2);
        }

        .block {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            transition: all 0.2s ease;
            position: relative;
        }

        .block.p1 {
            background: radial-gradient(circle at 30% 30%, #ff66a3, var(--neon-magenta), #aa0040);
            box-shadow: 
                0 0 15px rgba(255, 0, 255, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .block.p2 {
            background: radial-gradient(circle at 30% 30%, #66ffff, var(--neon-cyan), #00aaaa);
            box-shadow: 
                0 0 15px rgba(0, 255, 255, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .block.p3 {
            background: radial-gradient(circle at 30% 30%, #ffff66, var(--neon-yellow), #aaaa00);
            box-shadow: 
                0 0 15px rgba(255, 255, 0, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .block.winning {
            animation: winPulse 0.5s ease infinite;
        }

        @keyframes winPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Win Line */
        .win-line {
            position: absolute;
            background: var(--neon-green);
            box-shadow: 
                0 0 10px var(--neon-green),
                0 0 20px var(--neon-green),
                0 0 40px var(--neon-green);
            z-index: 10;
            pointer-events: none;
            animation: lineGlow 0.5s ease infinite;
        }

        .win-line-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }

        .win-line-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .win-line-path {
            stroke: var(--neon-green);
            stroke-width: 6;
            stroke-linecap: round;
            fill: none;
            filter: drop-shadow(0 0 5px var(--neon-green)) 
                    drop-shadow(0 0 10px var(--neon-green)) 
                    drop-shadow(0 0 20px var(--neon-green));
            animation: lineGlowPath 0.8s ease infinite, lineDrawIn 0.5s ease forwards;
        }

        @keyframes lineGlowPath {
            0%, 100% { 
                stroke-width: 6;
                opacity: 1;
            }
            50% { 
                stroke-width: 8;
                opacity: 0.8;
            }
        }

        @keyframes lineDrawIn {
            0% {
                stroke-dasharray: 0, 1000;
            }
            100% {
                stroke-dasharray: 1000, 0;
            }
        }

        @keyframes lineGlow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Game Over Overlay */
        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }

        .game-over-overlay.active {
            display: flex;
        }

        .game-over-content {
            text-align: center;
            padding: 40px;
        }

        .game-set-text {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(36px, 10vw, 64px);
            font-weight: 900;
            color: var(--neon-green);
            text-shadow: 
                0 0 20px var(--neon-green-glow),
                0 0 40px var(--neon-green-glow),
                0 0 60px var(--neon-green-glow);
            margin-bottom: 20px;
            animation: pulseGlow 1s ease infinite;
        }

        .winner-text {
            font-family: 'Share Tech Mono', monospace;
            font-size: clamp(18px, 4vw, 24px);
            color: var(--neon-green);
            margin-bottom: 30px;
        }

        .game-over-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .game-over-buttons .btn {
            width: auto;
            min-width: 150px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-panel);
            border: 2px solid var(--neon-green);
            padding: 30px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px var(--neon-green-glow);
        }

        .modal-content.modal-small {
            max-width: 350px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            min-width: 120px;
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green-glow);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--neon-green);
            font-size: 24px;
            cursor: pointer;
        }

        /* Quit Button */
        .quit-btn {
            position: fixed;
            top: 20px;
            right: 70px;
            padding: 10px 15px;
            background: rgba(0, 10, 0, 0.8);
            border: 2px solid var(--neon-red);
            color: var(--neon-red);
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 100;
        }

        .quit-btn:hover {
            background: rgba(255, 0, 64, 0.2);
            box-shadow: 0 0 15px rgba(255, 0, 64, 0.5);
        }

        .rule-section {
            margin: 15px 0;
        }

        .rule-section h3 {
            color: var(--neon-green);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .rule-section p, .rule-section li {
            color: var(--text-dim);
            font-size: 13px;
            line-height: 1.6;
        }

        .rule-section ul {
            padding-left: 20px;
        }

        /* Ranking */
        .ranking-list {
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 0;
            border: 1px solid rgba(0, 255, 65, 0.3);
            background: rgba(0, 255, 65, 0.05);
            border-radius: 5px;
        }

        /* 1‰Ωç - È´òÁ¥öÊÑü„ÅÆ„ÅÇ„ÇãÈáëËâ≤ */
        .ranking-item.rank-gold { 
            border-color: #d4af37;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(255, 215, 0, 0.1) 50%, rgba(212, 175, 55, 0.15) 100%);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }
        .ranking-item.rank-gold .rank { 
            color: #d4af37;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        /* 2‰Ωç - ÈäÄËâ≤ */
        .ranking-item.rank-silver { 
            border-color: #c0c0c0;
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.15) 0%, rgba(220, 220, 220, 0.1) 50%, rgba(192, 192, 192, 0.15) 100%);
            box-shadow: 0 0 10px rgba(192, 192, 192, 0.2);
        }
        .ranking-item.rank-silver .rank { 
            color: #c0c0c0;
            text-shadow: 0 0 8px rgba(192, 192, 192, 0.4);
        }
        
        /* 3‰Ωç - ÈäÖËâ≤ */
        .ranking-item.rank-bronze { 
            border-color: #cd7f32;
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.15) 0%, rgba(184, 115, 51, 0.1) 50%, rgba(205, 127, 50, 0.15) 100%);
            box-shadow: 0 0 8px rgba(205, 127, 50, 0.2);
        }
        .ranking-item.rank-bronze .rank { 
            color: #cd7f32;
            text-shadow: 0 0 6px rgba(205, 127, 50, 0.4);
        }

        .rank {
            width: 40px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            font-size: 18px;
        }

        .ranking-name {
            flex: 1;
            font-size: 16px;
        }

        .ranking-wins {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 60px;
        }

        .ranking-wins .wins-label {
            font-size: 10px;
            color: var(--text-dim);
            font-family: 'Share Tech Mono', monospace;
        }

        .ranking-wins .wins-count {
            color: var(--neon-green);
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            font-size: 22px;
            text-shadow: 0 0 10px var(--neon-green-glow);
        }

        /* Ranking Tabs */
        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .ranking-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: 2px solid var(--neon-green-dim);
            color: var(--neon-green-dim);
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .ranking-tab:hover, .ranking-tab.active {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .ranking-tab.active {
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        .ranking-note {
            color: var(--text-dim);
            font-size: 11px;
            text-align: center;
            margin-top: 15px;
        }

        /* Waiting Players List */
        .waiting-player {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid var(--neon-green-dim);
            background: rgba(0, 255, 65, 0.05);
        }

        .waiting-player .player-index {
            width: 30px;
            color: var(--neon-cyan);
            font-weight: bold;
        }

        .waiting-player .player-name {
            flex: 1;
        }

        .waiting-player.offline {
            border-color: var(--neon-red);
            opacity: 0.5;
        }

        .waiting-player.offline .player-name {
            color: var(--neon-red);
            text-decoration: line-through;
        }

        /* CPU Level */
        .cpu-levels {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .cpu-level {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--neon-green-dim);
            background: transparent;
            color: var(--neon-green-dim);
            cursor: pointer;
            text-align: center;
            font-family: 'Share Tech Mono', monospace;
            transition: all 0.2s ease;
        }

        .cpu-level:hover, .cpu-level.selected {
            border-color: var(--neon-green);
            color: var(--neon-green);
            background: rgba(0, 255, 65, 0.1);
        }

        .cpu-level.selected {
            box-shadow: 0 0 15px var(--neon-green-glow);
        }

        /* Settings */
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }

        .toggle {
            width: 50px;
            height: 26px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-green-dim);
            border-radius: 13px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .toggle.on {
            background: rgba(0, 255, 65, 0.3);
            border-color: var(--neon-green);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: var(--neon-green-dim);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .toggle.on::after {
            left: 26px;
            background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            border: 2px solid var(--neon-red);
            padding: 20px 40px;
            z-index: 300;
            display: none;
            animation: notifyPop 0.3s ease;
            box-shadow: 0 0 30px rgba(255, 0, 64, 0.5);
            text-align: center;
            white-space: pre-line;
            max-width: 90%;
        }

        .notification.active {
            display: block;
        }

        .notification.warning {
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .notification.info {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 30px var(--neon-green-glow);
        }

        .notification.success {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 30px var(--neon-green-glow);
        }

        @keyframes notifyPop {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .panel {
                padding: 20px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .game-info {
                flex-direction: column;
                gap: 5px;
                padding: 8px;
                font-size: 12px;
            }

            .game-header {
                padding-top: 10px;
            }

            .players-bar {
                flex-wrap: wrap;
                gap: 5px;
                justify-content: center;
            }

            .player-tag {
                padding: 6px 10px;
                font-size: 11px;
            }

            .game-over-buttons {
                flex-direction: column;
            }

            .game-over-buttons .btn {
                width: 100%;
            }

            /* „Çπ„Éû„Éõ„Åß„ÅØfixedÈÖçÁΩÆ„ÅÆ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åó„ÄÅ„Ç≤„Éº„É†ÂÜÖ„Å´ÈÖçÁΩÆ */
            .help-btn {
                display: none;
            }

            .quit-btn {
                display: none;
            }

            .audio-controls {
                display: none;
            }

            /* „Éú„Éº„ÉâË™øÊï¥ */
            .board-container {
                padding: 10px;
            }

            .cell {
                width: 38px;
                height: 38px;
            }

            /* „Çø„Ç§„Éà„É´ */
            .title {
                font-size: 28px;
            }

            /* „É¢„Éº„ÉÄ„É´ */
            .modal-content {
                padding: 20px;
                max-height: 70vh;
            }

            .modal-title {
                font-size: 18px;
            }

            .notification {
                padding: 15px 20px;
                font-size: 13px;
            }

            /* „Çπ„Éû„ÉõÁî®„Ç§„É≥„É©„Ç§„É≥„Ç≥„É≥„Éà„É≠„Éº„É´Ë°®Á§∫ */
            .mobile-controls {
                display: flex !important;
            }
        }

        /* „Åï„Çâ„Å´Â∞è„Åï„ÅÑÁîªÈù¢ */
        @media (max-width: 400px) {
            .title {
                font-size: 22px;
            }

            .cell {
                width: 32px;
                height: 32px;
            }
        }

        /* „Çπ„Éû„ÉõÁî®„Ç§„É≥„É©„Ç§„É≥„Ç≥„É≥„Éà„É≠„Éº„É´Ôºà„Éá„Éï„Ç©„É´„ÉàÈùûË°®Á§∫Ôºâ */
        .mobile-controls {
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 10px;
            background: rgba(0, 10, 0, 0.8);
            border: 1px solid var(--neon-green-dim);
        }

        .mobile-controls .left-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-controls .right-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-controls .mobile-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-panel);
            border: 1px solid var(--neon-green-dim);
            color: var(--neon-green-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
        }

        .mobile-controls .mobile-btn.on {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .mobile-controls .mobile-btn:not(.on)::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 18px;
            background: var(--neon-red);
            transform: rotate(45deg);
        }

        .mobile-controls .mobile-quit {
            padding: 5px 10px;
            background: transparent;
            border: 1px solid var(--neon-red);
            color: var(--neon-red);
            font-size: 11px;
            cursor: pointer;
        }

        .mobile-controls .mobile-help {
            width: 28px;
            height: 28px;
            background: var(--bg-panel);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-size: 14px;
            cursor: pointer;
        }

        .mobile-controls-title {
            margin-bottom: 15px;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
            justify-content: center;
            gap: 15px;
        }

        .mobile-controls-title .left-controls {
            gap: 12px;
        }

        .mobile-controls-title .right-controls {
            margin-left: 15px;
        }

            .player-tag {
                padding: 5px 8px;
                font-size: 10px;
            }

            .audio-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
        }

        /* „Éë„Éç„É´‰∏ãÈÉ®„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´ÔºàFALL-DODGEÈ¢®Ôºâ */
        .panel-footer-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 255, 65, 0.3);
            flex-wrap: wrap;
        }
        
        .panel-divider {
            color: var(--neon-green-dim);
            margin: 0 5px;
        }
        
        .panel-toggle-btn {
            padding: 8px 16px;
            background: transparent;
            border: 2px solid var(--neon-green-dim);
            color: var(--neon-green-dim);
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .panel-toggle-btn:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }
        
        .panel-toggle-btn.on {
            border-color: var(--neon-green);
            color: var(--neon-green);
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 10px var(--neon-green-glow);
        }
        
        .panel-toggle-btn:not(.on):not(.lang-btn)::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 60%;
            background: var(--neon-red);
            top: 20%;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            box-shadow: 0 0 5px var(--neon-red);
        }
        
        .panel-toggle-btn.lang-btn.active {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- Matrix Background -->
    <div class="matrix-bg" id="matrixBg"></div>
    
    <!-- Scanlines -->
    <div class="scanlines"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Intro Screen -->
        <div class="screen active" id="introScreen">
            <div class="intro-text" id="introText">„Éñ„É≠„ÉÉ„ÇØ„ÇíÂÖà„Å´ÊèÉ„Åà„Å¶ÂãùÂà©„Åõ„ÇàÔºÅ</div>
        </div>

        <!-- Title Screen -->
        <div class="screen" id="titleScreen">
            <h1 class="title">LINKED BLOCKS_</h1>
            
            <div class="panel">
                <div class="corner-br"></div>
                
                <div class="input-group">
                    <label class="input-label">USER NAME</label>
                    <input type="text" class="input" id="usernameInput" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ..." maxlength="12">
                </div>

                <button class="btn" id="registerPlayBtn">ÁôªÈå≤„Åó„Å¶„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã</button>
                <button class="btn btn-secondary" id="guestPlayBtn">‚ñ∂ ÁôªÈå≤„Åó„Å™„ÅÑ„Åß„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã</button>

                <div class="divider"></div>

                <button class="btn" id="localPlayBtn">„Éû„É´„ÉÅ„Éó„É¨„Ç§Ôºà2„Äú3‰∫∫Ôºâ</button>

                <div class="divider"></div>

                <button class="btn btn-secondary" id="rulesBtn">„É´„Éº„É´Ë™¨Êòé„ÇíË¶ã„Çã</button>
                <button class="btn btn-secondary" id="rankingBtn">„É©„É≥„Ç≠„É≥„Ç∞„ÇíË¶ã„Çã</button>
                
                <!-- „Éë„Éç„É´‰∏ãÈÉ®„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´ -->
                <div class="panel-footer-controls">
                    <button class="panel-toggle-btn lang-btn active" id="langJaBtn">Êó•Êú¨Ë™û</button>
                    <button class="panel-toggle-btn lang-btn" id="langEnBtn">English</button>
                    <span class="panel-divider">|</span>
                    <button class="panel-toggle-btn on" id="panelBgmBtn">üéµ BGM</button>
                </div>
            </div>
        </div>

        <!-- Solo Setup Screen -->
        <div class="screen" id="soloSetupScreen">
            <h1 class="title">CPUÂØæÊà¶</h1>
            <div class="panel">
                <div class="corner-br"></div>
                
                <div class="input-group">
                    <label class="input-label">CPU„É¨„Éô„É´</label>
                    <div class="cpu-levels">
                        <button class="cpu-level" data-level="weak">Âº±</button>
                        <button class="cpu-level selected" data-level="normal">ÊôÆÈÄö</button>
                        <button class="cpu-level" data-level="strong">Âº∑</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">ÊèÉ„Åà„Çã„Éñ„É≠„ÉÉ„ÇØÊï∞</label>
                    <div class="select-group">
                        <button class="select-option selected" data-win="4">4</button>
                        <button class="select-option" data-win="5">5</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">„Çø„Ç§„Éû„ÉºÔºàÁßíÔºâ</label>
                    <div class="select-group">
                        <button class="select-option selected" data-timer="0">OFF</button>
                        <button class="select-option" data-timer="10">10</button>
                        <button class="select-option" data-timer="20">20</button>
                        <button class="select-option" data-timer="30">30</button>
                    </div>
                </div>

                <div class="divider"></div>

                <button class="btn" id="startSoloBtn">START</button>
                <button class="btn btn-secondary" id="backFromSoloBtn">Êàª„Çã</button>
            </div>
        </div>

        <!-- Local Multiplayer Setup Screen -->
        <div class="screen" id="localSetupScreen">
            <h1 class="title">„Éû„É´„ÉÅ„Éó„É¨„Ç§</h1>
            <div class="panel">
                <div class="corner-br"></div>
                
                <div class="input-group">
                    <label class="input-label">„Éó„É¨„Ç§„É§„ÉºÊï∞</label>
                    <div class="select-group">
                        <button class="select-option selected" data-players="2">2‰∫∫</button>
                        <button class="select-option" data-players="3">3‰∫∫</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">ÊèÉ„Åà„Çã„Éñ„É≠„ÉÉ„ÇØÊï∞</label>
                    <div class="select-group">
                        <button class="select-option selected" data-win="4">4</button>
                        <button class="select-option" data-win="5">5</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">„Çø„Ç§„Éû„ÉºÔºàÁßíÔºâ</label>
                    <div class="select-group">
                        <button class="select-option selected" data-timer="0">OFF</button>
                        <button class="select-option" data-timer="10">10</button>
                        <button class="select-option" data-timer="20">20</button>
                        <button class="select-option" data-timer="30">30</button>
                    </div>
                </div>

                <div class="divider"></div>

                <button class="btn" id="startLocalBtn">START</button>
                <button class="btn btn-secondary" id="backFromLocalBtn">Êàª„Çã</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="gameScreen">
            <div class="game-header">
                <div class="game-info">
                    <span class="room-info" id="roomInfo">WIN LENGTH: 4</span>
                    <span class="turn-indicator">TURN: <span id="currentTurn">P1</span></span>
                    <span class="timer" id="timerDisplay">--</span>
                </div>
                
                <!-- „Çπ„Éû„ÉõÁî®„Ç≥„É≥„Éà„É≠„Éº„É´„Éê„Éº -->
                <div class="mobile-controls" id="mobileControls">
                    <div class="left-controls">
                        <button class="mobile-btn on" id="mobileBgmBtn" title="BGM">‚ô™</button>
                    </div>
                    <div class="right-controls">
                        <button class="mobile-quit" id="mobileQuitBtn">‚úï ‰∏≠Êñ≠</button>
                        <button class="mobile-help" id="mobileHelpBtn">?</button>
                    </div>
                </div>
                
                <div class="players-bar" id="playersBar"></div>
            </div>

            <div class="board-container">
                <div class="board-wrapper" id="boardWrapper">
                    <div class="board" id="gameBoard"></div>
                </div>
            </div>
            
            <button class="quit-btn" id="quitGameBtn">‚úï ‰∏≠Êñ≠</button>
        </div>
    </div>

    <!-- Quit Confirm Modal -->
    <div class="modal" id="quitConfirmModal">
        <div class="modal-content modal-small">
            <h2 class="modal-title">„Ç≤„Éº„É†„Çí‰∏≠Êñ≠„Åó„Åæ„Åô„ÅãÔºü</h2>
            <p style="text-align: center; margin-bottom: 20px; color: var(--neon-green-dim);">ÈÄ≤Ë°å‰∏≠„ÅÆ„Ç≤„Éº„É†„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì</p>
            <div class="modal-buttons">
                <button class="btn" id="confirmQuitBtn">‰∏≠Êñ≠„Åô„Çã</button>
                <button class="btn btn-secondary" id="cancelQuitBtn">Á∂ö„Åë„Çã</button>
            </div>
        </div>
    </div>

    <!-- Game Over Overlay -->
    <div class="game-over-overlay" id="gameOverOverlay">
        <div class="game-over-content">
            <div class="game-set-text">GAME SET!</div>
            <div class="winner-text" id="winnerText">WINNER: PLAYER 1</div>
            <div id="gameOverCountdown" style="font-size: 36px; color: var(--neon-red); margin: 15px 0; display: none;"></div>
            <div class="game-over-buttons">
                <button class="btn" id="rematchBtn">ÂÜçÊà¶</button>
                <button class="btn btn-secondary" id="returnTitleBtn">„Çø„Ç§„Éà„É´„Å∏</button>
            </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div class="modal" id="rulesModal">
        <div class="modal-content">
            <button class="modal-close" id="closeRulesBtn">√ó</button>
            <h2 class="modal-title">RULES</h2>
            
            <div class="rule-section">
                <h3>„ÄêÂãùÂà©Êù°‰ª∂„Äë</h3>
                <p>Á∏¶„ÉªÊ®™„ÉªÊñú„ÇÅ„Å´ÊåáÂÆöÊï∞Ôºà4„Åæ„Åü„ÅØ5Ôºâ„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíÈÄ£Á∂ö„Åß‰∏¶„Åπ„Çã</p>
            </div>

            <div class="rule-section">
                <h3>„ÄêÈÖçÁΩÆ„É´„Éº„É´„Äë</h3>
                <ul>
                    <li>ÂàùÊâã„ÅØÁõ§Èù¢ÊúÄ‰∏ãÊÆµÔºàÂú∞Èù¢Ôºâ„ÅÆ„ÅøÈÖçÁΩÆÂèØËÉΩ</li>
                    <li>2ÊâãÁõÆ‰ª•Èôç„ÅØÊó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å´Èö£Êé•ÔºàÊé•Âú∞Ôºâ„Åô„Çã‰ΩçÁΩÆ„ÅÆ„ÅøÈÖçÁΩÆÂèØËÉΩ</li>
                    <li>Á©∫‰∏≠ÈÖçÁΩÆ„ÉªÂº∑Âà∂ËêΩ‰∏ã„Å™„Åó</li>
                </ul>
            </div>

            <div class="rule-section">
                <h3>„Äê„Çø„Ç§„Éû„Éº„Äë</h3>
                <p>Ë®≠ÂÆöÊôÇÈñìÂÜÖ„Å´ÈÖçÁΩÆ„Åó„Å™„ÅÑ„Å®Ëá™Âãï„Åß„Çø„Éº„É≥„Åå„Çπ„Ç≠„ÉÉ„Éó„Åï„Çå„Åæ„Åô</p>
            </div>

            <div class="rule-section">
                <h3>„Äê„É¶„Éº„Ç∂„ÉºÁôªÈå≤„Å´„Å§„ÅÑ„Å¶„Äë</h3>
                <ul>
                    <li>ÁôªÈå≤„Åô„Çã„Å®„ÄÅ„É©„É≥„Ç≠„É≥„Ç∞„Å´Ë®òÈå≤„Åï„Çå„Åæ„Åô</li>
                    <li>„Éû„É´„ÉÅ„Éó„É¨„Ç§„ÅØÁôªÈå≤„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÂèÇÂä†ÂèØËÉΩ</li>
                    <li>‰ΩøÁî®‰∏≠„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÅØ‰ªñ„ÅÆ‰∫∫„ÅØ‰Ωø„Åà„Åæ„Åõ„Çì</li>
                    <li>„Ç¢„Éó„É™„ÇíÈñâ„Åò„Çã„Å®Ëá™Âãï„Åß„É≠„Ç∞„Ç¢„Ç¶„Éà„Åï„Çå„Åæ„Åô</li>
                    <li>„Ç≤„Çπ„Éà„Åß„ÇÇ‰∏Ä‰∫∫„Éó„É¨„Ç§ÔºàCPUÂØæÊà¶Ôºâ„ÅØÂèØËÉΩ„Åß„Åô</li>
                </ul>
                <p style="margin-top: 10px; font-size: 12px; color: var(--text-dim);">
                    ‚Äª„É≠„Ç∞„Ç¢„Ç¶„ÉàÂæå„ÅØÂêå„ÅòÂêçÂâç„ÅßÂÜç„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åæ„Åô
                </p>
            </div>

            <div class="rule-section">
                <h3>„Äê„É©„É≥„Ç≠„É≥„Ç∞„Äë</h3>
                <ul>
                    <li>ÁôªÈå≤„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÂØæË±°</li>
                    <li>‰∏Ä‰∫∫„Éó„É¨„Ç§„Å®„Éû„É´„ÉÅ„Éó„É¨„Ç§„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞„ÅØÂà•„ÄÖ„Å´Ë®òÈå≤</li>
                </ul>
                <p style="margin-top: 10px; font-size: 12px; color: var(--text-dim);">
                    „Äê‰∏Ä‰∫∫„Éó„É¨„Ç§„ÄëCPU„ÄåÂº∑„Äç„Å´ÂãùÂà©„Åß+1<br>
                    „Äê„Éû„É´„ÉÅ„Éó„É¨„Ç§„ÄëÂÑ™Âãù„Åß+1
                </p>
            </div>

            <div class="rule-section">
                <h3>„Äê„Éû„É´„ÉÅ„Éó„É¨„Ç§„Äë</h3>
                <ul>
                    <li>Âêå„Åò„É´„Éº„É†ID„ÇíÂÖ•Âäõ„Åó„Åü„Éó„É¨„Ç§„É§„ÉºÂêåÂ£´„ÅßÂØæÊà¶</li>
                    <li>ÊúÄÂ§ß3‰∫∫„Åæ„ÅßÂèÇÂä†ÂèØËÉΩ</li>
                    <li>„É´„Éº„É†‰ΩúÊàêËÄÖÔºàP1Ôºâ„Åå„Ç≤„Éº„É†ÈñãÂßã„Éú„Çø„É≥„ÇíÊäº„Åõ„Åæ„Åô</li>
                    <li>Âêå„Åò„É´„Éº„É†ÂÜÖ„Åß„ÅØÂêå„Åò„É¶„Éº„Ç∂„ÉºÂêç„ÅØ‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Ranking Modal -->
    <div class="modal" id="rankingModal">
        <div class="modal-content">
            <button class="modal-close" id="closeRankingBtn">√ó</button>
            <h2 class="modal-title">RANKING</h2>
            
            <!-- „É©„É≥„Ç≠„É≥„Ç∞„Çø„Éñ -->
            <div class="ranking-tabs">
                <button class="ranking-tab active" data-tab="solo">‰∏Ä‰∫∫„Éó„É¨„Ç§</button>
                <button class="ranking-tab" data-tab="multi">„Éû„É´„ÉÅ„Éó„É¨„Ç§</button>
            </div>
            
            <div class="ranking-list" id="soloRankingList"></div>
            <div class="ranking-list" id="multiRankingList" style="display: none;"></div>
            
            <p class="ranking-note">‚Äª„É©„É≥„Ç≠„É≥„Ç∞„ÅØÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅßÂÖ±Êúâ„Åï„Çå„Åæ„Åô</p>
        </div>
    </div>

    <!-- Multiplayer Setup Modal -->
    <div class="modal" id="multiSetupModal">
        <div class="modal-content">
            <button class="modal-close" id="closeMultiSetupBtn">√ó</button>
            <h2 class="modal-title">MULTIPLAYER</h2>
            
            <div class="input-group">
                <label class="input-label">ROOM ID</label>
                <input type="text" class="input" id="roomIdInput" placeholder="„É´„Éº„É†ID„ÇíÂÖ•Âäõ..." maxlength="20">
            </div>
            
            <p style="color: var(--text-dim); font-size: 12px; margin: 10px 0;">
                Âêå„Åò„É´„Éº„É†ID„ÇíÂÖ•Âäõ„Åó„Åü„Éó„É¨„Ç§„É§„ÉºÂêåÂ£´„Åå„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åó„Åæ„Åô
            </p>
            
            <div class="input-group">
                <label class="input-label">ÊèÉ„Åà„Çã„Éñ„É≠„ÉÉ„ÇØÊï∞</label>
                <div class="select-group">
                    <button class="select-option selected" data-multiwin="4">4</button>
                    <button class="select-option" data-multiwin="5">5</button>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label">ÊåÅ„Å°ÊôÇÈñì</label>
                <div class="select-group">
                    <button class="select-option" data-multitimer="none">„Å™„Åó</button>
                    <button class="select-option selected" data-multitimer="30">30Áßí</button>
                    <button class="select-option" data-multitimer="60">60Áßí</button>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <button class="btn" id="joinRoomBtn">„É´„Éº„É†„Å´ÂèÇÂä†</button>
            <button class="btn btn-secondary" id="cancelMultiBtn">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <!-- Multiplayer Waiting Modal -->
    <div class="modal" id="multiWaitingModal">
        <div class="modal-content modal-small">
            <h2 class="modal-title">WAITING...</h2>
            <p style="text-align: center; margin: 20px 0;">
                ROOM: <span id="waitingRoomId" style="color: var(--neon-cyan);"></span>
            </p>
            
            <!-- „É´„Éº„É´Ë°®Á§∫„Ç®„É™„Ç¢ -->
            <div id="roomRulesDisplay" style="margin: 15px 0; padding: 10px; border: 1px solid var(--neon-green); border-radius: 5px;">
                <p style="text-align: center; margin: 5px 0; font-size: 14px;">
                    <span style="color: var(--text-dim);">ÊèÉ„Åà„ÇãÊï∞:</span> 
                    <span id="roomWinLength" style="color: var(--neon-green);">4</span>
                </p>
                <p style="text-align: center; margin: 5px 0; font-size: 14px;">
                    <span style="color: var(--text-dim);">ÊåÅ„Å°ÊôÇÈñì:</span> 
                    <span id="roomTimerSetting" style="color: var(--neon-green);">30Áßí</span>
                </p>
            </div>
            
            <div id="waitingPlayersList" style="margin: 20px 0;"></div>
            <p style="color: var(--text-dim); font-size: 12px; text-align: center;">
                „Éó„É¨„Ç§„É§„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô... (ÊúÄÂ§ß3‰∫∫)
            </p>
            <div class="divider"></div>
            <button class="btn" id="startMultiGameBtn" style="display: none;">„Ç≤„Éº„É†ÈñãÂßã</button>
            <button class="btn btn-secondary" id="leaveRoomBtn">ÈÄÄÂá∫</button>
        </div>
    </div>

    <!-- Rematch Waiting Modal (ÂÜçÊà¶ÂæÖÊ©ü) -->
    <div class="modal" id="rematchWaitingModal">
        <div class="modal-content">
            <h2 class="modal-title" style="color: var(--neon-yellow);">ÂÜçÊà¶ÂæÖÊ©ü‰∏≠</h2>
            <p style="text-align: center; margin: 10px 0; color: var(--text-dim); font-size: 12px;">
                ROOM: <span id="rematchRoomId" style="color: var(--neon-cyan);"></span>
            </p>
            <div id="rematchPlayerStatus" style="margin: 20px 0;"></div>
            <p style="color: var(--text-dim); font-size: 12px; text-align: center; margin: 10px 0;">
                „Éó„É¨„Ç§„É§„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô... (ÊúÄÂ§ß3‰∫∫)
            </p>
            <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
                <button class="btn" id="rematchStartBtn" style="display: none;">„Ç≤„Éº„É†ÈñãÂßã</button>
                <button class="btn btn-secondary" id="rematchCancelBtn">ÈÄÄÂá∫</button>
            </div>
        </div>
    </div>

    <!-- Roulette Modal (È†ÜÁï™Ê±∫„ÇÅ„É´„Éº„É¨„ÉÉ„Éà) -->
    <div class="modal" id="rouletteModal">
        <div class="modal-content modal-small">
            <h2 class="modal-title" style="color: var(--neon-yellow);">È†ÜÁï™Ê±∫„ÇÅ</h2>
            <div id="rouletteDisplay" style="text-align: center; margin: 30px 0;">
                <div id="rouletteSpinner" style="font-size: 48px; color: var(--neon-green);"></div>
            </div>
            <p id="rouletteResult" style="text-align: center; margin: 20px 0; color: var(--neon-cyan); display: none;"></p>
        </div>
    </div>

    <!-- Player Left During Game Modal („Ç≤„Éº„É†‰∏≠„ÅÆÈÄÄÂ∏≠) -->
    <div class="modal" id="playerLeftDuringGameModal">
        <div class="modal-content modal-small">
            <h2 class="modal-title" style="color: var(--neon-red);">ÈÄÄÂ∏≠ÈÄöÁü•</h2>
            <p id="playerLeftDuringGameMessage" style="text-align: center; margin: 20px 0; color: var(--neon-red);"></p>
            <p style="text-align: center; margin-bottom: 20px;">„Ç≤„Éº„É†„ÇíÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü</p>
            <div class="modal-buttons">
                <button class="btn" id="continueGameDuringBtn">Á∂öË°å„Åô„Çã</button>
                <button class="btn btn-secondary" id="endGameDuringBtn">ÁµÇ‰∫Ü„Åô„Çã</button>
            </div>
        </div>
    </div>

    <!-- Spectator Waiting Modal (Ë¶≥Êà¶ËÄÖÂæÖÊ©ü) -->
    <div class="modal" id="spectatorWaitingModal">
        <div class="modal-content modal-small">
            <h2 class="modal-title" style="color: var(--neon-cyan);">ÂæÖÊ©ü‰∏≠</h2>
            <p style="text-align: center; margin: 20px 0; color: var(--text-color);">
                ÁèæÂú®„Ç≤„Éº„É†ÈÄ≤Ë°å‰∏≠„Åß„Åô<br>
                „Ç≤„Éº„É†ÁµÇ‰∫Ü„Åæ„ÅßÂæÖÊ©ü„Åó„Å¶„ÅÑ„Åæ„Åô...
            </p>
            <div id="spectatorGameStatus" style="text-align: center; margin: 10px 0; color: var(--neon-green);"></div>
            <button class="btn btn-secondary" id="cancelSpectatorBtn">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <!-- Player Left Notification Modal -->
    <div class="modal" id="playerLeftModal">
        <div class="modal-content modal-small">
            <h2 class="modal-title" style="color: var(--neon-red);">ÈÄÄÂ∏≠ÈÄöÁü•</h2>
            <p id="playerLeftMessage" style="text-align: center; margin: 20px 0; color: var(--neon-red);"></p>
            <p style="text-align: center; margin-bottom: 20px;">„Ç≤„Éº„É†„ÇíÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü</p>
            <div class="modal-buttons">
                <button class="btn" id="continueGameBtn">„ÅØ„ÅÑ</button>
                <button class="btn btn-secondary" id="endGameAfterLeaveBtn">„ÅÑ„ÅÑ„Åà</button>
            </div>
        </div>
    </div>

    <!-- Alone In Room Modal (‰∏Ä‰∫∫„Å´„Å™„Å£„ÅüÂ†¥Âêà) -->
    <div class="modal" id="aloneInRoomModal">
        <div class="modal-content modal-small">
            <h2 class="modal-title" style="color: var(--neon-yellow);">„ÅäÁü•„Çâ„Åõ</h2>
            <p style="text-align: center; margin: 20px 0; color: var(--text-color);">
                ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåÈõ¢ËÑ±„Åó‰∏Ä‰∫∫„Å´„Å™„Å£„Åü„Åü„ÇÅ<br>„Çø„Ç§„Éà„É´ÁîªÈù¢„Å∏ÁßªÂãï„Åó„Åæ„Åô
            </p>
            <button class="btn" id="aloneOkBtn">OK</button>
        </div>
    </div>

    <!-- New Player Waiting Modal (Êñ∞Ë¶èÂèÇÂä†ËÄÖÂæÖÊ©ü) -->
    <div class="modal" id="newPlayerWaitingModal">
        <div class="modal-content modal-small">
            <h2 class="modal-title" style="color: var(--neon-cyan);">ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà</h2>
            <p style="text-align: center; margin: 20px 0; color: var(--text-color);">
                <span id="newPlayerName" style="color: var(--neon-green);"></span>„Åï„Çì„Åå<br>ÂèÇÊà¶„ÇíÊúõ„Çì„Åß„ÅÑ„Åæ„Åô
            </p>
            <div class="modal-buttons">
                <button class="btn" id="acceptPlayerBtn">Âèó„ÅëÂÖ•„Çå„Çã</button>
                <button class="btn btn-secondary" id="rejectPlayerBtn">ÊãíÂê¶„Åô„Çã</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // ==================== AUDIO SYSTEM ====================
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.bgmEnabled = true;
                this.seEnabled = true;
                this.bgmPlaying = false;
                this.bgmScheduler = null;
                this.bgmNodes = [];
                this.masterGain = null;
                this.bgmGain = null;
                this.initialized = false;
                this.bgmVolume = 0.3; // „Éá„Éï„Ç©„É´„Éà30%
                this.unlocked = false;
            }

            init() {
                if (this.initialized) return;
                
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Master gain
                this.masterGain = this.audioContext.createGain();
                this.masterGain.connect(this.audioContext.destination);
                this.masterGain.gain.value = 1.0;
                
                // BGM gain
                this.bgmGain = this.audioContext.createGain();
                this.bgmGain.connect(this.masterGain);
                this.bgmGain.gain.value = this.bgmVolume * 0.5; // 0.5„ÅØÂÜÖÈÉ®Ë™øÊï¥‰øÇÊï∞
                
                this.initialized = true;
                
                // iOS/„É¢„Éê„Ç§„É´Âêë„Åë„Ç¢„É≥„É≠„ÉÉ„ÇØÂá¶ÁêÜ
                this.unlockAudio();
            }
            
            // iOS/„É¢„Éê„Ç§„É´„Åß„Çπ„Éî„Éº„Ç´„Éº„Åã„ÇâÈü≥„ÇíÂá∫„Åô„Åü„ÇÅ„ÅÆ„Ç¢„É≥„É≠„ÉÉ„ÇØÂá¶ÁêÜ
            unlockAudio() {
                if (this.unlocked) return;
                
                // ÁÑ°Èü≥„ÇíÂÜçÁîü„Åó„Å¶„Ç™„Éº„Éá„Ç£„Ç™„Çí„Ç¢„É≥„É≠„ÉÉ„ÇØ
                const silentBuffer = this.audioContext.createBuffer(1, 1, 22050);
                const source = this.audioContext.createBufferSource();
                source.buffer = silentBuffer;
                source.connect(this.audioContext.destination);
                source.start(0);
                
                // iOS SafariÂØæÁ≠ñ: Á©∫„ÅÆHTML5 Audio„ÇÇÂÜçÁîü
                const silentAudio = new Audio();
                silentAudio.play().catch(() => {});
                
                this.unlocked = true;
            }

            resume() {
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                // ÂÜçÂ∫¶„Ç¢„É≥„É≠„ÉÉ„ÇØ„ÇíË©¶Ë°å
                if (this.audioContext && !this.unlocked) {
                    this.unlockAudio();
                }
            }

            // BGMÈü≥ÈáèË®≠ÂÆöÔºà0.0 ~ 1.0Ôºâ
            setBgmVolume(volume) {
                this.bgmVolume = Math.max(0, Math.min(1, volume));
                if (this.bgmGain) {
                    this.bgmGain.gain.value = this.bgmVolume * 0.5;
                }
                // Ë®≠ÂÆö„Çí‰øùÂ≠ò
                localStorage.setItem('linkedblocks_bgm_volume', this.bgmVolume);
            }

            getBgmVolume() {
                return this.bgmVolume;
            }

            playTone(frequency, duration, type = 'square', volume = 0.1) {
                if (!this.seEnabled) return;
                this.init();
                this.resume();
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                // SEÈü≥Èáè„ÇíÂ§ß„Åç„ÇÅ„Å´Ë®≠ÂÆöÔºàBGM„Å´Ë≤†„Åë„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
                const seVolume = volume * 2.5;
                gainNode.gain.setValueAtTime(seVolume, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playHover() {
                this.playTone(800, 0.05, 'sine', 0.05);
            }

            playClick() {
                this.playTone(600, 0.1, 'square', 0.1);
                setTimeout(() => this.playTone(900, 0.05, 'square', 0.08), 50);
            }

            playRegisterSuccess() {
                // „Éî„É≠„É≥‚ô™„Å®„ÅÑ„ÅÜÁôªÈå≤ÊàêÂäüÈü≥
                if (!this.seEnabled) return;
                this.init();
                this.resume();
                
                this.playTone(880, 0.15, 'sine', 0.1);
                setTimeout(() => this.playTone(1174, 0.2, 'sine', 0.12), 100);
            }

            playPlace() {
                this.playTone(400, 0.15, 'triangle', 0.12);
            }

            playTurnChange() {
                this.playTone(523, 0.1, 'sine', 0.1);
                setTimeout(() => this.playTone(659, 0.1, 'sine', 0.1), 100);
            }

            playWarning() {
                this.playTone(200, 0.2, 'sawtooth', 0.12);
            }

            playTimerBeep() {
                this.playTone(880, 0.1, 'square', 0.15);
            }

            playMatchReady() {
                if (!this.seEnabled) return;
                this.init();
                this.resume();
                
                const notes = [392, 523, 659, 784];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.2, 'sine', 0.08), i * 100);
                });
            }

            playWin() {
                if (!this.seEnabled) return;
                this.init();
                this.resume();
                
                const notes = [523, 659, 784, 1047];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.3, 'sine', 0.1), i * 150);
                });
            }

            playError() {
                this.playTone(150, 0.3, 'sawtooth', 0.08);
            }

            startBGM() {
                if (!this.bgmEnabled || this.bgmPlaying) return;

                this.init();
                this.resume();
                this.bgmPlaying = true;

                // MP3„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®„Åó„ÅüBGMÂÜçÁîü
                if (!this.bgmAudio) {
                    this.bgmAudio = new Audio('LINKED%20BLOCKS.mp3');
                    this.bgmAudio.loop = true;
                    this.bgmAudio.volume = this.bgmVolume;
                }

                this.bgmAudio.currentTime = 0;
                this.bgmAudio.play().catch(e => {
                    console.log('BGM play failed:', e);
                });
            }

            scheduleBGMNote(freq, startTime, duration, type, volume) {
                if (!this.bgmGain) return;
                
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(this.bgmGain);
                
                osc.frequency.value = freq;
                osc.type = type;
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(volume, startTime + 0.01);
                gain.gain.setValueAtTime(volume, startTime + duration - 0.02);
                gain.gain.linearRampToValueAtTime(0, startTime + duration);
                
                osc.start(startTime);
                osc.stop(startTime + duration);
                
                this.bgmNodes.push({ osc, gain });
                
                // Cleanup old nodes
                setTimeout(() => {
                    const index = this.bgmNodes.findIndex(n => n.osc === osc);
                    if (index > -1) this.bgmNodes.splice(index, 1);
                }, (startTime - this.audioContext.currentTime + duration + 0.5) * 1000);
            }

            stopBGM() {
                this.bgmPlaying = false;

                if (this.bgmScheduler) {
                    clearTimeout(this.bgmScheduler);
                    this.bgmScheduler = null;
                }

                // Stop all BGM nodes
                this.bgmNodes.forEach(({ osc, gain }) => {
                    try {
                        gain.gain.cancelScheduledValues(this.audioContext.currentTime);
                        gain.gain.setValueAtTime(0, this.audioContext.currentTime);
                        osc.stop(this.audioContext.currentTime + 0.05);
                    } catch (e) {}
                });
                this.bgmNodes = [];

                // MP3„ÅÆÂÅúÊ≠¢
                if (this.bgmAudio) {
                    this.bgmAudio.pause();
                    this.bgmAudio.currentTime = 0;
                }
            }

            toggleBGM() {
                this.init();
                this.resume();
                
                this.bgmEnabled = !this.bgmEnabled;
                
                if (this.bgmEnabled) {
                    this.startBGM();
                } else {
                    this.stopBGM();
                }
                
                // Save preference
                localStorage.setItem('linkedblocks_bgm', this.bgmEnabled);
                
                return this.bgmEnabled;
            }

            toggleSE() {
                this.init();
                this.resume();
                
                this.seEnabled = !this.seEnabled;
                
                // Save preference
                localStorage.setItem('linkedblocks_se', this.seEnabled);
                
                return this.seEnabled;
            }

            loadPreferences() {
                const bgmPref = localStorage.getItem('linkedblocks_bgm');
                const volumePref = localStorage.getItem('linkedblocks_bgm_volume');
                
                if (bgmPref !== null) this.bgmEnabled = bgmPref === 'true';
                if (volumePref !== null) this.bgmVolume = parseFloat(volumePref);
                
                // SE„ÅØÂ∏∏„Å´ON
                this.seEnabled = true;
                
                return { bgm: this.bgmEnabled, se: this.seEnabled, volume: this.bgmVolume };
            }
        }

        const audio = new AudioManager();

        // ==================== Â§öË®ÄË™û„Ç∑„Çπ„ÉÜ„É† ====================
        let currentLang = localStorage.getItem('linkedblocks_lang') || 'ja';
        
        const translations = {
            ja: {
                userName: 'USER NAME',
                userNamePlaceholder: 'ÂêçÂâç„ÇíÂÖ•Âäõ...',
                registerPlay: 'ÁôªÈå≤„Åó„Å¶„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã',
                guestPlay: '‚ñ∂ ÁôªÈå≤„Åó„Å™„ÅÑ„Åß„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã',
                cancelRegister: '„Ç≠„É£„É≥„Çª„É´„Åó„Å¶ÁôªÈå≤„Åô„Çã',
                guestMode: '‚úì „Ç≤„Çπ„Éà„É¢„Éº„Éâ',
                multiPlay: '„Éû„É´„ÉÅ„Éó„É¨„Ç§Ôºà2„Äú3‰∫∫Ôºâ',
                viewRules: '„É´„Éº„É´Ë™¨Êòé„ÇíË¶ã„Çã',
                viewRanking: '„É©„É≥„Ç≠„É≥„Ç∞„ÇíË¶ã„Çã',
                cpuBattle: 'CPUÂØæÊà¶',
                cpuLevel: 'CPU„É¨„Éô„É´',
                weak: 'Âº±',
                normal: 'ÊôÆÈÄö',
                strong: 'Âº∑',
                winLength: 'ÊèÉ„Åà„Çã„Éñ„É≠„ÉÉ„ÇØÊï∞',
                timer: '„Çø„Ç§„Éû„ÉºÔºàÁßíÔºâ',
                start: 'START',
                back: 'Êàª„Çã',
                quit: '‚úï ‰∏≠Êñ≠',
                rematch: 'ÂÜçÊà¶',
                toTitle: '„Çø„Ç§„Éà„É´„Å∏',
                winner: 'ÂãùËÄÖ',
                draw: 'Âºï„ÅçÂàÜ„Åë',
                gameSet: 'GAME SET!',
                introText: '„Éñ„É≠„ÉÉ„ÇØ„ÇíÂÖà„Å´ÊèÉ„Åà„Å¶ÂãùÂà©„Åõ„ÇàÔºÅ'
            },
            en: {
                userName: 'USER NAME',
                userNamePlaceholder: 'Enter name...',
                registerPlay: 'Register & Start',
                guestPlay: '‚ñ∂ Play as Guest',
                cancelRegister: 'Cancel & Register',
                guestMode: '‚úì Guest Mode',
                multiPlay: 'Multiplayer (2-3)',
                viewRules: 'View Rules',
                viewRanking: 'View Ranking',
                cpuBattle: 'CPU Battle',
                cpuLevel: 'CPU Level',
                weak: 'Easy',
                normal: 'Normal',
                strong: 'Hard',
                winLength: 'Blocks to Win',
                timer: 'Timer (sec)',
                start: 'START',
                back: 'Back',
                quit: '‚úï Quit',
                rematch: 'Rematch',
                toTitle: 'To Title',
                winner: 'WINNER',
                draw: 'DRAW',
                gameSet: 'GAME SET!',
                introText: 'Line up blocks first to win!'
            }
        };
        
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('linkedblocks_lang', lang);
            
            // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.getElementById('langJaBtn').classList.toggle('active', lang === 'ja');
            document.getElementById('langEnBtn').classList.toggle('active', lang === 'en');
            
            // „ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
            updateTexts();
        }
        
        function t(key) {
            return translations[currentLang][key] || key;
        }
        
        function updateTexts() {
            const lang = currentLang;
            const tr = translations[lang];
            
            // „Çø„Ç§„Éà„É´ÁîªÈù¢
            const userLabel = document.querySelector('#titleScreen .input-label');
            if (userLabel) userLabel.textContent = tr.userName;
            
            const userInput = document.getElementById('usernameInput');
            if (userInput) userInput.placeholder = tr.userNamePlaceholder;
            
            const registerBtn = document.getElementById('registerPlayBtn');
            if (registerBtn) {
                if (GameState.username === 'GUEST' && !GameState.isRegistered) {
                    registerBtn.textContent = tr.cancelRegister;
                } else {
                    registerBtn.textContent = tr.registerPlay;
                }
            }
            
            const guestBtn = document.getElementById('guestPlayBtn');
            if (guestBtn) {
                if (GameState.username === 'GUEST' && !GameState.isRegistered) {
                    guestBtn.textContent = tr.guestMode;
                } else {
                    guestBtn.textContent = tr.guestPlay;
                }
            }
            
            document.getElementById('localPlayBtn').textContent = tr.multiPlay;
            document.getElementById('rulesBtn').textContent = tr.viewRules;
            document.getElementById('rankingBtn').textContent = tr.viewRanking;
            
            // CPUÂØæÊà¶ÁîªÈù¢
            const soloTitle = document.querySelector('#soloSetupScreen .title');
            if (soloTitle) soloTitle.textContent = tr.cpuBattle;
            
            const cpuLabel = document.querySelector('#soloSetupScreen .input-label');
            if (cpuLabel) cpuLabel.textContent = tr.cpuLevel;
            
            document.querySelectorAll('.cpu-level').forEach(btn => {
                const level = btn.dataset.level;
                if (level === 'weak') btn.textContent = tr.weak;
                if (level === 'normal') btn.textContent = tr.normal;
                if (level === 'strong') btn.textContent = tr.strong;
            });
            
            document.getElementById('startSoloBtn').textContent = tr.start;
            document.getElementById('backFromSoloBtn').textContent = tr.back;
            
            // „Ç§„É≥„Éà„É≠„ÉÜ„Ç≠„Çπ„Éà
            const introText = document.getElementById('introText');
            if (introText) introText.textContent = tr.introText;
        }

        // ==================== GAME STATE ====================
        const GameState = {
            // User data
            username: null,
            isRegistered: false,
            deviceId: null,
            
            // Game settings
            gameMode: null, // 'solo', 'local', 'multi'
            cpuLevel: 'normal',
            winLength: 4,
            timerSetting: 0,
            multiTimerSetting: '30', // „Éû„É´„ÉÅ„Éó„É¨„Ç§Áî®„Çø„Ç§„Éû„ÉºË®≠ÂÆö
            playerCount: 2,
            
            // Board state
            boardSize: 7,
            board: [],
            currentPlayer: 0,
            players: [],
            gameActive: false,
            isPlacing: false, // „Éñ„É≠„ÉÉ„ÇØÈÖçÁΩÆ‰∏≠„Éï„É©„Ç∞ÔºàÈÄ£Á∂ö„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢Ôºâ
            
            // Timer
            timeLeft: 0,
            timerInterval: null,
            
            // Rankings (localStorage)
            rankings: []
        };

        // ==================== DEVICE IDENTIFICATION ====================
        /**
         * „Éá„Éê„Ç§„ÇπË≠òÂà•„Ç∑„Çπ„ÉÜ„É†
         * - „Éá„Éê„Ç§„Çπ„Åî„Å®„Å´‰∏ÄÊÑè„ÅÆUUID„ÇíÁîüÊàê„Éª‰øùÂ≠ò
         * - „É¶„Éº„Ç∂„ÉºÂêç„Å®„Éá„Éê„Ç§„ÇπID„ÇíÁ¥ê‰ªò„Åë„Å¶ÁÆ°ÁêÜ
         * - „Çµ„Éº„Éê„Éº„Å™„Åó„ÅÆ„É≠„Éº„Ç´„É´Ë™çË®º
         */
        const DeviceAuth = {
            // „Éá„Éê„Ç§„ÇπID„ÇíÂèñÂæó„Åæ„Åü„ÅØÁîüÊàê
            getDeviceId() {
                let deviceId = localStorage.getItem('linkedblocks_device_id');
                if (!deviceId) {
                    deviceId = this.generateUUID();
                    localStorage.setItem('linkedblocks_device_id', deviceId);
                }
                return deviceId;
            },
            
            // UUIDÁîüÊàê
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },
            
            // „É¶„Éº„Ç∂„ÉºÁôªÈå≤„Åæ„Åü„ÅØ„É≠„Ç∞„Ç§„É≥ÔºàFirebaseÈÄ£Êê∫Ôºâ- „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Çº„É≥„Çπ‰ªò„Åç
            async registerUser(username) {
                const deviceId = this.getDeviceId();
                const sanitizedName = this.sanitizeUsername(username);
                
                try {
                    // Firebase„Åß„É¶„Éº„Ç∂„ÉºÁ¢∫Ë™ç
                    const snapshot = await database.ref('users/' + sanitizedName).once('value');
                    
                    if (snapshot.exists()) {
                        const existingUser = snapshot.val();
                        
                        // ‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„Åå„Ç™„É≥„É©„Ç§„É≥„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                        if (existingUser.online && existingUser.deviceId !== deviceId) {
                            return { success: false, error: '„Åì„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÅØÁèæÂú®‰ΩøÁî®‰∏≠„Åß„Åô' };
                        }
                        
                        // „É≠„Ç∞„Ç§„É≥„Å®„Åó„Å¶Êâ±„ÅÜ
                        await database.ref('users/' + sanitizedName).update({
                            deviceId: deviceId,
                            online: true,
                            lastLogin: Date.now()
                        });
                    } else {
                        // Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÁôªÈå≤
                        await database.ref('users/' + sanitizedName).set({
                            username: username,
                            deviceId: deviceId,
                            online: true,
                            createdAt: Date.now(),
                            lastLogin: Date.now()
                        });
                    }
                    
                    // ÂàáÊñ≠ÊôÇ„Å´„Ç™„Éï„É©„Ç§„É≥„Å´„Åô„ÇãÔºàFirebase onDisconnectÔºâ
                    database.ref('users/' + sanitizedName + '/online').onDisconnect().set(false);
                    
                    // „É≠„Éº„Ç´„É´„Å´„ÇÇ‰øùÂ≠ò
                    this.saveLocalUser(username, deviceId);
                    
                    // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„Çí‰øùÂ≠òÔºà„É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜÁî®Ôºâ
                    this.currentUsername = sanitizedName;
                    
                    return { success: true, deviceId: deviceId, isLogin: snapshot.exists() };
                } catch (error) {
                    console.error('Registration error:', error);
                    return { success: false, error: 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' };
                }
            },
            
            // „É≠„Ç∞„Ç¢„Ç¶„ÉàÔºà„Ç™„Éï„É©„Ç§„É≥„Å´Ë®≠ÂÆöÔºâ
            async logout() {
                if (this.currentUsername) {
                    try {
                        await database.ref('users/' + this.currentUsername + '/online').set(false);
                    } catch (e) {
                        console.error('Logout error:', e);
                    }
                    this.currentUsername = null;
                }
            },
            
            // ÁèæÂú®„É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç
            currentUsername: null,
            
            // „É≠„Éº„Ç´„É´„Å´„É¶„Éº„Ç∂„Éº‰øùÂ≠ò
            saveLocalUser(username, deviceId) {
                const users = this.getUsers();
                const existingIndex = users.findIndex(u => u.username === username);
                
                if (existingIndex >= 0) {
                    users[existingIndex].deviceId = deviceId;
                } else {
                    users.push({
                        username: username,
                        deviceId: deviceId,
                        createdAt: Date.now()
                    });
                }
                
                localStorage.setItem('linkedblocks_users', JSON.stringify(users));
                localStorage.setItem('linkedblocks_current_user', username);
            },
            
            // „É¶„Éº„Ç∂„ÉºÂêç„ÇíFirebase„Ç≠„Éº„Å®„Åó„Å¶‰ΩøÁî®ÂèØËÉΩ„Å™ÂΩ¢Âºè„Å´Â§âÊèõ
            sanitizeUsername(username) {
                return username.replace(/[.#$[\]]/g, '_');
            },
            
            // ÁôªÈå≤Ê∏à„Åø„É¶„Éº„Ç∂„Éº„Åß„É≠„Ç∞„Ç§„É≥
            loginUser(username) {
                const deviceId = this.getDeviceId();
                const users = this.getUsers();
                
                const user = users.find(u => u.username === username && u.deviceId === deviceId);
                if (user) {
                    localStorage.setItem('linkedblocks_current_user', username);
                    return { success: true };
                }
                
                return { success: false, error: '„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' };
            },
            
            // ÂâçÂõû„ÅÆ„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó
            getLastUser() {
                return localStorage.getItem('linkedblocks_current_user');
            },
            
            // ÁôªÈå≤„É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„ÇíÂèñÂæó
            getUsers() {
                const saved = localStorage.getItem('linkedblocks_users');
                return saved ? JSON.parse(saved) : [];
            },
            
            // „Åì„ÅÆ„Éá„Éê„Ç§„Çπ„ÅÆÁôªÈå≤„É¶„Éº„Ç∂„Éº‰∏ÄË¶ß
            getDeviceUsers() {
                const deviceId = this.getDeviceId();
                return this.getUsers().filter(u => u.deviceId === deviceId);
            },
            
            // „É¶„Éº„Ç∂„Éº„ÅåÁôªÈå≤Ê∏à„Åø„ÅãÁ¢∫Ë™ç
            isRegistered(username) {
                const deviceId = this.getDeviceId();
                return this.getUsers().some(u => u.username === username && u.deviceId === deviceId);
            }
        };

        // Firebase„Åã„ÇâÂèó„ÅëÂèñ„Å£„Åü„Éú„Éº„Éâ„Éá„Éº„Çø„Çí2Ê¨°ÂÖÉÈÖçÂàó„Å´Â§âÊèõ
        function convertFirebaseBoard(data) {
            if (!data) return null;
            
            const size = GameState.boardSize || 7;
            const board = [];
            
            for (let y = 0; y < size; y++) {
                const row = [];
                for (let x = 0; x < size; x++) {
                    let cell = null;
                    
                    if (data[y] !== undefined && data[y] !== null) {
                        if (Array.isArray(data[y])) {
                            cell = data[y][x];
                        } else if (typeof data[y] === 'object') {
                            cell = data[y][x];
                        }
                    }
                    
                    // null, undefined‰ª•Â§ñ„ÅÆÊï∞ÂÄ§„ÅÆ„ÅøÊúâÂäπ
                    row[x] = (cell !== null && cell !== undefined && typeof cell === 'number') ? cell : null;
                }
                board[y] = row;
            }
            
            return board;
        }

        // ==================== SYNC LAYER (FIREBASE IMPLEMENTATION) ====================
        /**
         * Firebase Realtime Database „Çí‰ΩøÁî®„Åó„Åü„Éû„É´„ÉÅ„Éó„É¨„Ç§ÂêåÊúü
         */
        const SyncLayer = {
            isOnline: true,
            roomId: null,
            roomRef: null,
            playerIndex: null,
            listeners: {},
            heartbeatInterval: null,
            
            // „É´„Éº„É†„Å´Êé•Á∂ö
            async connect(roomId) {
                this.roomId = roomId;
                this.roomRef = database.ref('rooms/' + roomId);
                
                try {
                    const snapshot = await this.roomRef.once('value');
                    const roomData = snapshot.val();
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà30Áßí‰ª•ÂÜÖ„Å´lastActive„Åå„ÅÇ„Çã„ÅãÔºâ
                    const hasActivePlayers = roomData && roomData.players && roomData.players.some(p => {
                        if (!p || !p.online) return false;
                        // lastActive„Åå30Áßí‰ª•ÂÜÖ„Å™„Çâ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å®„Åø„Å™„Åô
                        if (p.lastActive && (Date.now() - p.lastActive < 30000)) return true;
                        return false;
                    });
                    
                    // „É´„Éº„É†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØÂè§„ÅÑ„É´„Éº„É†Ôºà1ÊôÇÈñì‰ª•‰∏äÂâçÔºâ„ÄÅ„Åæ„Åü„ÅØ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Å™„ÅÑ„Å™„Çâ„É™„Çª„ÉÉ„Éà
                    const shouldCreateNew = !roomData || 
                        (Date.now() - roomData.createdAt > 60 * 60 * 1000) ||
                        !hasActivePlayers;
                    
                    if (shouldCreateNew) {
                        // Êñ∞Ë¶è„É´„Éº„É†‰ΩúÊàêÔºà„Åæ„Åü„ÅØÂè§„ÅÑ„É´„Éº„É†„Çí„É™„Çª„ÉÉ„ÉàÔºâ
                        this.playerIndex = 0;
                        await this.roomRef.set({
                            createdAt: Date.now(),
                            status: 'waiting',
                            players: [{
                                name: GameState.username || 'PLAYER 1',
                                index: 0,
                                online: true,
                                lastActive: Date.now()
                            }],
                            currentPlayer: 0,
                            board: [],
                            winLength: GameState.winLength,
                            timerSetting: GameState.multiTimerSetting || '30',
                            settings: {
                                winLength: GameState.winLength,
                                timer: GameState.multiTimerSetting || '30'
                            }
                        });
                    } else {
                        // Êó¢Â≠ò„É´„Éº„É†„Å´ÂèÇÂä†
                        const players = roomData.players || [];
                        
                        // „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„ÉºÊï∞„Çí„Ç´„Ç¶„É≥„Éà
                        const onlinePlayers = players.filter(p => p && p.online);
                        
                        if (onlinePlayers.length >= 3) {
                            throw new Error('„É´„Éº„É†„ÅåÊ∫ÄÂì°„Åß„Åô');
                        }
                        
                        // Âêå„Åò„É¶„Éº„Ç∂„ÉºÂêç„ÅÆ„Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                        const myName = GameState.username || 'GUEST';
                        const duplicateName = onlinePlayers.find(p => p.name === myName);
                        if (duplicateName) {
                            throw new Error('Âêå„Åò„É¶„Éº„Ç∂„ÉºÂêç„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅåÊó¢„Å´„É´„Éº„É†„Å´„ÅÑ„Åæ„Åô');
                        }
                        
                        // „Ç≤„Éº„É†ÈÄ≤Ë°å‰∏≠„Åæ„Åü„ÅØ„É´„Éº„É¨„ÉÉ„Éà‰∏≠„ÅÆÂ†¥Âêà„ÅØË¶≥Êà¶ËÄÖ„Å®„Åó„Å¶ÂæÖÊ©ü
                        if (roomData.status === 'playing' || roomData.status === 'roulette') {
                            // Á©∫„Åç„Åå„ÅÇ„Çå„Å∞Ë¶≥Êà¶ËÄÖ„Å®„Åó„Å¶ÁôªÈå≤
                            if (onlinePlayers.length < 3) {
                                // Ë¶≥Êà¶ËÄÖ„Å®„Åó„Å¶ÁôªÈå≤
                                await this.roomRef.child('spectators/' + myName).set({
                                    name: myName,
                                    timestamp: Date.now()
                                });
                                
                                return { success: true, playerIndex: -1, spectator: true };
                            } else {
                                throw new Error('„É´„Éº„É†„ÅåÊ∫ÄÂì°„Åß„Åô');
                            }
                        }
                        
                        // „Ç≤„Éº„É†ÁµÇ‰∫ÜÂæåÔºàÂÜçÊà¶ÂæÖÊ©ü‰∏≠Ôºâ„ÅÆÂ†¥Âêà„ÅØÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
                        if (roomData.status === 'ended') {
                            await this.roomRef.child('pendingPlayer').set({
                                name: myName,
                                timestamp: Date.now()
                            });
                            
                            // ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà„ÅÆÊâøË™ç„ÇíÂæÖ„Å§
                            return { success: true, playerIndex: -1, pending: true };
                        }
                        
                        // Á©∫„Åç„Çπ„É≠„ÉÉ„Éà„ÇíÊé¢„ÅôÔºà„Ç™„Éï„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„ÅÆ‰ΩçÁΩÆ„ÇíÂÜçÂà©Áî®Ôºâ
                        let slotIndex = players.findIndex(p => !p || !p.online);
                        if (slotIndex === -1) {
                            slotIndex = players.length;
                        }
                        
                        this.playerIndex = slotIndex;
                        
                        // „Éó„É¨„Ç§„É§„Éº„ÇíËøΩÂä†„Åæ„Åü„ÅØÊõ¥Êñ∞
                        players[slotIndex] = {
                            name: GameState.username || ('PLAYER ' + (slotIndex + 1)),
                            index: slotIndex,
                            online: true,
                            lastActive: Date.now()
                        };
                        
                        await this.roomRef.update({ players });
                        
                        // ÂÜçÊà¶ÂæÖÊ©ü‰∏≠„ÅÆÂ†¥Âêà„ÄÅËá™ÂãïÁöÑ„Å´rematchReady„ÇíË®≠ÂÆö
                        if (roomData.rematchReady) {
                            await this.roomRef.child('rematchReady/' + slotIndex).set(true);
                        }
                    }
                    
                    // ÂàáÊñ≠ÊôÇ„ÅÆÂá¶ÁêÜ„ÇíË®≠ÂÆö
                    this.roomRef.child('players/' + this.playerIndex + '/online').onDisconnect().set(false);
                    
                    // ÂÆöÊúüÁöÑ„Å´lastActive„ÇíÊõ¥Êñ∞Ôºà„Éè„Éº„Éà„Éì„Éº„ÉàÔºâ
                    this.heartbeatInterval = setInterval(() => {
                        if (this.roomRef && this.playerIndex !== null) {
                            this.roomRef.child('players/' + this.playerIndex + '/lastActive').set(Date.now());
                        }
                    }, 10000); // 10Áßí„Åî„Å®
                    
                    // „É™„Çπ„Éä„ÉºË®≠ÂÆö
                    this.setupListeners();
                    
                    return { success: true, playerIndex: this.playerIndex };
                } catch (error) {
                    console.error('Room connection error:', error);
                    return { success: false, error: error.message };
                }
            },
            
            // „É™„Çπ„Éä„ÉºË®≠ÂÆö
            setupListeners() {
                // „Éó„É¨„Ç§„É§„ÉºÂèÇÂä†/ÈÄÄÂ∏≠Áõ£Ë¶ñ
                this.roomRef.child('players').on('value', (snapshot) => {
                    const players = snapshot.val() || [];
                    if (this.listeners.onPlayersUpdate) {
                        this.listeners.onPlayersUpdate(players);
                    }
                    
                    // „Ç™„Éï„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    players.forEach((player, index) => {
                        if (player && !player.online && this.listeners.onPlayerLeave) {
                            this.listeners.onPlayerLeave(player, index);
                        }
                    });
                });
                
                // Êâã„ÅÆÁõ£Ë¶ñ
                this.roomRef.child('lastMove').on('value', (snapshot) => {
                    const move = snapshot.val();
                    if (move && move.playerIndex !== this.playerIndex && this.listeners.onMove) {
                        this.listeners.onMove(move);
                    }
                });
                
                // „Ç≤„Éº„É†Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ
                this.roomRef.child('status').on('value', (snapshot) => {
                    const status = snapshot.val();
                    if (this.listeners.onStatusChange) {
                        this.listeners.onStatusChange(status);
                    }
                });
                
                // „Éú„Éº„ÉâÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
                this.roomRef.child('board').on('value', (snapshot) => {
                    const board = snapshot.val();
                    if (board && this.listeners.onBoardUpdate) {
                        this.listeners.onBoardUpdate(board);
                    }
                });
                
                // ÁèæÂú®„ÅÆ„Çø„Éº„É≥Áõ£Ë¶ñ
                this.roomRef.child('currentPlayer').on('value', (snapshot) => {
                    const currentPlayer = snapshot.val();
                    if (currentPlayer !== null && this.listeners.onTurnChange) {
                        this.listeners.onTurnChange(currentPlayer);
                    }
                });
                
                // ÂãùËÄÖÁõ£Ë¶ñÔºàÂãùÂà©„Çª„É´ÊÉÖÂ†±„ÇÇÂèñÂæóÔºâ
                this.roomRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.winner !== null && data.winner !== undefined && this.listeners.onGameEnd) {
                        this.listeners.onGameEnd(data.winner, data.winCells);
                    }
                });
                
                // ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„ÉàÁõ£Ë¶ñ
                this.roomRef.child('pendingPlayer').on('value', (snapshot) => {
                    const pending = snapshot.val();
                    if (pending && this.listeners.onPendingPlayer) {
                        this.listeners.onPendingPlayer(pending);
                    }
                });
                
                // ÂÜçÊà¶Ê∫ñÂÇôÁä∂ÊÖãÁõ£Ë¶ñ
                this.roomRef.child('rematchReady').on('value', (snapshot) => {
                    const rematchReady = snapshot.val();
                    if (this.listeners.onRematchUpdate) {
                        this.listeners.onRematchUpdate(rematchReady);
                    }
                });
            },
            
            // ÂàáÊñ≠
            disconnect() {
                // „Éè„Éº„Éà„Éì„Éº„Éà„ÇíÂÅúÊ≠¢
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
                
                if (this.roomRef) {
                    this.roomRef.child('players').off();
                    this.roomRef.child('lastMove').off();
                    this.roomRef.child('status').off();
                    this.roomRef.child('board').off();
                    this.roomRef.child('currentPlayer').off();
                    this.roomRef.child('pendingPlayer').off();
                    this.roomRef.child('rematchReady').off();
                    this.roomRef.off(); // „É´„Éº„É†ÂÖ®‰Ωì„ÅÆ„É™„Çπ„Éä„Éº„ÇÇËß£Èô§
                    
                    // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                    if (this.playerIndex !== null) {
                        this.roomRef.child('players/' + this.playerIndex + '/online').set(false);
                    }
                }
                this.roomRef = null;
                this.roomId = null;
                this.playerIndex = null;
            },
            
            // Êâã„ÇíÈÄÅ‰ø°
            async sendMove(x, y, playerIndex) {
                if (!this.roomRef) return;
                
                await this.roomRef.child('lastMove').set({
                    x, y,
                    playerIndex,
                    timestamp: Date.now()
                });
            },
            
            // „Éú„Éº„ÉâÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            async updateBoard(board) {
                if (!this.roomRef) return;
                await this.roomRef.child('board').set(board);
            },
            
            // „Çø„Éº„É≥„ÇíÊõ¥Êñ∞
            async updateTurn(playerIndex) {
                if (!this.roomRef) return;
                await this.roomRef.child('currentPlayer').set(playerIndex);
            },
            
            // „Ç≤„Éº„É†ÈñãÂßãÔºà„É©„É≥„ÉÄ„É†È†ÜÁï™Ê±∫ÂÆöÔºâ
            async startGame(settings) {
                if (!this.roomRef) return;
                const boardSize = settings.winLength + 3;
                
                // „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„ÉºÊï∞„ÇíÂèñÂæó„Åó„Å¶„É©„É≥„ÉÄ„É†„Å™ÈñãÂßã„Éó„É¨„Ç§„É§„Éº„ÇíÊ±∫ÂÆö
                const snapshot = await this.roomRef.child('players').once('value');
                const players = snapshot.val() || [];
                const onlineIndices = players
                    .map((p, i) => p && p.online ? i : -1)
                    .filter(i => i >= 0);
                
                // „É©„É≥„ÉÄ„É†„Å´ÈñãÂßã„Éó„É¨„Ç§„É§„Éº„ÇíÈÅ∏Êäû
                const randomStartPlayer = onlineIndices[Math.floor(Math.random() * onlineIndices.length)];
                
                await this.roomRef.update({
                    status: 'roulette', // „Åæ„Åö„É´„Éº„É¨„ÉÉ„ÉàÁä∂ÊÖã„Å´
                    board: Array(boardSize).fill(null).map(() => Array(boardSize).fill(null)),
                    boardSize: boardSize,
                    currentPlayer: randomStartPlayer,
                    winLength: settings.winLength,
                    timerSetting: settings.timer || 'none',
                    startedAt: Date.now(),
                    spectators: null // Ë¶≥Êà¶ËÄÖ„Çí„É™„Çª„ÉÉ„Éà
                });
                
                // 2ÁßíÂæå„Å´„Éó„É¨„Ç§„É≥„Ç∞Áä∂ÊÖã„Å´
                setTimeout(async () => {
                    await this.roomRef.child('status').set('playing');
                }, 3000);
            },
            
            // „Ç≤„Éº„É†ÁµÇ‰∫Ü
            async endGame(winner, winCells = null) {
                if (!this.roomRef) return;
                await this.roomRef.update({
                    status: 'ended',
                    winner: winner,
                    winCells: winCells,
                    endedAt: Date.now(),
                    rematchReady: {} // ÂÜçÊà¶Ê∫ñÂÇôÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                });
            },
            
            // ÂÜçÊà¶Ê∫ñÂÇôÔºàËá™ÂàÜ„ÅåÂÜçÊà¶„Éú„Çø„É≥„ÇíÊäº„Åó„ÅüÔºâ
            async setRematchReady() {
                if (!this.roomRef || this.playerIndex === null) return;
                await this.roomRef.child('rematchReady/' + this.playerIndex).set(true);
            },
            
            // ÂÜçÊà¶Ê∫ñÂÇô„Çí„Ç≠„É£„É≥„Çª„É´
            async cancelRematchReady() {
                if (!this.roomRef || this.playerIndex === null) return;
                await this.roomRef.child('rematchReady/' + this.playerIndex).remove();
                await this.roomRef.child('players/' + this.playerIndex + '/online').set(false);
            },
            
            // ÂÜçÊà¶ÈñãÂßãÔºà„Éõ„Çπ„Éà„ÅåÊâãÂãï„ÅßÂëº„Å≥Âá∫„ÅôÔºâ
            async startRematch() {
                if (!this.roomRef) return;
                
                const snapshot = await this.roomRef.once('value');
                const roomData = snapshot.val();
                const boardSize = (roomData.winLength || 4) + 3;
                
                const players = roomData.players || [];
                const rematchReady = roomData.rematchReady || {};
                
                console.log('startRematch - players:', players);
                console.log('startRematch - rematchReady:', rematchReady);
                
                // Ê∫ñÂÇôÂÆå‰∫ÜËÄÖ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæóÔºàFirebase„ÅÆ„Ç≠„Éº„ÅØÊñáÂ≠óÂàó„Å™„ÅÆ„Åß‰∏°Êñπ„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                const readyIndices = [];
                for (let i = 0; i < players.length; i++) {
                    if (players[i] && players[i].online) {
                        // ÊñáÂ≠óÂàó„Ç≠„Éº„Å®Êï∞ÂÄ§„Ç≠„Éº„ÅÆ‰∏°Êñπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                        if (rematchReady[i] === true || rematchReady[String(i)] === true) {
                            readyIndices.push(i);
                        }
                    }
                }
                
                console.log('startRematch - readyIndices:', readyIndices);
                
                if (readyIndices.length < 2) {
                    console.log('startRematch - 2‰∫∫Êú™Ê∫Ä„ÅÆ„Åü„ÇÅÈñãÂßã„Åß„Åç„Åæ„Åõ„Çì');
                    return;
                }
                
                // Ê∫ñÂÇôÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Å™„ÅÑ„Éó„É¨„Ç§„É§„Éº„Çí„Ç™„Éï„É©„Ç§„É≥„Å´„Åô„Çã
                for (let i = 0; i < players.length; i++) {
                    if (players[i] && players[i].online && !readyIndices.includes(i)) {
                        players[i].online = false;
                    }
                }
                
                const randomStartPlayer = readyIndices[Math.floor(Math.random() * readyIndices.length)];
                
                await this.roomRef.update({
                    players: players,
                    status: 'roulette',
                    board: Array(boardSize).fill(null).map(() => Array(boardSize).fill(null)),
                    boardSize: boardSize,
                    currentPlayer: randomStartPlayer,
                    startedAt: Date.now(),
                    rematchReady: null,
                    winner: null,
                    winCells: null,
                    spectators: null
                });
                
                setTimeout(async () => {
                    await this.roomRef.child('status').set('playing');
                }, 3000);
            },
            
            // ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°ÔºàÊñ∞Ë¶èÂèÇÂä†ËÄÖ„Åå‰ΩøÁî®Ôºâ
            async requestJoin(playerName) {
                if (!this.roomRef) return;
                await this.roomRef.child('pendingPlayer').set({
                    name: playerName,
                    timestamp: Date.now()
                });
            },
            
            // ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà„ÇíÊâøË™ç
            async acceptPendingPlayer() {
                if (!this.roomRef) return;
                const snapshot = await this.roomRef.child('pendingPlayer').once('value');
                const pending = snapshot.val();
                if (!pending) return false;
                
                // Á©∫„Åç„Çπ„É≠„ÉÉ„Éà„ÇíÊé¢„Åô
                const playersSnapshot = await this.roomRef.child('players').once('value');
                const players = playersSnapshot.val() || [];
                
                let slotIndex = players.findIndex(p => !p || !p.online);
                if (slotIndex === -1 && players.length < 3) {
                    slotIndex = players.length;
                }
                
                if (slotIndex === -1) return false;
                
                // „Éó„É¨„Ç§„É§„Éº„ÇíËøΩÂä†
                players[slotIndex] = {
                    name: pending.name,
                    index: slotIndex,
                    online: true
                };
                
                await this.roomRef.update({
                    players: players,
                    pendingPlayer: null
                });
                
                return true;
            },
            
            // ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà„ÇíÊãíÂê¶
            async rejectPendingPlayer() {
                if (!this.roomRef) return;
                await this.roomRef.child('pendingPlayer').set(null);
            },
            
            // „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„ÉºÊï∞„ÇíÂèñÂæó
            async getOnlinePlayerCount() {
                if (!this.roomRef) return 0;
                const snapshot = await this.roomRef.child('players').once('value');
                const players = snapshot.val() || [];
                return players.filter(p => p && p.online).length;
            },
            
            // „É´„Éº„É†ÂâäÈô§
            async deleteRoom() {
                if (!this.roomRef) return;
                await this.roomRef.remove();
                this.disconnect();
            },
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÁôªÈå≤
            onMove(callback) { this.listeners.onMove = callback; },
            onPlayersUpdate(callback) { this.listeners.onPlayersUpdate = callback; },
            onPlayerLeave(callback) { this.listeners.onPlayerLeave = callback; },
            onStatusChange(callback) { this.listeners.onStatusChange = callback; },
            onBoardUpdate(callback) { this.listeners.onBoardUpdate = callback; },
            onTurnChange(callback) { this.listeners.onTurnChange = callback; },
            onGameEnd(callback) { this.listeners.onGameEnd = callback; },
            onPendingPlayer(callback) { this.listeners.onPendingPlayer = callback; },
            onRematchUpdate(callback) { this.listeners.onRematchUpdate = callback; },
            
            // Ëá™ÂàÜ„Åå„Éõ„Çπ„Éà„Åã„Å©„ÅÜ„ÅãÔºà„Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„ÅÆ‰∏≠„ÅßÊúÄÂ∞è„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºâ
            async isHost() {
                if (!this.roomRef || this.playerIndex === null) return false;
                
                const snapshot = await this.roomRef.child('players').once('value');
                const players = snapshot.val() || [];
                
                // „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó
                const onlineIndices = [];
                players.forEach((p, i) => {
                    if (p && p.online) {
                        onlineIndices.push(i);
                    }
                });
                
                if (onlineIndices.length === 0) return false;
                
                // ÊúÄÂ∞è„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅåËá™ÂàÜ„Å™„Çâ„Éõ„Çπ„Éà
                const minIndex = Math.min(...onlineIndices);
                return this.playerIndex === minIndex;
            }
        };

        // ==================== FIREBASE RANKING SYSTEM ====================
        const FirebaseRanking = {
            // „ÇΩ„É≠„É©„É≥„Ç≠„É≥„Ç∞„Å´ÂãùÂà©„ÇíËøΩÂä†
            async addSoloWin(username) {
                if (!username) return;
                
                const rankingRef = database.ref('rankings/solo/' + this.sanitizeUsername(username));
                const snapshot = await rankingRef.once('value');
                const current = snapshot.val() || { wins: 0 };
                
                await rankingRef.set({
                    name: username,
                    wins: current.wins + 1,
                    lastWin: Date.now()
                });
            },
            
            // „Éû„É´„ÉÅ„É©„É≥„Ç≠„É≥„Ç∞„Å´ÂãùÂà©„ÇíËøΩÂä†
            async addMultiWin(username) {
                if (!username) return;
                
                const rankingRef = database.ref('rankings/multi/' + this.sanitizeUsername(username));
                const snapshot = await rankingRef.once('value');
                const current = snapshot.val() || { wins: 0 };
                
                await rankingRef.set({
                    name: username,
                    wins: current.wins + 1,
                    lastWin: Date.now()
                });
            },
            
            // „ÇΩ„É≠„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó
            async getSoloRankings(limit = 10) {
                const snapshot = await database.ref('rankings/solo')
                    .orderByChild('wins')
                    .limitToLast(limit)
                    .once('value');
                
                const rankings = [];
                snapshot.forEach(child => {
                    rankings.push(child.val());
                });
                
                return rankings.sort((a, b) => b.wins - a.wins);
            },
            
            // „Éû„É´„ÉÅ„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó
            async getMultiRankings(limit = 10) {
                const snapshot = await database.ref('rankings/multi')
                    .orderByChild('wins')
                    .limitToLast(limit)
                    .once('value');
                
                const rankings = [];
                snapshot.forEach(child => {
                    rankings.push(child.val());
                });
                
                return rankings.sort((a, b) => b.wins - a.wins);
            },
            
            // „É¶„Éº„Ç∂„ÉºÂêç„ÇíFirebase„Ç≠„Éº„Å®„Åó„Å¶‰ΩøÁî®ÂèØËÉΩ„Å™ÂΩ¢Âºè„Å´Â§âÊèõ
            sanitizeUsername(username) {
                return username.replace(/[.#$[\]]/g, '_');
            }
        };
        
        // ==================== FIREBASE USER MANAGEMENT ====================
        const FirebaseUsers = {
            // „É¶„Éº„Ç∂„ÉºÁôªÈå≤„ÇíFirebase„Å´‰øùÂ≠ò
            async registerUser(username) {
                if (!username) return;
                
                const userRef = database.ref('users/' + this.sanitizeUsername(username));
                const snapshot = await userRef.once('value');
                
                // Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„Åß„Å™„Åë„Çå„Å∞Êñ∞Ë¶èÁôªÈå≤
                if (!snapshot.exists()) {
                    await userRef.set({
                        name: username,
                        registeredAt: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            },
            
            // ÂÖ®„É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„ÇíÂèñÂæó
            async getAllUsers() {
                const snapshot = await database.ref('users').once('value');
                const users = [];
                
                snapshot.forEach(child => {
                    users.push(child.val());
                });
                
                return users;
            },
            
            // Êó•ÊôÇ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàÊõúÊó•‰ªò„ÅçÔºâ
            formatDateTime(timestamp) {
                const date = new Date(timestamp);
                const weekdays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = weekdays[date.getDay()];
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}Âπ¥${month}Êúà${day}Êó•(${weekday}) ${hours}:${minutes}ÂàÜ`;
            },
            
            // „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„ÇíË°®Á§∫Áî®„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅßÂèñÂæó
            async getUsersFormatted(sortOrder = 'asc') {
                const users = await this.getAllUsers();
                
                // „ÇΩ„Éº„Éà
                users.sort((a, b) => {
                    if (sortOrder === 'asc') {
                        return a.registeredAt - b.registeredAt;
                    } else {
                        return b.registeredAt - a.registeredAt;
                    }
                });
                
                // „Éï„Ç©„Éº„Éû„ÉÉ„Éà
                return users.map(user => ({
                    name: user.name,
                    registeredAt: this.formatDateTime(user.registeredAt)
                }));
            },
            
            // „ÉÜ„Ç≠„Çπ„ÉàÂΩ¢Âºè„ÅßÂá∫Âäõ
            async exportUsersText(sortOrder = 'asc') {
                const users = await this.getUsersFormatted(sortOrder);
                
                let text = `LINKED BLOCKS ÁôªÈå≤„É¶„Éº„Ç∂„Éº‰∏ÄË¶ß\n`;
                text += `Âá∫ÂäõÊó•ÊôÇÔºö${this.formatDateTime(Date.now())}\n`;
                text += `Á∑è„É¶„Éº„Ç∂„ÉºÊï∞Ôºö${users.length}Âêç\n`;
                text += `‰∏¶„Å≥È†ÜÔºö${sortOrder === 'asc' ? 'ÁôªÈå≤Êó•ÊôÇ ÊòáÈ†Ü' : 'ÁôªÈå≤Êó•ÊôÇ ÈôçÈ†Ü'}\n`;
                text += `\n${'='.repeat(40)}\n\n`;
                
                users.forEach((user, index) => {
                    text += `---\n`;
                    text += `„É¶„Éº„Ç∂„ÉºÂêçÔºö${user.name}\n`;
                    text += `ÁôªÈå≤Êó•ÊôÇÔºö${user.registeredAt}\n`;
                    text += `---\n\n`;
                });
                
                return text;
            },
            
            // „É¶„Éº„Ç∂„ÉºÂêç„ÇíFirebase„Ç≠„Éº„Å®„Åó„Å¶‰ΩøÁî®ÂèØËÉΩ„Å™ÂΩ¢Âºè„Å´Â§âÊèõ
            sanitizeUsername(username) {
                return username.replace(/[.#$[\]]/g, '_');
            }
        };

        // ==================== UTILITY FUNCTIONS ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type = 'warning') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = 'notification active ' + type;
            
            // „Çø„Ç§„Éó„Å´„Çà„Å£„Å¶Èü≥„ÇíÂ§â„Åà„Çã
            if (type === 'success' || type === 'info') {
                // ÊàêÂäü„ÉªÊÉÖÂ†±ÈÄöÁü•„ÅØÈü≥„ÇíÈ≥¥„Çâ„Åï„Å™„ÅÑÔºàÊó¢„Å´Âà•„ÅÆÈü≥„ÅåÈ≥¥„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅåÂ§ö„ÅÑÔºâ
            } else {
                audio.playError();
            }
            
            setTimeout(() => {
                notif.classList.remove('active');
            }, 2000);
        }

        function loadRankings() {
            // „É≠„Éº„Ç´„É´„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâË™≠„ÅøËæº„ÅøÔºà„Ç™„Éï„É©„Ç§„É≥ÂØæÂøúÔºâ
            const saved = localStorage.getItem('linkedblocks_rankings');
            GameState.rankings = saved ? JSON.parse(saved) : [];
        }

        function saveRankings() {
            localStorage.setItem('linkedblocks_rankings', JSON.stringify(GameState.rankings));
        }

        async function addWin(username, isMulti = false) {
            if (!username || !GameState.isRegistered) return;
            
            try {
                if (isMulti) {
                    await FirebaseRanking.addMultiWin(username);
                } else {
                    await FirebaseRanking.addSoloWin(username);
                }
            } catch (error) {
                console.error('Failed to update ranking:', error);
                // „É≠„Éº„Ç´„É´„Å´„ÇÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰øùÂ≠ò
                const existing = GameState.rankings.find(r => r.name === username);
                if (existing) {
                    existing.wins++;
                } else {
                    GameState.rankings.push({ name: username, wins: 1 });
                }
                saveRankings();
            }
        }

        async function renderRankings() {
            const soloList = document.getElementById('soloRankingList');
            const multiList = document.getElementById('multiRankingList');
            
            soloList.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 20px;">Ë™≠„ÅøËæº„Åø‰∏≠...</p>';
            multiList.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 20px;">Ë™≠„ÅøËæº„Åø‰∏≠...</p>';
            
            try {
                // „ÇΩ„É≠„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó
                const soloRankings = await FirebaseRanking.getSoloRankings(10);
                renderRankingList(soloList, soloRankings, '‰∏Ä‰∫∫„Éó„É¨„Ç§');
                
                // „Éû„É´„ÉÅ„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó
                const multiRankings = await FirebaseRanking.getMultiRankings(10);
                renderRankingList(multiList, multiRankings, '„Éû„É´„ÉÅ„Éó„É¨„Ç§');
            } catch (error) {
                console.error('Failed to load rankings:', error);
                soloList.innerHTML = '<p style="color: var(--neon-red); text-align: center; padding: 20px;">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</p>';
                multiList.innerHTML = '<p style="color: var(--neon-red); text-align: center; padding: 20px;">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</p>';
            }
        }

        function renderRankingList(container, rankings, type) {
            container.innerHTML = '';
            
            if (!rankings || rankings.length === 0) {
                container.innerHTML = `<p style="color: var(--text-dim); text-align: center; padding: 20px;">„Åæ„Å†${type}„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>`;
                return;
            }
            
            // È†Ü‰Ωç„ÇíË®àÁÆóÔºàÂêå„ÅòÂãùÂà©Êï∞„ÅØÂêå„ÅòÈ†Ü‰ΩçÔºâ
            let currentRank = 1;
            let displayCount = 0;
            
            rankings.forEach((entry, i) => {
                // 10‰Ωç„Åæ„Åß„ÅÆ„ÅøË°®Á§∫
                if (displayCount >= 10) return;
                
                // Ââç„ÅÆ„Ç®„É≥„Éà„É™„Å®ÂãùÂà©Êï∞„ÅåÁï∞„Å™„ÇãÂ†¥Âêà„ÄÅÈ†Ü‰Ωç„ÇíÊõ¥Êñ∞
                if (i > 0 && entry.wins < rankings[i - 1].wins) {
                    currentRank = i + 1;
                }
                
                // 4‰Ωç‰ª•‰∏ã„ÅØË°®Á§∫„Åó„Å™„ÅÑÔºà„Åü„Å†„ÅóFirebase„Å´„ÅØ‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„ÇãÔºâ
                // ‚Üí ‰øÆÊ≠£Ôºö10‰Ωç„Åæ„ÅßË°®Á§∫„Åô„Çã„Åå„ÄÅËâ≤„ÅØ3‰Ωç„Åæ„Åß
                
                const item = document.createElement('div');
                item.className = 'ranking-item';
                
                // È†Ü‰Ωç„Å´Âøú„Åò„ÅüËâ≤„ÇíË®≠ÂÆöÔºàÂêå„ÅòÂãùÂà©Êï∞„Å™„ÇâÂêå„ÅòËâ≤Ôºâ
                let rankClass = '';
                if (currentRank === 1) {
                    rankClass = 'rank-gold';
                } else if (currentRank === 2) {
                    rankClass = 'rank-silver';
                } else if (currentRank === 3) {
                    rankClass = 'rank-bronze';
                }
                
                if (rankClass) {
                    item.classList.add(rankClass);
                }
                
                item.innerHTML = `
                    <span class="rank">#${currentRank}</span>
                    <span class="ranking-name">${entry.name}</span>
                    <span class="ranking-wins">
                        <span class="wins-label">ÂãùÂà©Êï∞</span>
                        <span class="wins-count">${entry.wins}</span>
                    </span>
                `;
                container.appendChild(item);
                displayCount++;
            });
        }

        // ==================== MATRIX BACKGROUND ====================
        function createMatrixBackground() {
            const container = document.getElementById('matrixBg');
            const chars = 'LINKEDBLOCKS01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥';
            const columns = Math.floor(window.innerWidth / 20);
            
            for (let i = 0; i < columns; i++) {
                const column = document.createElement('div');
                column.className = 'matrix-column';
                column.style.left = (i * 20) + 'px';
                column.style.animationDuration = (Math.random() * 10 + 10) + 's';
                column.style.animationDelay = (Math.random() * 10) + 's';
                
                let text = '';
                for (let j = 0; j < 30; j++) {
                    text += chars[Math.floor(Math.random() * chars.length)] + '<br>';
                }
                column.innerHTML = text;
                container.appendChild(column);
            }
        }

        // ==================== INTRO SCREEN ====================
        function handleIntro() {
            const introScreen = document.getElementById('introScreen');
            const introText = document.getElementById('introText');
            
            const skipIntro = () => {
                if (!introScreen.classList.contains('active')) return;
                
                audio.init();
                audio.resume();
                audio.playMatchReady();
                
                showScreen('titleScreen');
                
                // Start BGM after a short delay
                setTimeout(() => {
                    if (audio.bgmEnabled) {
                        audio.startBGM();
                    }
                }, 500);
            };
            
            introText.addEventListener('click', skipIntro);
            introText.addEventListener('touchstart', skipIntro);
            
            setTimeout(() => {
                if (introScreen.classList.contains('active')) {
                    skipIntro();
                }
            }, 3000);
        }

        // ==================== GAME BOARD ====================
        function initBoard() {
            GameState.board = [];
            for (let y = 0; y < GameState.boardSize; y++) {
                GameState.board.push(new Array(GameState.boardSize).fill(null));
            }
        }

        function renderBoard() {
            const boardEl = document.getElementById('gameBoard');
            boardEl.innerHTML = '';
            boardEl.style.gridTemplateColumns = `repeat(${GameState.boardSize}, 1fr)`;
            
            const cellSize = Math.min(60, (window.innerWidth - 100) / GameState.boardSize);
            
            // ÂêàÊ≥ïÊâã„É™„Çπ„Éà„ÇíÂèñÂæóÔºàcanPlaceAt„ÅßÂà§ÂÆöÔºâ
            const validMoves = GameState.gameActive ? getAllValidMoves() : [];
            const validMovesSet = new Set(validMoves.map(m => `${m.x},${m.y}`));
            
            for (let y = 0; y < GameState.boardSize; y++) {
                for (let x = 0; x < GameState.boardSize; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.width = cellSize + 'px';
                    cell.style.height = cellSize + 'px';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    if (GameState.board[y][x] !== null) {
                        cell.classList.add('occupied');
                        const block = document.createElement('div');
                        block.className = `block p${GameState.board[y][x] + 1}`;
                        cell.appendChild(block);
                    } else if (validMovesSet.has(`${x},${y}`)) {
                        cell.classList.add('valid-move');
                    }
                    
                    cell.addEventListener('click', () => handleCellClick(x, y));
                    cell.addEventListener('mouseenter', () => {
                        if (validMovesSet.has(`${x},${y}`)) {
                            audio.playHover();
                        }
                    });
                    
                    boardEl.appendChild(cell);
                }
            }
        }

        /**
         * ‰∏ä‰∏ãÂ∑¶Âè≥„Å´Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÈö£Êé•Êù°‰ª∂Ôºâ
         */
        function hasOrthogonalNeighborBlock(x, y) {
            // ‰∏ä
            if (y > 0 && GameState.board[y - 1][x] !== null) {
                return true;
            }
            // ‰∏ã
            if (y + 1 < GameState.boardSize && GameState.board[y + 1][x] !== null) {
                return true;
            }
            // Â∑¶
            if (x > 0 && GameState.board[y][x - 1] !== null) {
                return true;
            }
            // Âè≥
            if (x + 1 < GameState.boardSize && GameState.board[y][x + 1] !== null) {
                return true;
            }
            return false;
        }

        /**
         * ÊîØÊåÅÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØÔºàÊµÆÈÅäÁ¶ÅÊ≠¢Ôºâ
         * - ÊúÄ‰∏ãÊÆµ„Å™„ÇâOKÔºàÂú∞Èù¢„Å´ÊîØ„Åà„Çâ„Çå„Å¶„ÅÑ„ÇãÔºâ
         * - ÊúÄ‰∏ãÊÆµ‰ª•Â§ñ„ÅØ„ÄÅÁõ¥‰∏ã(x, y+1)„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøOK
         */
        function hasSupport(x, y) {
            const bottomY = GameState.boardSize - 1;
            
            // ÊúÄ‰∏ãÊÆµ„Å™„ÇâÂú∞Èù¢„Å´ÊîØ„Åà„Çâ„Çå„Å¶„ÅÑ„Çã
            if (y === bottomY) {
                return true;
            }
            
            // ÊúÄ‰∏ãÊÆµ‰ª•Â§ñÔºöÁõ¥‰∏ã„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çã„Åã
            return GameState.board[y + 1][x] !== null;
        }

        /**
         * ÈÖçÁΩÆÂèØÂê¶Âà§ÂÆöÔºàÂîØ‰∏Ä„ÅÆÂà§ÂÆöÈñ¢Êï∞Ôºâ
         * 
         * „Äê1ÊâãÁõÆ„ÄëÁõ§Èù¢„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå0ÂÄã
         *   - ÊúÄ‰∏ãÊÆµ„ÅÆÁ©∫„Çª„É´„ÅÆ„ÅøÈÖçÁΩÆÂèØËÉΩ
         * 
         * „Äê2ÊâãÁõÆ‰ª•Èôç„Äë
         *   ÈÖçÁΩÆÂèØËÉΩ = ‰ª•‰∏ã„ÇíÂÖ®„Å¶Ê∫Ä„Åü„Åô
         *   1) ÂØæË±°„Çª„É´„ÅåÁ©∫
         *   2) Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å´‰∏ä‰∏ãÂ∑¶Âè≥„ÅÆ„ÅÑ„Åö„Çå„Åã„ÅßÈö£Êé•
         *   3) ÊîØÊåÅÊù°‰ª∂„ÇíÊ∫Ä„Åü„ÅôÔºàÊúÄ‰∏ãÊÆµ OR Áõ¥‰∏ã„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„ÇãÔºâ
         */
        function canPlaceAt(x, y) {
            // ÁØÑÂõ≤Â§ñ„ÉÅ„Çß„ÉÉ„ÇØ
            if (x < 0 || x >= GameState.boardSize || y < 0 || y >= GameState.boardSize) {
                return false;
            }
            
            // Êù°‰ª∂1: ÂØæË±°„Çª„É´„ÅåÁ©∫
            if (GameState.board[y][x] !== null) {
                return false;
            }
            
            const bottomY = GameState.boardSize - 1;
            
            // Áõ§Èù¢„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå1„Å§„Åß„ÇÇ„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            let hasAnyBlock = false;
            for (let by = 0; by < GameState.boardSize; by++) {
                for (let bx = 0; bx < GameState.boardSize; bx++) {
                    if (GameState.board[by][bx] !== null) {
                        hasAnyBlock = true;
                        break;
                    }
                }
                if (hasAnyBlock) break;
            }
            
            // „Äê1ÊâãÁõÆ„ÄëÊúÄ‰∏ãÊÆµ„ÅÆ„ÅøË®±ÂèØ
            if (!hasAnyBlock) {
                return y === bottomY;
            }
            
            // „Äê2ÊâãÁõÆ‰ª•Èôç„Äë
            // Êù°‰ª∂2: Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å´‰∏ä‰∏ãÂ∑¶Âè≥„ÅßÈö£Êé•
            if (!hasOrthogonalNeighborBlock(x, y)) {
                return false;
            }
            
            // Êù°‰ª∂3: ÊîØÊåÅÊù°‰ª∂ÔºàÊúÄ‰∏ãÊÆµ OR Áõ¥‰∏ã„Å´„Éñ„É≠„ÉÉ„ÇØÔºâ
            if (!hasSupport(x, y)) {
                return false;
            }
            
            return true;
        }

        /**
         * ÂÖ®„Å¶„ÅÆÂêàÊ≥ïÊâã„ÇíÂèñÂæó
         */
        function getAllValidMoves() {
            const moves = [];
            for (let y = 0; y < GameState.boardSize; y++) {
                for (let x = 0; x < GameState.boardSize; x++) {
                    if (canPlaceAt(x, y)) {
                        moves.push({ x, y });
                    }
                }
            }
            return moves;
        }

        function handleCellClick(x, y) {
            if (!GameState.gameActive) return;
            
            // ÈÖçÁΩÆÂá¶ÁêÜ‰∏≠„ÅØÁÑ°Ë¶ñÔºàÈÄ£Á∂ö„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢Ôºâ
            if (GameState.isPlacing) return;
            
            // canPlaceAt„ÅßÂà§ÂÆöÔºàÂîØ‰∏Ä„ÅÆÂà§ÂÆöÈñ¢Êï∞Ôºâ
            if (!canPlaceAt(x, y)) {
                return;
            }
            
            // CPU's turn in solo mode
            if (GameState.gameMode === 'solo' && GameState.currentPlayer === 1) return;
            
            // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÊôÇ„ÅØËá™ÂàÜ„ÅÆ„Çø„Éº„É≥„ÅÆ„ÅøÊìç‰ΩúÂèØËÉΩ
            if (GameState.gameMode === 'multi') {
                if (GameState.currentPlayer !== SyncLayer.playerIndex) {
                    return; // Ëá™ÂàÜ„ÅÆ„Çø„Éº„É≥„Åß„ÅØ„Å™„ÅÑ
                }
            }
            
            placeBlock(x, y);
        }

        async function placeBlock(x, y) {
            // ÈÖçÁΩÆ‰∏≠„Éï„É©„Ç∞„ÇíON
            GameState.isPlacing = true;
            
            // ===== canPlaceAt„ÅßÂà§ÂÆö =====
            if (!canPlaceAt(x, y)) {
                console.error('ÈÖçÁΩÆ‰∏çÂèØ:', x, y);
                GameState.isPlacing = false;
                return false;
            }
            
            // ===== ÈÖçÁΩÆÂÆüË°å =====
            GameState.board[y][x] = GameState.currentPlayer;
            
            audio.playPlace();
            renderBoard();
            
            // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÊôÇ„ÅØFirebase„Å´ÂêåÊúü
            if (GameState.gameMode === 'multi') {
                await SyncLayer.updateBoard(GameState.board);
            }
            
            const winResult = checkWin(x, y);
            if (winResult) {
                // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÊôÇ„ÅØÂãùÊïó„Å®ÂãùÂà©„Çª„É´„ÇíFirebase„Å´ÂêåÊúü
                if (GameState.gameMode === 'multi') {
                    await SyncLayer.endGame(winResult.player, winResult.cells);
                }
                GameState.isPlacing = false;
                endGame(winResult);
                return true;
            }
            
            if (checkDraw()) {
                // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÊôÇ„ÅØÂºï„ÅçÂàÜ„Åë„ÇíFirebase„Å´ÂêåÊúü
                if (GameState.gameMode === 'multi') {
                    await SyncLayer.endGame(-1); // -1 = Âºï„ÅçÂàÜ„Åë
                }
                GameState.isPlacing = false;
                endGame(null, true);
                return true;
            }
            
            // Ê¨°„ÅÆ„Çø„Éº„É≥„Å∏
            if (GameState.gameMode === 'multi') {
                // „Éû„É´„ÉÅ„Éó„É¨„Ç§: „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åã„ÇâÊ¨°„ÅÆ„Çø„Éº„É≥„ÇíË®àÁÆó
                const onlineIndices = GameState.players.map(p => p.originalIndex);
                const currentIdx = onlineIndices.indexOf(GameState.currentPlayer);
                const nextIdx = (currentIdx + 1) % onlineIndices.length;
                const nextPlayer = onlineIndices[nextIdx];
                
                console.log('„Çø„Éº„É≥Â§âÊõ¥:', GameState.currentPlayer, '->', nextPlayer, 'onlineIndices:', onlineIndices);
                
                await SyncLayer.updateTurn(nextPlayer);
                // ÈÖçÁΩÆ‰∏≠„Éï„É©„Ç∞„ÅØonTurnChange„ÅßËá™ÂãïÁöÑ„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Çã
            } else {
                // „ÇΩ„É≠/„É≠„Éº„Ç´„É´: „É≠„Éº„Ç´„É´„Åß„Çø„Éº„É≥Â§âÊõ¥
                GameState.isPlacing = false;
                nextTurn();
            }
            
            return true;
        }

        function checkWin(lastX, lastY) {
            const player = GameState.board[lastY][lastX];
            const directions = [
                [[0, 1], [0, -1]],   // Vertical
                [[1, 0], [-1, 0]],   // Horizontal
                [[1, 1], [-1, -1]], // Diagonal \
                [[1, -1], [-1, 1]]  // Diagonal /
            ];
            
            for (const [dir1, dir2] of directions) {
                let count = 1;
                const cells = [[lastX, lastY]];
                
                for (const [dx, dy] of [dir1, dir2]) {
                    let x = lastX + dx;
                    let y = lastY + dy;
                    
                    while (x >= 0 && x < GameState.boardSize && 
                           y >= 0 && y < GameState.boardSize &&
                           GameState.board[y][x] === player) {
                        count++;
                        cells.push([x, y]);
                        x += dx;
                        y += dy;
                    }
                }
                
                if (count >= GameState.winLength) {
                    return { player, cells: cells.slice(0, GameState.winLength) };
                }
            }
            
            return null;
        }

        function checkDraw() {
            // ÂêàÊ≥ïÊâã„Åå1„Å§„ÇÇ„Å™„Åë„Çå„Å∞Âºï„ÅçÂàÜ„Åë
            return getAllValidMoves().length === 0;
        }

        async function nextTurn() {
            GameState.currentPlayer = (GameState.currentPlayer + 1) % GameState.players.length;
            updateTurnDisplay();
            resetTimer();
            audio.playTurnChange();
            
            // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÊôÇ„ÅØFirebase„Å´ÂêåÊúü
            if (GameState.gameMode === 'multi') {
                await SyncLayer.updateTurn(GameState.currentPlayer);
            }
            
            if (GameState.gameMode === 'solo' && GameState.currentPlayer === 1) {
                setTimeout(cpuMove, 500 + Math.random() * 500);
            }
        }

        function updateTurnDisplay() {
            document.getElementById('currentTurn').textContent = `P${GameState.currentPlayer + 1}`;
            
            // „Éó„É¨„Ç§„É§„Éº„Çø„Ç∞„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            const tags = document.querySelectorAll('.player-tag');
            tags.forEach((tag) => {
                // „Çø„Ç∞„ÅÆ„ÇØ„É©„Çπ„Åã„Çâ„Éó„É¨„Ç§„É§„ÉºÁï™Âè∑„ÇíÂèñÂæó (p1, p2, p3)
                const match = tag.className.match(/p(\d+)/);
                if (match) {
                    const tagPlayerIndex = parseInt(match[1]) - 1; // p1 -> 0, p2 -> 1, etc.
                    tag.classList.toggle('active', tagPlayerIndex === GameState.currentPlayer);
                }
            });
        }

        // ==================== CPU AI ====================
        function cpuMove() {
            if (!GameState.gameActive) return;
            
            const validMoves = getAllValidMoves();
            
            if (validMoves.length === 0) {
                console.log('No valid moves for CPU');
                return;
            }
            
            let selectedMove;
            
            if (GameState.cpuLevel === 'weak') {
                // Âº±Ôºö70%„É©„É≥„ÉÄ„É†„ÄÅ30%ÊúÄÂñÑÊâã
                if (Math.random() < 0.7) {
                    selectedMove = validMoves[Math.floor(Math.random() * validMoves.length)];
                } else {
                    validMoves.forEach(move => {
                        move.score = evaluateMove(move.x, move.y);
                    });
                    validMoves.sort((a, b) => b.score - a.score);
                    selectedMove = validMoves[0];
                }
            } else if (GameState.cpuLevel === 'normal') {
                // ‰∏≠Ôºö10%„É©„É≥„ÉÄ„É†„ÄÅ90%Ë©ï‰æ°„Éô„Éº„ÇπÔºàÊ∑±„Åï3„ÅÆÂÖàË™≠„ÅøÔºâ
                if (Math.random() < 0.10) {
                    validMoves.forEach(move => {
                        move.score = evaluateMove(move.x, move.y);
                    });
                    validMoves.sort((a, b) => b.score - a.score);
                    // ‰∏ä‰Ωç3Êâã„Åã„Çâ„É©„É≥„ÉÄ„É†ÈÅ∏Êäû
                    const topMoves = validMoves.slice(0, Math.min(3, validMoves.length));
                    selectedMove = topMoves[Math.floor(Math.random() * topMoves.length)];
                } else {
                    validMoves.forEach(move => {
                        move.score = evaluateMoveWithLookahead(move.x, move.y, 3);
                    });
                    validMoves.sort((a, b) => b.score - a.score);
                    selectedMove = validMoves[0];
                }
            } else {
                // Âº∑ÔºöÊúÄÂº∑AI - Â∏∏„Å´ÊúÄÈÅ©„Å™Êâã„ÇíÈÅ∏„Å∂
                // Âç≥ÂãùÂà©„ÉªÂç≥„Éñ„É≠„ÉÉ„ÇØ„ÇíÊúÄÂÑ™ÂÖà„Åß„ÉÅ„Çß„ÉÉ„ÇØ
                const immediateWin = findImmediateWin(1); // CPUÂãùÂà©
                if (immediateWin) {
                    selectedMove = immediateWin;
                } else {
                    const immediateBlock = findImmediateWin(0); // „Éó„É¨„Ç§„É§„ÉºÂãùÂà©ÈòªÊ≠¢
                    if (immediateBlock) {
                        selectedMove = immediateBlock;
                    } else {
                        // „ÉÄ„Éñ„É´„É™„Éº„ÉÅÔºà2ÊñπÂêëÂêåÊôÇ„É™„Éº„ÉÅÔºâ„ÇíÊé¢„Åô
                        const doubleReach = findDoubleReachMove(1);
                        if (doubleReach) {
                            selectedMove = doubleReach;
                        } else {
                            // Áõ∏Êâã„ÅÆ„ÉÄ„Éñ„É´„É™„Éº„ÉÅ„ÇíÈòªÊ≠¢
                            const blockDoubleReach = findDoubleReachMove(0);
                            if (blockDoubleReach) {
                                selectedMove = blockDoubleReach;
                            } else {
                                // Ê∑±„ÅÑÂÖàË™≠„Åø„ÅßÊúÄÂñÑÊâã„ÇíÈÅ∏ÊäûÔºàÊ∑±„Åï6Ôºâ
                                validMoves.forEach(move => {
                                    move.score = evaluateMoveWithLookahead(move.x, move.y, 6);
                                });
                                validMoves.sort((a, b) => b.score - a.score);
                                selectedMove = validMoves[0];
                            }
                        }
                    }
                }
            }
            
            // ÈÖçÁΩÆÂÆüË°å
            if (selectedMove && canPlaceAt(selectedMove.x, selectedMove.y)) {
                placeBlock(selectedMove.x, selectedMove.y);
            } else {
                const safeMoves = getAllValidMoves();
                if (safeMoves.length > 0) {
                    placeBlock(safeMoves[0].x, safeMoves[0].y);
                }
            }
        }
        
        // Âç≥ÂãùÂà©„Åß„Åç„ÇãÊâã„ÇíÊé¢„Åô
        function findImmediateWin(player) {
            const validMoves = getAllValidMoves();
            for (const move of validMoves) {
                GameState.board[move.y][move.x] = player;
                const wins = checkWin(move.x, move.y);
                GameState.board[move.y][move.x] = null;
                if (wins) {
                    return move;
                }
            }
            return null;
        }
        
        // „ÉÄ„Éñ„É´„É™„Éº„ÉÅÔºà2ÊñπÂêë‰ª•‰∏ä„ÅÆ„É™„Éº„ÉÅÔºâ„Çí‰Ωú„Çå„ÇãÊâã„ÇíÊé¢„Åô
        function findDoubleReachMove(player) {
            const validMoves = getAllValidMoves();
            const winLength = GameState.winLength;
            
            for (const move of validMoves) {
                GameState.board[move.y][move.x] = player;
                
                let reachCount = 0;
                const directions = [
                    [0, 1],   // Á∏¶
                    [1, 0],   // Ê®™
                    [1, 1],   // Êñú„ÇÅ \
                    [1, -1]   // Êñú„ÇÅ /
                ];
                
                for (const [dx, dy] of directions) {
                    if (isReach(move.x, move.y, dx, dy, player)) {
                        reachCount++;
                    }
                }
                
                GameState.board[move.y][move.x] = null;
                
                if (reachCount >= 2) {
                    return move;
                }
            }
            return null;
        }
        
        // ÁâπÂÆöÊñπÂêë„Åß„É™„Éº„ÉÅÔºà„ÅÇ„Å®1„Å§„ÅßÂãùÂà©Ôºâ„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isReach(x, y, dx, dy, player) {
            const winLength = GameState.winLength;
            
            // ‰∏°ÊñπÂêë„Å´„Ç´„Ç¶„É≥„Éà
            let count = 1;
            let emptyCount = 0;
            let emptyPos = null;
            
            // Ê≠£ÊñπÂêë
            for (let i = 1; i < winLength; i++) {
                const nx = x + dx * i;
                const ny = y + dy * i;
                if (nx < 0 || nx >= GameState.boardSize || ny < 0 || ny >= GameState.boardSize) break;
                
                const cell = GameState.board[ny][nx];
                if (cell === player) {
                    count++;
                } else if (cell === null && emptyCount === 0) {
                    emptyCount++;
                    emptyPos = {x: nx, y: ny};
                } else {
                    break;
                }
            }
            
            // ÈÄÜÊñπÂêë
            for (let i = 1; i < winLength; i++) {
                const nx = x - dx * i;
                const ny = y - dy * i;
                if (nx < 0 || nx >= GameState.boardSize || ny < 0 || ny >= GameState.boardSize) break;
                
                const cell = GameState.board[ny][nx];
                if (cell === player) {
                    count++;
                } else if (cell === null && emptyCount === 0) {
                    emptyCount++;
                    emptyPos = {x: nx, y: ny};
                } else {
                    break;
                }
            }
            
            // „É™„Éº„ÉÅ: winLength - 1ÂÄã‰∏¶„Çì„Åß„ÅÑ„Å¶„ÄÅÁ©∫„Åç„Åå1„Å§„ÅÇ„Çã
            return count >= winLength - 1 && emptyCount === 1 && emptyPos && canPlaceAt(emptyPos.x, emptyPos.y);
        }

        // ÂÖàË™≠„Åø‰ªò„ÅçË©ï‰æ°Ôºà„Éü„Éã„Éû„ÉÉ„ÇØ„ÇπÔºâ
        function evaluateMoveWithLookahead(x, y, depth) {
            const cpuPlayer = 1;
            const humanPlayer = 0;
            
            // ‰ªÆÈÖçÁΩÆ
            GameState.board[y][x] = cpuPlayer;
            
            // Âç≥ÂãùÂà©„ÉÅ„Çß„ÉÉ„ÇØ
            if (checkWin(x, y)) {
                GameState.board[y][x] = null;
                return 100000;
            }
            
            let score;
            if (depth <= 1) {
                score = evaluateBoard(cpuPlayer);
            } else {
                score = minimax(depth - 1, false, -Infinity, Infinity, cpuPlayer, humanPlayer);
            }
            
            GameState.board[y][x] = null;
            return score;
        }

        // „Éü„Éã„Éû„ÉÉ„ÇØ„Çπ„Ç¢„É´„Ç¥„É™„Ç∫„É†Ôºà„Ç¢„É´„Éï„Ç°„Éô„Éº„ÇøÊûùÂàà„Çä‰ªò„ÅçÔºâ
        function minimax(depth, isMaximizing, alpha, beta, cpuPlayer, humanPlayer) {
            const validMoves = getAllValidMoves();
            
            if (depth === 0 || validMoves.length === 0) {
                return evaluateBoard(cpuPlayer);
            }
            
            if (isMaximizing) {
                let maxScore = -Infinity;
                for (const move of validMoves) {
                    GameState.board[move.y][move.x] = cpuPlayer;
                    
                    if (checkWin(move.x, move.y)) {
                        GameState.board[move.y][move.x] = null;
                        return 100000 + depth; // Êó©„ÅÑÂãùÂà©„ÇíÂÑ™ÂÖà
                    }
                    
                    const score = minimax(depth - 1, false, alpha, beta, cpuPlayer, humanPlayer);
                    GameState.board[move.y][move.x] = null;
                    
                    maxScore = Math.max(maxScore, score);
                    alpha = Math.max(alpha, score);
                    if (beta <= alpha) break;
                }
                return maxScore;
            } else {
                let minScore = Infinity;
                for (const move of validMoves) {
                    GameState.board[move.y][move.x] = humanPlayer;
                    
                    if (checkWin(move.x, move.y)) {
                        GameState.board[move.y][move.x] = null;
                        return -100000 - depth; // Áõ∏Êâã„ÅÆÊó©„ÅÑÂãùÂà©„ÇíÈÅø„Åë„Çã
                    }
                    
                    const score = minimax(depth - 1, true, alpha, beta, cpuPlayer, humanPlayer);
                    GameState.board[move.y][move.x] = null;
                    
                    minScore = Math.min(minScore, score);
                    beta = Math.min(beta, score);
                    if (beta <= alpha) break;
                }
                return minScore;
            }
        }

        // Áõ§Èù¢ÂÖ®‰Ωì„ÅÆË©ï‰æ°
        function evaluateBoard(cpuPlayer) {
            const humanPlayer = cpuPlayer === 1 ? 0 : 1;
            let score = 0;
            
            const directions = [
                [0, 1],   // Á∏¶
                [1, 0],   // Ê®™
                [1, 1],   // Êñú„ÇÅ \
                [1, -1]   // Êñú„ÇÅ /
            ];
            
            // ÂÖ®„Å¶„ÅÆ„É©„Ç§„É≥„ÇíË©ï‰æ°
            for (let y = 0; y < GameState.boardSize; y++) {
                for (let x = 0; x < GameState.boardSize; x++) {
                    for (const [dx, dy] of directions) {
                        const lineScore = evaluateLine(x, y, dx, dy, cpuPlayer, humanPlayer);
                        score += lineScore;
                    }
                }
            }
            
            return score;
        }

        // „É©„Ç§„É≥Ë©ï‰æ°Ôºà„Çà„ÇäÈ´òÂ∫¶„Å™Ë©ï‰æ°Ôºâ
        function evaluateLine(startX, startY, dx, dy, cpuPlayer, humanPlayer) {
            let cpuCount = 0;
            let humanCount = 0;
            let emptyCount = 0;
            let blocked = false;
            let openEnds = 0; // ‰∏°Á´Ø„ÅåÁ©∫„ÅÑ„Å¶„ÅÑ„Çã„Åã
            
            for (let i = 0; i < GameState.winLength; i++) {
                const x = startX + dx * i;
                const y = startY + dy * i;
                
                if (x < 0 || x >= GameState.boardSize || y < 0 || y >= GameState.boardSize) {
                    blocked = true;
                    break;
                }
                
                const cell = GameState.board[y][x];
                if (cell === cpuPlayer) cpuCount++;
                else if (cell === humanPlayer) humanCount++;
                else emptyCount++;
            }
            
            if (blocked) return 0;
            
            // ‰∏°Á´Ø„ÅÆÈñãÊîæÂ∫¶„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const beforeX = startX - dx;
            const beforeY = startY - dy;
            const afterX = startX + dx * GameState.winLength;
            const afterY = startY + dy * GameState.winLength;
            
            if (beforeX >= 0 && beforeX < GameState.boardSize && 
                beforeY >= 0 && beforeY < GameState.boardSize &&
                GameState.board[beforeY][beforeX] === null) {
                openEnds++;
            }
            if (afterX >= 0 && afterX < GameState.boardSize && 
                afterY >= 0 && afterY < GameState.boardSize &&
                GameState.board[afterY][afterX] === null) {
                openEnds++;
            }
            
            // ‰∏°Êñπ„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çã„É©„Ç§„É≥„ÅØ‰æ°ÂÄ§„Å™„Åó
            if (cpuCount > 0 && humanCount > 0) return 0;
            
            // CPU„ÅÆ„É©„Ç§„É≥Ë©ï‰æ°
            if (cpuCount > 0 && humanCount === 0) {
                if (cpuCount === GameState.winLength - 1 && emptyCount === 1) {
                    return 10000; // „É™„Éº„ÉÅÔºàÂãù„Å°Á¢∫ÂÆöÔºâ
                }
                if (cpuCount === GameState.winLength - 2 && emptyCount === 2) {
                    // ‰∏°Á´Ø„Ç™„Éº„Éó„É≥„Å™„ÇâË∂ÖÂº∑Âäõ
                    return openEnds === 2 ? 3000 : 800;
                }
                if (cpuCount === GameState.winLength - 3 && emptyCount === 3) {
                    return openEnds === 2 ? 400 : 100;
                }
                return cpuCount * cpuCount * 15 * (1 + openEnds * 0.3);
            }
            
            // Áõ∏Êâã„ÅÆ„É©„Ç§„É≥Ë©ï‰æ°ÔºàËÑÖÂ®Å„Å®„Åó„Å¶Ôºâ
            if (humanCount > 0 && cpuCount === 0) {
                if (humanCount === GameState.winLength - 1 && emptyCount === 1) {
                    return -8000; // Áõ∏Êâã„ÅÆ„É™„Éº„ÉÅÔºàÂøÖ„Åö„Éñ„É≠„ÉÉ„ÇØÔºâ
                }
                if (humanCount === GameState.winLength - 2 && emptyCount === 2) {
                    // ‰∏°Á´Ø„Ç™„Éº„Éó„É≥„Å™„ÇâÈùûÂ∏∏„Å´Âç±Èô∫
                    return openEnds === 2 ? -2500 : -600;
                }
                if (humanCount === GameState.winLength - 3 && emptyCount === 3) {
                    return openEnds === 2 ? -300 : -80;
                }
                return -humanCount * humanCount * 12 * (1 + openEnds * 0.3);
            }
            
            return 0;
        }

        // ÂçòÁ¥îË©ï‰æ°ÔºàÂº±Áî®Ôºâ
        function evaluateMove(x, y) {
            let score = 0;
            const cpuPlayer = 1;
            const humanPlayer = 0;
            
            const originalValue = GameState.board[y][x];
            
            // Âç≥ÂãùÂà©
            GameState.board[y][x] = cpuPlayer;
            if (checkWin(x, y)) {
                GameState.board[y][x] = originalValue;
                return 10000;
            }
            GameState.board[y][x] = originalValue;
            
            // Áõ∏Êâã„ÅÆ„Éñ„É≠„ÉÉ„ÇØ
            GameState.board[y][x] = humanPlayer;
            if (checkWin(x, y)) {
                GameState.board[y][x] = originalValue;
                return 5000;
            }
            GameState.board[y][x] = originalValue;
            
            // „É©„Ç§„É≥Ë©ï‰æ°
            const allDirections = [
                [[0, 1], [0, -1]],
                [[1, 0], [-1, 0]],
                [[1, 1], [-1, -1]],
                [[1, -1], [-1, 1]]
            ];
            
            for (const [dir1, dir2] of allDirections) {
                let cpuCount = 1;
                let humanCount = 1;
                
                for (const [dx, dy] of [dir1, dir2]) {
                    let nx = x + dx;
                    let ny = y + dy;
                    
                    for (let i = 0; i < GameState.winLength - 1; i++) {
                        if (nx < 0 || nx >= GameState.boardSize || 
                            ny < 0 || ny >= GameState.boardSize) break;
                        
                        if (GameState.board[ny][nx] === cpuPlayer) cpuCount++;
                        else if (GameState.board[ny][nx] === humanPlayer) humanCount++;
                        
                        nx += dx;
                        ny += dy;
                    }
                }
                
                score += cpuCount * cpuCount * 10;
                score += humanCount * humanCount * 5;
            }
            
            // ‰∏≠ÂøÉ„Éú„Éº„Éä„Çπ
            const centerDist = Math.abs(x - GameState.boardSize/2) + Math.abs(y - GameState.boardSize/2);
            score += (GameState.boardSize - centerDist) * 2;
            
            return score;
        }

        // ==================== TIMER ====================
        function startTimer() {
            if (GameState.timerSetting === 0) {
                document.getElementById('timerDisplay').textContent = '--';
                return;
            }
            
            GameState.timeLeft = GameState.timerSetting;
            updateTimerDisplay();
            
            GameState.timerInterval = setInterval(async () => {
                GameState.timeLeft--;
                updateTimerDisplay();
                
                if (GameState.timeLeft <= 3 && GameState.timeLeft > 0) {
                    audio.playTimerBeep();
                }
                
                if (GameState.timeLeft <= 0) {
                    // Skip turn
                    clearInterval(GameState.timerInterval);
                    
                    // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÊôÇ: Ëá™ÂàÜ„ÅÆ„Çø„Éº„É≥„ÅÆÂ†¥Âêà„ÅÆ„Åø„Çø„Éº„É≥Â§âÊõ¥„ÇíÈÄÅ‰ø°
                    if (GameState.gameMode === 'multi') {
                        if (GameState.currentPlayer === SyncLayer.playerIndex) {
                            // „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åã„ÇâÊ¨°„ÅÆ„Çø„Éº„É≥„ÇíË®àÁÆó
                            const onlineIndices = GameState.players.map(p => p.originalIndex);
                            const currentIdx = onlineIndices.indexOf(GameState.currentPlayer);
                            const nextIdx = (currentIdx + 1) % onlineIndices.length;
                            const nextPlayer = onlineIndices[nextIdx];
                            
                            console.log('„Çø„Ç§„Éû„ÉºÂàá„Çå „Çø„Éº„É≥Â§âÊõ¥:', GameState.currentPlayer, '->', nextPlayer);
                            await SyncLayer.updateTurn(nextPlayer);
                        }
                        // ‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅØFirebase„ÅÆÊõ¥Êñ∞„ÇíÂæÖ„Å§
                    } else {
                        nextTurn();
                    }
                }
            }, 1000);
        }

        function resetTimer() {
            if (GameState.timerInterval) {
                clearInterval(GameState.timerInterval);
            }
            startTimer();
        }

        function stopTimer() {
            if (GameState.timerInterval) {
                clearInterval(GameState.timerInterval);
                GameState.timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            display.textContent = GameState.timeLeft;
            display.classList.toggle('warning', GameState.timeLeft <= 3);
        }

        // ==================== GAME LIFECYCLE ====================
        function startGame() {
            GameState.gameActive = true;
            GameState.isPlacing = false; // ÈÖçÁΩÆ‰∏≠„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
            
            // „Éû„É´„ÉÅ„Éó„É¨„Ç§‰ª•Â§ñ„ÅÆÂ†¥Âêà„ÅÆ„ÅøcurrentPlayer„Çí0„Å´Ë®≠ÂÆö
            // „Éû„É´„ÉÅ„Éó„É¨„Ç§„Åß„ÅØstartMultiplayerGame„ÅßÊó¢„Å´Firebase„Åã„ÇâË®≠ÂÆöÊ∏à„Åø
            if (GameState.gameMode !== 'multi') {
                GameState.currentPlayer = 0;
            }
            
            // „Éû„É´„ÉÅ„Éó„É¨„Ç§‰ª•Â§ñ„ÄÅ„Åæ„Åü„ÅØ„Éú„Éº„Éâ„ÅåÊú™ÂàùÊúüÂåñ„ÅÆÂ†¥Âêà„ÅÆ„ÅøinitBoard
            if (GameState.gameMode !== 'multi' || !GameState.board || GameState.board.length !== GameState.boardSize) {
                initBoard();
            }
            
            console.log('startGame - currentPlayer:', GameState.currentPlayer, 'myIndex:', SyncLayer.playerIndex);
            
            renderBoard();
            renderPlayersBar();
            updateTurnDisplay();
            
            document.getElementById('roomInfo').textContent = `WIN LENGTH: ${GameState.winLength}`;
            
            showScreen('gameScreen');
            startTimer();
            
            audio.playClick();
        }

        function renderPlayersBar() {
            const bar = document.getElementById('playersBar');
            bar.innerHTML = '';
            
            GameState.players.forEach((player, i) => {
                const tag = document.createElement('div');
                // „Éû„É´„ÉÅ„Éó„É¨„Ç§„Åß„ÅØoriginalIndex„Çí‰ΩøÁî®
                const playerIndex = player.originalIndex !== undefined ? player.originalIndex : i;
                tag.className = `player-tag p${playerIndex + 1}`;
                tag.textContent = `P${playerIndex + 1}: ${player.name}`;
                if (playerIndex === GameState.currentPlayer) tag.classList.add('active');
                bar.appendChild(tag);
            });
        }

        function drawWinLine(cells) {
            // Remove existing win line
            const existingLine = document.querySelector('.win-line-container');
            if (existingLine) existingLine.remove();
            
            const board = document.getElementById('gameBoard');
            const boardRect = board.getBoundingClientRect();
            const cellElements = document.querySelectorAll('.cell');
            
            // Sort cells to get start and end points
            const sortedCells = [...cells].sort((a, b) => {
                if (a[1] !== b[1]) return a[1] - b[1]; // Sort by Y first
                return a[0] - b[0]; // Then by X
            });
            
            const startCell = sortedCells[0];
            const endCell = sortedCells[sortedCells.length - 1];
            
            // Get cell positions
            const startIndex = startCell[1] * GameState.boardSize + startCell[0];
            const endIndex = endCell[1] * GameState.boardSize + endCell[0];
            
            const startCellEl = cellElements[startIndex];
            const endCellEl = cellElements[endIndex];
            
            if (!startCellEl || !endCellEl) return;
            
            const startRect = startCellEl.getBoundingClientRect();
            const endRect = endCellEl.getBoundingClientRect();
            
            // Calculate center positions relative to board
            const startX = startRect.left - boardRect.left + startRect.width / 2;
            const startY = startRect.top - boardRect.top + startRect.height / 2;
            const endX = endRect.left - boardRect.left + endRect.width / 2;
            const endY = endRect.top - boardRect.top + endRect.height / 2;
            
            // Extend line beyond the blocks
            const dx = endX - startX;
            const dy = endY - startY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const extend = 15; // Extension amount
            
            const extStartX = startX - (dx / length) * extend;
            const extStartY = startY - (dy / length) * extend;
            const extEndX = endX + (dx / length) * extend;
            const extEndY = endY + (dy / length) * extend;
            
            // Create SVG container
            const container = document.createElement('div');
            container.className = 'win-line-container';
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'win-line-svg');
            svg.style.width = boardRect.width + 'px';
            svg.style.height = boardRect.height + 'px';
            
            // Create the line path
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'win-line-path');
            path.setAttribute('d', `M ${extStartX} ${extStartY} L ${extEndX} ${extEndY}`);
            
            svg.appendChild(path);
            container.appendChild(svg);
            board.style.position = 'relative';
            board.appendChild(container);
        }

        async function endGame(winResult, isDraw = false) {
            GameState.gameActive = false;
            stopTimer();
            
            if (isDraw) {
                document.getElementById('winnerText').textContent = 'Âºï„ÅçÂàÜ„Åë';
            } else {
                // Highlight winning blocks
                if (winResult.cells && winResult.cells.length > 0) {
                    winResult.cells.forEach(([x, y]) => {
                        const cellIndex = y * GameState.boardSize + x;
                        const cell = document.querySelectorAll('.cell')[cellIndex];
                        if (cell) {
                            const block = cell.querySelector('.block');
                            if (block) block.classList.add('winning');
                        }
                    });
                    
                    // Draw win line through the blocks
                    setTimeout(() => {
                        drawWinLine(winResult.cells);
                    }, 100);
                }
                
                const winner = GameState.players[winResult.player];
                if (winner) {
                    document.getElementById('winnerText').textContent = `WINNER: ${winner.name}`;
                }
                
                // Add win to rankings if applicable
                if (GameState.isRegistered) {
                    if (GameState.gameMode === 'solo' && winResult.player === 0 && 
                        GameState.cpuLevel === 'strong') {
                        // „ÇΩ„É≠ÔºàCPUÂº∑ÔºâÂãùÂà©
                        await addWin(GameState.username, false);
                    } else if (GameState.gameMode === 'multi' && 
                               winResult.player === SyncLayer.playerIndex) {
                        // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÂãùÂà©
                        await addWin(GameState.username, true);
                    }
                }
                
                // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÊôÇ„ÅØFirebase„Å´ÁµÇ‰∫Ü„ÇíÈÄöÁü•ÔºàËá™ÂàÜ„ÅåÂãù„Å£„ÅüÂ†¥Âêà„ÅÆ„ÅøÔºâ
                if (GameState.gameMode === 'multi' && winResult.player === SyncLayer.playerIndex) {
                    await SyncLayer.endGame(winResult.player, winResult.cells);
                }
                
                audio.playWin();
            }
            
            // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÊôÇ„ÅØ„Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„ÉºÊï∞„ÇíÁ¢∫Ë™ç
            const rematchBtn = document.getElementById('rematchBtn');
            const gameOverCountdown = document.getElementById('gameOverCountdown');
            
            if (GameState.gameMode === 'multi') {
                const onlineCount = await SyncLayer.getOnlinePlayerCount();
                if (onlineCount >= 2) {
                    // 2‰∫∫‰ª•‰∏ä„ÅÑ„Çå„Å∞ÂÜçÊà¶ÂèØËÉΩ
                    rematchBtn.style.display = 'block';
                    rematchBtn.textContent = 'ÂÜçÊà¶';
                    
                    // 10Áßí„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÈñãÂßã
                    gameOverCountdown.style.display = 'block';
                    startGameOverCountdown();
                } else {
                    // 1‰∫∫„Å™„ÇâÂÜçÊà¶‰∏çÂèØ
                    rematchBtn.style.display = 'none';
                    gameOverCountdown.style.display = 'none';
                }
            } else {
                rematchBtn.style.display = 'block';
                rematchBtn.textContent = 'ÂÜçÊà¶';
                gameOverCountdown.style.display = 'none';
            }
            
            setTimeout(() => {
                document.getElementById('gameOverOverlay').classList.add('active');
            }, 1500);
        }
        
        let gameOverCountdownInterval = null;
        
        function startGameOverCountdown() {
            let countdown = 20;
            const countdownEl = document.getElementById('gameOverCountdown');
            countdownEl.textContent = countdown;
            
            if (gameOverCountdownInterval) {
                clearInterval(gameOverCountdownInterval);
            }
            
            gameOverCountdownInterval = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(gameOverCountdownInterval);
                    gameOverCountdownInterval = null;
                    
                    // ÊôÇÈñìÂàá„Çå - Âº∑Âà∂ÈÄÄÂá∫
                    document.getElementById('gameOverOverlay').classList.remove('active');
                    SyncLayer.disconnect();
                    returnToTitle();
                    showNotification('ÊôÇÈñìÂàá„Çå„ÅÆ„Åü„ÇÅÈÄÄÂá∫„Åó„Åæ„Åó„Åü', 'warning');
                }
            }, 1000);
        }
        
        function stopGameOverCountdown() {
            if (gameOverCountdownInterval) {
                clearInterval(gameOverCountdownInterval);
                gameOverCountdownInterval = null;
            }
            document.getElementById('gameOverCountdown').style.display = 'none';
        }

        async function rematch() {
            document.getElementById('gameOverOverlay').classList.remove('active');
            
            // GAME SETÁîªÈù¢„ÅÆ„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„ÇíÂÅúÊ≠¢
            stopGameOverCountdown();
            
            // Remove win line
            const winLine = document.querySelector('.win-line-container');
            if (winLine) winLine.remove();
            
            // „Éû„É´„ÉÅ„Éó„É¨„Ç§„ÅÆÂ†¥Âêà
            if (GameState.gameMode === 'multi') {
                const onlineCount = await SyncLayer.getOnlinePlayerCount();
                
                if (onlineCount < 2) {
                    // 1‰∫∫„Å´„Å™„Å£„ÅüÂ†¥Âêà„ÅØ„Çø„Ç§„Éà„É´„Å´Êàª„Åô
                    showModal('aloneInRoomModal');
                    return;
                }
                
                // ÂÜçÊà¶ÂæÖÊ©ü„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                showRematchWaitingModal();
                return;
            }
            
            startGame();
        }
        
        async function showRematchWaitingModal() {
            showModal('rematchWaitingModal');
            
            // „É´„Éº„É†ID„ÇíË°®Á§∫
            document.getElementById('rematchRoomId').textContent = SyncLayer.roomId;
            
            // Firebase„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí'waiting'„Å´Â§âÊõ¥ÔºàÊñ∞Ë¶èÂèÇÂä†„ÇíÂèó„ÅëÂÖ•„Çå„Çã„Åü„ÇÅÔºâ
            await database.ref('rooms/' + SyncLayer.roomId + '/status').set('waiting');
            
            // Ëá™ÂàÜ„ÇíÂÜçÊà¶Ê∫ñÂÇôÂÆå‰∫Ü„Å´„Åô„Çã
            await SyncLayer.setRematchReady();
            
            // „Éó„É¨„Ç§„É§„ÉºÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            updateRematchPlayerStatus();
        }
        
        async function updateRematchPlayerStatus() {
            const container = document.getElementById('rematchPlayerStatus');
            
            const snapshot = await database.ref('rooms/' + SyncLayer.roomId).once('value');
            const roomData = snapshot.val();
            if (!roomData) return;
            
            const players = roomData.players || [];
            const rematchReady = roomData.rematchReady || {};
            
            console.log('updateRematchPlayerStatus - rematchReady:', rematchReady);
            
            container.innerHTML = '';
            
            // Ê∫ñÂÇôÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„Éó„É¨„Ç§„É§„Éº„ÅÆ„ÅøË°®Á§∫
            let readyCount = 0;
            const readyIndices = [];
            
            players.forEach((p, i) => {
                if (!p || !p.online) return;
                // ÊñáÂ≠óÂàó„Ç≠„Éº„Å®Êï∞ÂÄ§„Ç≠„Éº„ÅÆ‰∏°Êñπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const isReady = rematchReady[i] === true || rematchReady[String(i)] === true;
                if (!isReady) return;
                
                readyCount++;
                readyIndices.push(i);
                
                const div = document.createElement('div');
                div.className = 'waiting-player';
                div.innerHTML = `
                    <span class="player-index">P${i + 1}</span>
                    <span class="player-name">${p.name}</span>
                `;
                container.appendChild(div);
            });
            
            console.log('updateRematchPlayerStatus - readyCount:', readyCount, 'readyIndices:', readyIndices);
            
            // „Éõ„Çπ„ÉàÂà§ÂÆöÔºàÊ∫ñÂÇôÂÆå‰∫ÜËÄÖ„ÅÆ‰∏≠„ÅßÊúÄÂ∞è„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºâ
            const isHost = readyIndices.length > 0 && readyIndices[0] === SyncLayer.playerIndex;
            
            // 2‰∫∫‰ª•‰∏ä„Åß„ÄÅ„Éõ„Çπ„Éà„Å™„Çâ„Äå„Ç≤„Éº„É†ÈñãÂßã„Äç„Éú„Çø„É≥„ÇíË°®Á§∫
            const startBtn = document.getElementById('rematchStartBtn');
            if (readyCount >= 2 && isHost) {
                startBtn.style.display = 'block';
            } else {
                startBtn.style.display = 'none';
            }
        }

        function returnToTitle() {
            document.getElementById('gameOverOverlay').classList.remove('active');
            
            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„ÇíÂÅúÊ≠¢
            stopGameOverCountdown();
            
            // Remove win line
            const winLine = document.querySelector('.win-line-container');
            if (winLine) winLine.remove();
            
            stopTimer();
            
            // „Éû„É´„ÉÅ„Éó„É¨„Ç§ÊôÇ„ÅØÂàáÊñ≠
            if (GameState.gameMode === 'multi') {
                SyncLayer.disconnect();
            }
            
            // „Éï„Ç©„Éº„É†„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà
            document.getElementById('usernameInput').disabled = false;
            document.getElementById('usernameInput').value = '';
            document.getElementById('registerPlayBtn').disabled = false;
            document.getElementById('registerPlayBtn').textContent = 'ÁôªÈå≤„Åó„Å¶„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã';
            document.getElementById('guestPlayBtn').disabled = false;
            document.getElementById('guestPlayBtn').textContent = 'ÁôªÈå≤„Åó„Å™„ÅÑ„Åß„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã';
            GameState.username = null;
            GameState.isRegistered = false;
            
            showScreen('titleScreen');
        }

        // ==================== QUIT GAME ====================
        function showQuitConfirm() {
            document.getElementById('quitConfirmModal').classList.add('active');
            audio.playClick();
        }

        function hideQuitConfirm() {
            document.getElementById('quitConfirmModal').classList.remove('active');
        }

        function quitGame() {
            hideQuitConfirm();
            GameState.gameActive = false;
            stopTimer();
            audio.stopBGM();
            
            // Remove win line if exists
            const winLine = document.querySelector('.win-line-container');
            if (winLine) winLine.remove();
            
            returnToTitle();
        }

        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Quit button (PC)
            document.getElementById('quitGameBtn').addEventListener('click', () => {
                showQuitConfirm();
            });
            
            // Quit button („Çπ„Éû„Éõ)
            document.getElementById('mobileQuitBtn').addEventListener('click', () => {
                showQuitConfirm();
            });

            document.getElementById('confirmQuitBtn').addEventListener('click', () => {
                quitGame();
            });

            document.getElementById('cancelQuitBtn').addEventListener('click', () => {
                hideQuitConfirm();
                audio.playClick();
            });
            
            // Help button („Çπ„Éû„Éõ - „Ç≤„Éº„É†ÁîªÈù¢)
            document.getElementById('mobileHelpBtn').addEventListener('click', () => {
                showModal('rulesModal');
                audio.playClick();
            });
            
            // BGM button („Çπ„Éû„Éõ - „Ç≤„Éº„É†ÁîªÈù¢)
            document.getElementById('mobileBgmBtn').addEventListener('click', () => {
                audio.init();
                audio.resume();
                const isOn = audio.toggleBGM();
                document.getElementById('mobileBgmBtn').classList.toggle('on', isOn);
                document.getElementById('panelBgmBtn').classList.toggle('on', isOn);
            });
            
            // BGM button („Éë„Éç„É´ÂÜÖ)
            document.getElementById('panelBgmBtn').addEventListener('click', () => {
                audio.init();
                audio.resume();
                const isOn = audio.toggleBGM();
                document.getElementById('mobileBgmBtn').classList.toggle('on', isOn);
                document.getElementById('panelBgmBtn').classList.toggle('on', isOn);
            });
            
            // Ë®ÄË™ûÂàá„ÇäÊõø„Åà
            document.getElementById('langJaBtn').addEventListener('click', () => {
                setLanguage('ja');
                audio.playClick();
            });
            
            document.getElementById('langEnBtn').addEventListener('click', () => {
                setLanguage('en');
                audio.playClick();
            });

            // Title screen buttons
            document.getElementById('registerPlayBtn').addEventListener('click', async () => {
                // „Ç≤„Çπ„Éà„É¢„Éº„ÉâÁä∂ÊÖã„Å†„Å£„Åü„Çâ„É™„Çª„ÉÉ„Éà„Åó„Å¶ÂÖ•ÂäõÂèØËÉΩ„Å´
                // (username„ÅåGUEST„Åß„ÄÅisRegistered„Ååfalse„ÅÆÂ†¥Âêà)
                if (GameState.username === 'GUEST' && !GameState.isRegistered) {
                    document.getElementById('usernameInput').disabled = false;
                    document.getElementById('usernameInput').value = '';
                    document.getElementById('guestPlayBtn').disabled = false;
                    document.getElementById('guestPlayBtn').textContent = '‚ñ∂ ÁôªÈå≤„Åó„Å™„ÅÑ„Åß„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã';
                    document.getElementById('registerPlayBtn').textContent = 'ÁôªÈå≤„Åó„Å¶„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã';
                    GameState.username = null;
                    GameState.isRegistered = false;
                    audio.playClick();
                    showNotification('„É¶„Éº„Ç∂„Éº„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
                    document.getElementById('usernameInput').focus();
                    return;
                }
                
                // Êó¢„Å´ÁôªÈå≤ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                if (GameState.isRegistered) {
                    return;
                }
                
                const username = document.getElementById('usernameInput').value.trim();
                if (!username) {
                    showNotification('„É¶„Éº„Ç∂„Éº„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                // ÁôªÈå≤‰∏≠„ÅÆË°®Á§∫
                document.getElementById('registerPlayBtn').textContent = 'ÁôªÈå≤‰∏≠...';
                document.getElementById('registerPlayBtn').disabled = true;
                
                // „Éá„Éê„Ç§„ÇπË™çË®º„Ç∑„Çπ„ÉÜ„É†„ÅßÁôªÈå≤ÔºàFirebaseÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                const result = await DeviceAuth.registerUser(username);
                if (!result.success) {
                    showNotification(result.error);
                    document.getElementById('registerPlayBtn').textContent = 'ÁôªÈå≤„Åó„Å¶„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã';
                    document.getElementById('registerPlayBtn').disabled = false;
                    return;
                }
                
                // Firebase„Å´„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çí‰øùÂ≠ò
                await FirebaseUsers.registerUser(username);
                
                GameState.username = username;
                GameState.isRegistered = true;
                GameState.deviceId = result.deviceId;
                audio.playRegisterSuccess();
                
                // ÁôªÈå≤ÂÆå‰∫Ü„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                document.getElementById('usernameInput').disabled = true;
                document.getElementById('registerPlayBtn').textContent = '‚úì ÁôªÈå≤ÂÆå‰∫Ü';
                document.getElementById('registerPlayBtn').disabled = true;
                document.getElementById('guestPlayBtn').disabled = true;
                
                // „É≠„Ç∞„Ç§„É≥„ÅãÊñ∞Ë¶èÁôªÈå≤„Åã„Åß„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂ§â„Åà„Çã
                if (result.isLogin) {
                    showNotification('„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑÔºÅ‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„Éó„É¨„Ç§„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
                } else {
                    showNotification('ÁôªÈå≤ÂÆå‰∫ÜÔºÅ‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„Éó„É¨„Ç§„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
                }
            });

            document.getElementById('guestPlayBtn').addEventListener('click', () => {
                GameState.username = 'GUEST';
                GameState.isRegistered = false;
                GameState.deviceId = DeviceAuth.getDeviceId();
                audio.playClick();
                
                // „Ç≤„Çπ„Éà„Å®„Åó„Å¶Ë®≠ÂÆö„Åó„Åü„Åì„Å®„ÇíË¶ñË¶öÁöÑ„Å´Ë°®Á§∫
                document.getElementById('usernameInput').value = 'GUEST';
                document.getElementById('usernameInput').disabled = true;
                document.getElementById('guestPlayBtn').textContent = '‚úì „Ç≤„Çπ„Éà„É¢„Éº„Éâ';
                document.getElementById('guestPlayBtn').disabled = true;
                // ÁôªÈå≤„Éú„Çø„É≥„ÅØÊäº„Åõ„Çã„Åæ„Åæ„Å´„Åô„ÇãÔºàÊäº„Åô„Å®ÂÖ•Âäõ„É¢„Éº„Éâ„Å´Êàª„ÇãÔºâ
                document.getElementById('registerPlayBtn').disabled = false;
                document.getElementById('registerPlayBtn').textContent = '„Ç≠„É£„É≥„Çª„É´„Åó„Å¶ÁôªÈå≤„Åô„Çã';
                
                showNotification('„Ç≤„Çπ„Éà„É¢„Éº„Éâ„ÅßÈñãÂßã„ÄÇ‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„Éó„É¨„Ç§„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info');
                
                // Áõ¥Êé•CPUÂØæÊà¶Ë®≠ÂÆöÁîªÈù¢„Å∏
                showScreen('soloSetupScreen');
            });

            document.getElementById('localPlayBtn').addEventListener('click', () => {
                // „É¶„Éº„Ç∂„ÉºÁôªÈå≤„ÉÅ„Çß„ÉÉ„ÇØ
                if (!GameState.username || !GameState.isRegistered) {
                    showNotification('„Éû„É´„ÉÅ„Éó„É¨„Ç§„Å´„ÅØÁôªÈå≤„ÅåÂøÖË¶Å„Åß„Åô', 'warning');
                    audio.playWarning();
                    return;
                }
                showModal('multiSetupModal');
                audio.playClick();
            });

            document.getElementById('rulesBtn').addEventListener('click', () => {
                showModal('rulesModal');
                audio.playClick();
            });

            document.getElementById('rankingBtn').addEventListener('click', () => {
                renderRankings();
                showModal('rankingModal');
                audio.playClick();
            });

            // Ranking tabs
            document.querySelectorAll('.ranking-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.ranking-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabType = tab.dataset.tab;
                    document.getElementById('soloRankingList').style.display = tabType === 'solo' ? 'block' : 'none';
                    document.getElementById('multiRankingList').style.display = tabType === 'multi' ? 'block' : 'none';
                    audio.playClick();
                });
            });

            // Multiplayer setup
            document.getElementById('closeMultiSetupBtn').addEventListener('click', () => {
                hideModal('multiSetupModal');
                audio.playClick();
            });

            document.getElementById('cancelMultiBtn').addEventListener('click', () => {
                hideModal('multiSetupModal');
                audio.playClick();
            });

            document.querySelectorAll('[data-multiwin]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-multiwin]').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.winLength = parseInt(btn.dataset.multiwin);
                    audio.playClick();
                });
            });
            
            document.querySelectorAll('[data-multitimer]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-multitimer]').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.multiTimerSetting = btn.dataset.multitimer;
                    audio.playClick();
                });
            });

            document.getElementById('joinRoomBtn').addEventListener('click', async () => {
                const roomId = document.getElementById('roomIdInput').value.trim();
                if (!roomId) {
                    showNotification('„É´„Éº„É†ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
                    return;
                }
                
                hideModal('multiSetupModal');
                showNotification('„É´„Éº„É†„Å´Êé•Á∂ö‰∏≠...', 'info');
                
                const result = await SyncLayer.connect(roomId);
                if (result.success) {
                    if (result.spectator) {
                        // Ë¶≥Êà¶ËÄÖ„Å®„Åó„Å¶ÂæÖÊ©ü
                        showNotification('„Ç≤„Éº„É†ÈÄ≤Ë°å‰∏≠„Åß„Åô„ÄÇ„Ç≤„Éº„É†ÁµÇ‰∫Ü„Åæ„ÅßÂæÖÊ©ü„Åó„Åæ„Åô...', 'info');
                        showModal('spectatorWaitingModal');
                        
                        // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÇíÁõ£Ë¶ñ
                        const watchStatus = database.ref('rooms/' + roomId + '/status').on('value', async (snapshot) => {
                            const status = snapshot.val();
                            if (status === 'waiting' || status === 'ended') {
                                // „Ç≤„Éº„É†ÁµÇ‰∫Ü - „Éó„É¨„Ç§„É§„Éº„Å®„Åó„Å¶ÂèÇÂä†
                                database.ref('rooms/' + roomId + '/status').off('value', watchStatus);
                                
                                // Ë¶≥Êà¶ËÄÖ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
                                const myName = GameState.username || 'GUEST';
                                await database.ref('rooms/' + roomId + '/spectators/' + myName).remove();
                                
                                // „Éó„É¨„Ç§„É§„Éº„Å®„Åó„Å¶ÂèÇÂä†
                                const playersSnapshot = await database.ref('rooms/' + roomId + '/players').once('value');
                                const players = playersSnapshot.val() || [];
                                
                                let slotIndex = players.findIndex(p => !p || !p.online);
                                if (slotIndex === -1) slotIndex = players.length;
                                
                                SyncLayer.playerIndex = slotIndex;
                                players[slotIndex] = {
                                    name: myName,
                                    index: slotIndex,
                                    online: true
                                };
                                
                                await database.ref('rooms/' + roomId + '/players').set(players);
                                SyncLayer.roomRef.child('players/' + slotIndex + '/online').onDisconnect().set(false);
                                SyncLayer.setupListeners();
                                
                                hideModal('spectatorWaitingModal');
                                document.getElementById('waitingRoomId').textContent = roomId;
                                showModal('multiWaitingModal');
                                setupMultiplayerListeners();
                                showNotification('„Ç≤„Éº„É†„Å´ÂèÇÂä†„Åó„Åæ„Åó„ÅüÔºÅ', 'info');
                                audio.playClick();
                            }
                        });
                    } else if (result.pending) {
                        // ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°Ê∏à„Åø - ÊâøË™çÂæÖ„Å°
                        showNotification('ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„Éõ„Çπ„Éà„ÅÆÊâøË™ç„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...', 'info');
                        
                        // ÊâøË™ç„Åï„Çå„Åü„Åã„Å©„ÅÜ„Åã„ÇíÁõ£Ë¶ñ
                        const checkAccepted = database.ref('rooms/' + roomId + '/players').on('value', async (snapshot) => {
                            const players = snapshot.val() || [];
                            const myName = GameState.username || 'GUEST';
                            const myPlayer = players.find(p => p && p.name === myName && p.online);
                            
                            if (myPlayer) {
                                // ÊâøË™ç„Åï„Çå„Åü
                                database.ref('rooms/' + roomId + '/players').off('value', checkAccepted);
                                SyncLayer.playerIndex = myPlayer.index;
                                SyncLayer.roomRef.child('players/' + myPlayer.index + '/online').onDisconnect().set(false);
                                SyncLayer.setupListeners();
                                
                                document.getElementById('waitingRoomId').textContent = roomId;
                                showModal('multiWaitingModal');
                                setupMultiplayerListeners();
                                showNotification('ÂèÇÂä†„ÅåÊâøË™ç„Åï„Çå„Åæ„Åó„ÅüÔºÅ', 'info');
                                audio.playClick();
                            }
                        });
                        
                        // ÊãíÂê¶„Åï„Çå„ÅüÂ†¥ÂêàÔºàpendingPlayer„Åånull„Å´„Å™„Å£„ÅüÔºâ„ÇíÁõ£Ë¶ñ
                        const checkRejected = database.ref('rooms/' + roomId + '/pendingPlayer').on('value', (snapshot) => {
                            const pending = snapshot.val();
                            if (pending === null) {
                                database.ref('rooms/' + roomId + '/pendingPlayer').off('value', checkRejected);
                                // „Åæ„Å†ÊâøË™ç„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÊãíÂê¶„Åï„Çå„Åü
                                if (SyncLayer.playerIndex === -1) {
                                    database.ref('rooms/' + roomId + '/players').off('value', checkAccepted);
                                    showNotification('ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü', 'warning');
                                    audio.playWarning();
                                }
                            }
                        });
                    } else {
                        // ÈÄöÂ∏∏„ÅÆÂèÇÂä† - ÂÜçÊà¶ÂæÖÊ©ü‰∏≠„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                        const roomSnapshot = await database.ref('rooms/' + roomId).once('value');
                        const roomData = roomSnapshot.val();
                        
                        if (roomData && roomData.rematchReady) {
                            // ÂÜçÊà¶ÂæÖÊ©ü‰∏≠„ÅÆ„É´„Éº„É†„Å´ÂèÇÂä† ‚Üí ÂÜçÊà¶ÂæÖÊ©ü„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                            document.getElementById('rematchRoomId').textContent = roomId;
                            showModal('rematchWaitingModal');
                            setupMultiplayerListeners();
                            updateRematchPlayerStatus();
                            audio.playClick();
                        } else {
                            // ÈÄöÂ∏∏„ÅÆÂæÖÊ©üÁîªÈù¢
                            document.getElementById('waitingRoomId').textContent = roomId;
                            showModal('multiWaitingModal');
                            setupMultiplayerListeners();
                            audio.playClick();
                        }
                    }
                } else {
                    showNotification(result.error || 'Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'warning');
                    audio.playWarning();
                }
            });

            document.getElementById('leaveRoomBtn').addEventListener('click', () => {
                SyncLayer.disconnect();
                hideModal('multiWaitingModal');
                showNotification('„É´„Éº„É†„Åã„ÇâÈÄÄÂá∫„Åó„Åæ„Åó„Åü', 'info');
                audio.playClick();
            });

            document.getElementById('startMultiGameBtn').addEventListener('click', async () => {
                // „Éõ„Çπ„Éà„ÅÆ„ÅøÈñãÂßãÂèØËÉΩ
                const isHost = await SyncLayer.isHost();
                if (!isHost) {
                    showNotification('„Éõ„Çπ„Éà„ÅÆ„Åø„Åå„Ç≤„Éº„É†„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô', 'info');
                    return;
                }
                hideModal('multiWaitingModal');
                await SyncLayer.startGame({ 
                    winLength: GameState.winLength,
                    timer: GameState.multiTimerSetting
                });
                // „Ç≤„Éº„É†ÈñãÂßã„ÅØonStatusChange„ÅßÂá¶ÁêÜ„Åï„Çå„Çã
            });

            // Player left modal
            document.getElementById('continueGameBtn').addEventListener('click', () => {
                hideModal('playerLeftModal');
                audio.playClick();
            });

            document.getElementById('endGameAfterLeaveBtn').addEventListener('click', () => {
                hideModal('playerLeftModal');
                SyncLayer.disconnect();
                returnToTitle();
                audio.playClick();
            });
            
            // Alone in room modal
            document.getElementById('aloneOkBtn').addEventListener('click', () => {
                hideModal('aloneInRoomModal');
                SyncLayer.disconnect();
                returnToTitle();
                audio.playClick();
            });
            
            // New player waiting modal (ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà)
            document.getElementById('acceptPlayerBtn').addEventListener('click', async () => {
                hideModal('newPlayerWaitingModal');
                await SyncLayer.acceptPendingPlayer();
                audio.playClick();
            });
            
            document.getElementById('rejectPlayerBtn').addEventListener('click', async () => {
                hideModal('newPlayerWaitingModal');
                await SyncLayer.rejectPendingPlayer();
                audio.playClick();
            });
            
            // „Ç≤„Éº„É†‰∏≠ÈÄÄÂ∏≠„É¢„Éº„ÉÄ„É´
            document.getElementById('continueGameDuringBtn').addEventListener('click', () => {
                hideModal('playerLeftDuringGameModal');
                // „Éó„É¨„Ç§„É§„Éº„É™„Çπ„Éà„ÇíÊõ¥Êñ∞„Åó„Å¶Á∂öË°å
                refreshPlayersAndContinue();
                audio.playClick();
            });
            
            document.getElementById('endGameDuringBtn').addEventListener('click', () => {
                hideModal('playerLeftDuringGameModal');
                GameState.gameActive = false;
                stopTimer();
                SyncLayer.disconnect();
                returnToTitle();
                audio.playClick();
            });
            
            // Ë¶≥Êà¶ËÄÖÂæÖÊ©ü„Ç≠„É£„É≥„Çª„É´
            document.getElementById('cancelSpectatorBtn').addEventListener('click', () => {
                hideModal('spectatorWaitingModal');
                SyncLayer.disconnect();
                showNotification('ÂæÖÊ©ü„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü', 'info');
                audio.playClick();
            });
            
            // ÂÜçÊà¶„É¢„Éº„ÉÄ„É´ - „Ç≤„Éº„É†ÈñãÂßã„Éú„Çø„É≥Ôºà„Éõ„Çπ„Éà„ÅÆ„ÅøÔºâ
            document.getElementById('rematchStartBtn').addEventListener('click', async () => {
                await SyncLayer.startRematch();
                hideModal('rematchWaitingModal');
                audio.playClick();
            });
            
            document.getElementById('rematchCancelBtn').addEventListener('click', async () => {
                hideModal('rematchWaitingModal');
                await SyncLayer.cancelRematchReady();
                SyncLayer.disconnect();
                returnToTitle();
                audio.playClick();
            });

            // Modal close buttons
            document.getElementById('closeRulesBtn').addEventListener('click', () => {
                hideModal('rulesModal');
                audio.playClick();
            });

            document.getElementById('closeRankingBtn').addEventListener('click', () => {
                hideModal('rankingModal');
                audio.playClick();
            });

            // Solo setup
            document.querySelectorAll('.cpu-level').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.cpu-level').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.cpuLevel = btn.dataset.level;
                    audio.playClick();
                });
            });

            document.getElementById('startSoloBtn').addEventListener('click', () => {
                GameState.gameMode = 'solo';
                GameState.boardSize = GameState.winLength + 3; // „Éú„Éº„Éâ„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
                GameState.players = [
                    { name: GameState.username || 'PLAYER 1' },
                    { name: 'CPU' }
                ];
                startGame();
            });

            document.getElementById('backFromSoloBtn').addEventListener('click', () => {
                showScreen('titleScreen');
                audio.playClick();
            });

            // Local setup
            document.getElementById('startLocalBtn').addEventListener('click', () => {
                GameState.gameMode = 'local';
                GameState.boardSize = GameState.winLength + 3; // „Éú„Éº„Éâ„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
                GameState.players = [];
                for (let i = 0; i < GameState.playerCount; i++) {
                    GameState.players.push({ name: `PLAYER ${i + 1}` });
                }
                startGame();
            });

            document.getElementById('backFromLocalBtn').addEventListener('click', () => {
                showScreen('titleScreen');
                audio.playClick();
            });

            // Select options (win length, timer, player count)
            document.querySelectorAll('#soloSetupScreen .select-option[data-win], #localSetupScreen .select-option[data-win]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.parentElement.querySelectorAll('.select-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.winLength = parseInt(btn.dataset.win);
                    audio.playClick();
                });
            });

            document.querySelectorAll('.select-option[data-timer]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.parentElement.querySelectorAll('.select-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.timerSetting = parseInt(btn.dataset.timer);
                    audio.playClick();
                });
            });

            document.querySelectorAll('.select-option[data-players]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.parentElement.querySelectorAll('.select-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.playerCount = parseInt(btn.dataset.players);
                    audio.playClick();
                });
            });

            // Game over buttons
            document.getElementById('rematchBtn').addEventListener('click', rematch);
            document.getElementById('returnTitleBtn').addEventListener('click', returnToTitle);

            // Hover sounds for buttons
            document.querySelectorAll('.btn, .select-option, .cpu-level').forEach(btn => {
                btn.addEventListener('mouseenter', () => audio.playHover());
            });
        }

        // ==================== MULTIPLAYER LISTENERS ====================
        function setupMultiplayerListeners() {
            // „Éó„É¨„Ç§„É§„ÉºÊõ¥Êñ∞
            SyncLayer.onPlayersUpdate(async (players) => {
                updateWaitingPlayersList(players);
                
                // „É´„Éº„É†ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„É´„Éº„É´Ë°®Á§∫„ÇíÊõ¥Êñ∞
                const roomSnapshot = await database.ref('rooms/' + SyncLayer.roomId).once('value');
                const roomData = roomSnapshot.val();
                if (roomData) {
                    document.getElementById('roomWinLength').textContent = roomData.winLength || 4;
                    const timerSetting = roomData.timerSetting || 'none';
                    document.getElementById('roomTimerSetting').textContent = 
                        timerSetting === 'none' ? '„Å™„Åó' : timerSetting + 'Áßí';
                }
                
                // 2‰∫∫‰ª•‰∏ä„Åß„Çπ„Çø„Éº„Éà„Éú„Çø„É≥Ë°®Á§∫Ôºà„Éõ„Çπ„Éà„ÅÆ„ÅøÈñãÂßãÂèØËÉΩÔºâ
                const onlinePlayers = players.filter(p => p && p.online);
                const startBtn = document.getElementById('startMultiGameBtn');
                
                // „Éõ„Çπ„Éà„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö
                const isHost = await SyncLayer.isHost();
                
                // 2‰∫∫‰ª•‰∏äÊèÉ„Å£„Åü„Çâ„Éõ„Çπ„Éà„Å´„Éú„Çø„É≥Ë°®Á§∫
                if (onlinePlayers.length >= 2) {
                    if (isHost) {
                        startBtn.style.display = 'block';
                        startBtn.textContent = '„Ç≤„Éº„É†ÈñãÂßã';
                        startBtn.disabled = false;
                    } else {
                        startBtn.style.display = 'block';
                        startBtn.textContent = '„Éõ„Çπ„Éà„ÅÆÈñãÂßã„ÇíÂæÖÊ©ü‰∏≠...';
                        startBtn.disabled = true;
                    }
                } else {
                    startBtn.style.display = 'none';
                }
            });
            
            // „Ç≤„Éº„É†Áä∂ÊÖãÂ§âÂåñ
            SyncLayer.onStatusChange(async (status) => {
                if (status === 'roulette') {
                    // „É´„Éº„É¨„ÉÉ„ÉàË°®Á§∫
                    hideModal('multiWaitingModal');
                    hideModal('spectatorWaitingModal');
                    hideModal('rematchWaitingModal');
                    await showRoulette();
                } else if (status === 'playing') {
                    // „É´„Éº„É¨„ÉÉ„ÉàÂæå„Å´„Ç≤„Éº„É†ÈñãÂßã
                    hideModal('rouletteModal');
                    hideModal('spectatorWaitingModal');
                    hideModal('rematchWaitingModal');
                    startMultiplayerGame();
                } else if (status === 'ended') {
                    // „Ç≤„Éº„É†ÁµÇ‰∫ÜÂá¶ÁêÜ
                } else if (status === 'waiting') {
                    // ÂæÖÊ©üÁä∂ÊÖã„Å´Êàª„Å£„ÅüÔºàÂÜçÊà¶Ê∫ñÂÇôÔºâ
                    hideModal('spectatorWaitingModal');
                }
            });
            
            // Êâã„ÅÆÂèó‰ø°
            SyncLayer.onMove((move) => {
                if (GameState.gameActive && GameState.gameMode === 'multi') {
                    // „Éú„Éº„ÉâÊõ¥Êñ∞„ÅØonBoardUpdate„ÅßÂá¶ÁêÜ
                }
            });
            
            // „Éú„Éº„ÉâÊõ¥Êñ∞
            SyncLayer.onBoardUpdate((board) => {
                if (GameState.gameActive && GameState.gameMode === 'multi') {
                    // Firebase„Åã„ÇâÂèó„ÅëÂèñ„Å£„Åü„Éá„Éº„Çø„Çí2Ê¨°ÂÖÉÈÖçÂàó„Å´Â§âÊèõ
                    const convertedBoard = convertFirebaseBoard(board);
                    
                    if (convertedBoard && convertedBoard.length === GameState.boardSize) {
                        GameState.board = convertedBoard;
                        renderBoard();
                        // ÂãùÊïó„ÉÅ„Çß„ÉÉ„ÇØ„ÅØÈÖçÁΩÆ„Åó„ÅüÂÅ¥„ÅßË°å„ÅÜ„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØË°å„Çè„Å™„ÅÑ
                    }
                }
            });
            
            // „Çø„Éº„É≥Â§âÂåñ
            SyncLayer.onTurnChange((currentPlayer) => {
                if (GameState.gameActive && GameState.gameMode === 'multi') {
                    GameState.currentPlayer = currentPlayer;
                    GameState.isPlacing = false; // ÈÖçÁΩÆ‰∏≠„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                    updateTurnDisplay();
                    resetTimer();
                    renderBoard(); // „Éú„Éº„Éâ„ÇíÂÜçÊèèÁîªÔºàÊúâÂäπ„Å™Êâã„ÇíÊõ¥Êñ∞Ôºâ
                    audio.playTurnChange();
                    
                    console.log('„Çø„Éº„É≥Â§âÊõ¥Âèó‰ø°:', currentPlayer, 'Ëá™ÂàÜ:', SyncLayer.playerIndex);
                }
            });
            
            // „Ç≤„Éº„É†ÁµÇ‰∫ÜÔºàÂãùÊïóÔºâ
            SyncLayer.onGameEnd((winner, winCells) => {
                if (GameState.gameActive && GameState.gameMode === 'multi') {
                    if (winner === -1) {
                        // Âºï„ÅçÂàÜ„Åë
                        endGame(null, true);
                    } else {
                        // ÂãùËÄÖ„ÅÇ„Çä - ÂãùÂà©„Çª„É´ÊÉÖÂ†±„ÇíÊ∏°„Åô
                        const cells = winCells || [];
                        endGame({ player: winner, cells: cells });
                    }
                }
            });
            
            // „Éó„É¨„Ç§„É§„ÉºÈÄÄÂ∏≠
            SyncLayer.onPlayerLeave(async (player, index) => {
                // „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„ÉºÊï∞„ÇíÁ¢∫Ë™ç
                const onlineCount = await SyncLayer.getOnlinePlayerCount();
                
                // „Éõ„Çπ„ÉàÁ∂ôÊâø„ÉÅ„Çß„ÉÉ„ÇØÔºà„Å©„ÅÆÁä∂ÊÖã„Åß„ÇÇÂÆüË°åÔºâ
                const snapshot = await database.ref('rooms/' + SyncLayer.roomId + '/players').once('value');
                const players = snapshot.val() || [];
                const onlinePlayers = players
                    .map((p, i) => ({ ...p, originalIndex: i }))
                    .filter(p => p && p.online);
                
                if (onlinePlayers.length > 0) {
                    const newHost = onlinePlayers.reduce((min, p) => 
                        p.originalIndex < min.originalIndex ? p : min
                    );
                    
                    if (newHost.originalIndex === SyncLayer.playerIndex) {
                        showNotification('„ÅÇ„Å™„Åü„ÅåÊñ∞„Åó„ÅÑ„Éõ„Çπ„Éà„Å´„Å™„Çä„Åæ„Åó„Åü', 'info');
                    }
                }
                
                if (GameState.gameActive) {
                    // „Ç≤„Éº„É†‰∏≠„ÅÆÈÄÄÂ∏≠
                    if (onlineCount < 2) {
                        // 1‰∫∫„Å´„Å™„Å£„ÅüÂ†¥Âêà - „Ç≤„Éº„É†ÁµÇ‰∫Ü„Åó„Å¶„Çø„Ç§„Éà„É´„Å∏
                        GameState.gameActive = false;
                        stopTimer();
                        document.getElementById('gameOverOverlay').classList.remove('active');
                        showModal('aloneInRoomModal');
                    } else {
                        // 2‰∫∫‰ª•‰∏äÊÆã„Å£„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºà3‰∫∫‚Üí2‰∫∫Ôºâ- Á∂öË°å„Åô„Çã„ÅãÁ¢∫Ë™ç
                        document.getElementById('playerLeftDuringGameMessage').textContent = 
                            `${player.name}„Åï„Çì„ÅåÈÄÄÂ∏≠„Åó„Åæ„Åó„Åü`;
                        showModal('playerLeftDuringGameModal');
                    }
                } else {
                    // ÂæÖÊ©ü‰∏≠„ÅÆÈÄÄÂ∏≠
                    if (onlineCount < 2) {
                        // 1‰∫∫„Å´„Å™„Å£„ÅüÂ†¥Âêà
                        showModal('aloneInRoomModal');
                    } else {
                        // 2‰∫∫‰ª•‰∏äÊÆã„Å£„Å¶„ÅÑ„Çã - ÈÄöÁü•„ÅÆ„Åø
                        document.getElementById('playerLeftMessage').textContent = 
                            `${player.name}„Åï„Çì„ÅåÈÄÄÂ∏≠„Åó„Åæ„Åó„Åü`;
                        showModal('playerLeftModal');
                    }
                }
                audio.playWarning();
            });
            
            // ÂèÇÂä†„É™„ÇØ„Ç®„Çπ„ÉàÔºà„Éõ„Çπ„Éà„ÅÆ„ÅøÂá¶ÁêÜÔºâ
            SyncLayer.onPendingPlayer(async (pending) => {
                // „Éõ„Çπ„Éà„ÅÆ„ÅøÂèÇÂä†„É™„ÇØ„Ç®„Çπ„Éà„ÇíÂá¶ÁêÜ
                const isHost = await SyncLayer.isHost();
                if (isHost && pending && pending.name) {
                    // „Ç≤„Éº„É†ÁµÇ‰∫ÜÂæå„ÅÆÂæÖÊ©ü‰∏≠„ÅÆ„ÅøË°®Á§∫
                    if (!GameState.gameActive) {
                        document.getElementById('newPlayerName').textContent = pending.name;
                        showModal('newPlayerWaitingModal');
                        audio.playClick();
                    }
                }
            });
            
            // ÂÜçÊà¶Ê∫ñÂÇôÁä∂ÊÖãÊõ¥Êñ∞
            SyncLayer.onRematchUpdate(async (rematchReady) => {
                // ÂÜçÊà¶„É¢„Éº„ÉÄ„É´„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                if (document.getElementById('rematchWaitingModal').classList.contains('active')) {
                    // „Åæ„Åö„É´„Éº„É†„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁ¢∫Ë™ç
                    const snapshot = await database.ref('rooms/' + SyncLayer.roomId).once('value');
                    const roomData = snapshot.val();
                    if (!roomData) return;
                    
                    // „Ç≤„Éº„É†ÈñãÂßã‰∏≠Ôºàroulette„Åæ„Åü„ÅØplayingÔºâ„Å™„Çâ„ÉÅ„Çß„ÉÉ„ÇØ‰∏çË¶Å
                    if (roomData.status === 'roulette' || roomData.status === 'playing') {
                        console.log('„Ç≤„Éº„É†ÈñãÂßã‰∏≠„ÅÆ„Åü„ÇÅÂÜçÊà¶„ÉÅ„Çß„ÉÉ„ÇØ„Çí„Çπ„Ç≠„ÉÉ„Éó');
                        return;
                    }
                    
                    updateRematchPlayerStatus();
                    
                    const players = roomData.players || [];
                    const ready = rematchReady || {};
                    
                    // ÊñáÂ≠óÂàó„Ç≠„Éº„Å®Êï∞ÂÄ§„Ç≠„Éº„ÅÆ‰∏°Êñπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    let readyCount = 0;
                    players.forEach((p, i) => {
                        if (p && p.online && (ready[i] === true || ready[String(i)] === true)) {
                            readyCount++;
                        }
                    });
                    
                    if (readyCount < 1) {
                        // Ëá™ÂàÜ‰ª•Â§ñÂÖ®Âì°Èõ¢ËÑ±„Åó„ÅüÂ†¥Âêà - Âº∑Âà∂ÈÄÄÂá∫
                        hideModal('rematchWaitingModal');
                        showModal('aloneInRoomModal');
                    }
                }
            });
        }

        function updateWaitingPlayersList(players) {
            const container = document.getElementById('waitingPlayersList');
            container.innerHTML = '';
            
            players.forEach((player, index) => {
                // „Ç™„Éï„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„ÅØË°®Á§∫„Åó„Å™„ÅÑ
                if (!player || !player.online) return;
                
                const div = document.createElement('div');
                div.className = 'waiting-player';
                div.innerHTML = `
                    <span class="player-index">P${index + 1}</span>
                    <span class="player-name">${player.name}</span>
                `;
                container.appendChild(div);
            });
        }
        
        // „Ç≤„Éº„É†‰∏≠„Å´„Éó„É¨„Ç§„É§„Éº„ÅåÈõ¢ËÑ±„Åó„ÅüÂæå„ÄÅÁ∂öË°å„Åô„Çã
        async function refreshPlayersAndContinue() {
            // Firebase„Åã„Çâ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíÂÜçÂèñÂæó
            const snapshot = await database.ref('rooms/' + SyncLayer.roomId + '/players').once('value');
            const players = snapshot.val() || [];
            
            // „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„ÅÆ„ÅøÂèñÂæó
            GameState.players = [];
            players.forEach((p, originalIndex) => {
                if (p && p.online) {
                    GameState.players.push({
                        name: p.name,
                        originalIndex: originalIndex
                    });
                }
            });
            
            // „Çø„Éº„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateTurnDisplay();
            updatePlayerTags();
            
            showNotification('„Ç≤„Éº„É†„ÇíÁ∂öË°å„Åó„Åæ„Åô', 'info');
        }

        // „É´„Éº„É¨„ÉÉ„ÉàË°®Á§∫
        async function showRoulette() {
            showModal('rouletteModal');
            
            // Firebase„Åã„Çâ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
            const snapshot = await database.ref('rooms/' + SyncLayer.roomId + '/players').once('value');
            const players = snapshot.val() || [];
            const onlinePlayers = players.filter(p => p && p.online);
            
            // currentPlayer„ÇíÂèñÂæó
            const roomSnapshot = await database.ref('rooms/' + SyncLayer.roomId).once('value');
            const roomData = roomSnapshot.val();
            const selectedIndex = roomData.currentPlayer;
            const selectedPlayer = players[selectedIndex];
            
            const spinner = document.getElementById('rouletteSpinner');
            const result = document.getElementById('rouletteResult');
            
            // „É´„Éº„É¨„ÉÉ„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            let count = 0;
            const maxCount = 20;
            const interval = setInterval(() => {
                const randomPlayer = onlinePlayers[Math.floor(Math.random() * onlinePlayers.length)];
                spinner.textContent = randomPlayer ? randomPlayer.name : '???';
                spinner.style.color = ['var(--neon-cyan)', 'var(--neon-pink)', 'var(--neon-yellow)'][count % 3];
                count++;
                
                if (count >= maxCount) {
                    clearInterval(interval);
                    // ÊúÄÁµÇÁµêÊûú„ÇíË°®Á§∫
                    spinner.textContent = selectedPlayer ? selectedPlayer.name : '???';
                    spinner.style.color = 'var(--neon-green)';
                    result.style.display = 'block';
                    result.textContent = `${selectedPlayer ? selectedPlayer.name : '???'}„Åï„Çì„ÅåÂÖàÊîª„Åß„ÅôÔºÅ`;
                    audio.playWin();
                }
            }, 100);
        }

        async function startMultiplayerGame() {
            GameState.gameMode = 'multi';
            
            // Firebase„Åã„Çâ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
            const snapshot = await database.ref('rooms/' + SyncLayer.roomId + '/players').once('value');
            const players = snapshot.val() || [];
            
            // „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº„ÅÆ„ÅøÂèñÂæóÔºàÂÖÉ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí‰øùÊåÅÔºâ
            GameState.players = [];
            players.forEach((p, originalIndex) => {
                if (p && p.online) {
                    GameState.players.push({
                        name: p.name,
                        originalIndex: originalIndex
                    });
                }
            });
            
            // „Ç≤„Éº„É†Ë®≠ÂÆö„ÇíÂèñÂæó
            const settingsSnapshot = await database.ref('rooms/' + SyncLayer.roomId).once('value');
            const roomData = settingsSnapshot.val();
            if (roomData) {
                GameState.winLength = roomData.winLength || 4;
                GameState.boardSize = roomData.boardSize || (GameState.winLength + 3);
                GameState.currentPlayer = roomData.currentPlayer || 0;
                
                // „Çø„Ç§„Éû„ÉºË®≠ÂÆö„ÇíÈÅ©Áî®
                const timerSetting = roomData.timerSetting || 'none';
                if (timerSetting === 'none') {
                    GameState.timerSetting = 0;
                } else {
                    GameState.timerSetting = parseInt(timerSetting);
                }
                
                // Firebase„ÅÆ„Éú„Éº„Éâ„ÇíÂ§âÊèõ„Åó„Å¶‰ΩøÁî®
                const convertedBoard = convertFirebaseBoard(roomData.board);
                if (convertedBoard && convertedBoard.length === GameState.boardSize) {
                    GameState.board = convertedBoard;
                } else {
                    // „Éú„Éº„Éâ„ÇíÊñ∞Ë¶èÂàùÊúüÂåñ
                    GameState.board = [];
                    for (let y = 0; y < GameState.boardSize; y++) {
                        GameState.board.push(new Array(GameState.boardSize).fill(null));
                    }
                }
            } else {
                GameState.boardSize = GameState.winLength + 3;
                GameState.timerSetting = 0;
                // „Éú„Éº„Éâ„ÇíÊñ∞Ë¶èÂàùÊúüÂåñ
                GameState.board = [];
                for (let y = 0; y < GameState.boardSize; y++) {
                    GameState.board.push(new Array(GameState.boardSize).fill(null));
                }
            }
            
            startGame();
        }

        // ==================== INITIALIZATION ====================
        function init() {
            createMatrixBackground();
            loadRankings();
            initEventListeners();
            
            // „Éá„Éê„Ç§„ÇπID„ÇíÂàùÊúüÂåñ
            GameState.deviceId = DeviceAuth.getDeviceId();
            
            // ÂâçÂõû„ÅÆ„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÇíÂæ©ÂÖÉ
            const lastUser = DeviceAuth.getLastUser();
            if (lastUser && DeviceAuth.isRegistered(lastUser)) {
                document.getElementById('usernameInput').value = lastUser;
            }
            
            // Load audio preferences
            const prefs = audio.loadPreferences();
            
            // BGM„Éú„Çø„É≥„ÅÆÂêåÊúüÔºà„Éë„Éç„É´ÂÜÖ„Å®„É¢„Éê„Ç§„É´Ôºâ
            document.getElementById('panelBgmBtn').classList.toggle('on', prefs.bgm);
            document.getElementById('mobileBgmBtn').classList.toggle('on', prefs.bgm);
            
            // Ë®ÄË™û„ÅÆÂàùÊúüÂåñ
            const savedLang = localStorage.getItem('linkedblocks_lang') || 'ja';
            document.getElementById('langJaBtn').classList.toggle('active', savedLang === 'ja');
            document.getElementById('langEnBtn').classList.toggle('active', savedLang === 'en');
            currentLang = savedLang;
            updateTexts();
            
            handleIntro();
        }

        // Handle first user interaction to enable audio
        function enableAudio() {
            audio.init();
            audio.resume();
            
            // iOS SafariÂêë„ÅëËøΩÂä†Âá¶ÁêÜ: AudioContext„ÇíÂº∑Âà∂ÁöÑ„Å´resume
            if (audio.audioContext && audio.audioContext.state !== 'running') {
                audio.audioContext.resume().then(() => {
                    console.log('AudioContext resumed');
                }).catch(e => console.log('Resume failed:', e));
            }
            
            document.removeEventListener('click', enableAudio);
            document.removeEventListener('touchstart', enableAudio);
            document.removeEventListener('touchend', enableAudio);
        }
        
        document.addEventListener('click', enableAudio);
        document.addEventListener('touchstart', enableAudio);
        document.addEventListener('touchend', enableAudio); // touchend„ÇÇËøΩÂä†

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„Å´„É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
        window.addEventListener('beforeunload', () => {
            DeviceAuth.logout();
        });
        
        // visibilitychange „Åß„ÇÇÂØæÂøúÔºà„É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                // „Éö„Éº„Ç∏„ÅåÈùûË°®Á§∫„Å´„Å™„Å£„ÅüÊôÇÔºà„Çø„ÉñÂàá„ÇäÊõø„Åà„ÄÅ„Ç¢„Éó„É™Âàá„ÇäÊõø„ÅàÁ≠âÔºâ
                // Ê≥®ÔºöÂÆåÂÖ®„Å´Èõ¢ËÑ±„Åó„Åü„Çè„Åë„Åß„ÅØ„Å™„ÅÑ„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØ„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Å™„ÅÑ
                // onDisconnect „ÅåËá™Âãï„ÅßÂá¶ÁêÜ„Åô„Çã
            }
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
